# File: manifests/078-service-protection-ingressroute.yaml.j2
#
# Description:
# Jinja2 template for generating IngressRoute configurations for protected services
# Replaces hardcoded files like 078-whoami-protected-ingressroute.yaml
# Generates IngressRoute for each service in protected_services list
#
# Template Variables (from kubernetes-secrets.yml):
# - protected_services: List of services to protect
# - domains: Dictionary of domain configurations
#
# Usage:
#   Generated by Ansible from kubernetes-secrets.yml
#   kubectl apply -f manifests/078-service-protection-ingressroute.yaml
#
# Dependencies:
# - 070-whoami-service-and-deployment.yaml (whoami service must exist)
# - 075-authentik-config.yaml (Authentik must be deployed and running)
# - 077-authentik-forward-auth-middleware.yaml (middleware must be defined)
# - Service protection blueprint must be deployed

{% for service in protected_services %}
{% if service.type == "proxy" %}
---
# {{ service.name }} protected IngressRoute (Forward Auth)
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: {{ service.name }}-protected
  namespace: default
  labels:
    app: {{ service.name }}
    type: protected
    auth_type: proxy
    routing: unified
    protection: authentik-forward-auth
spec:
  entryPoints:
    - web
  routes:
    # Unified routing for all domains using HostRegexp
    # Matches: {{ service.name }}.localhost, {{ service.name }}.dog-pence.ts.net, {{ service.name }}.urbalurba.no, etc.
    - match: HostRegexp(`{{ service.name }}\..+`)
      kind: Rule
      services:
        - name: {{ service.name }}
          port: 80
      middlewares:
        - name: authentik-forward-auth
          namespace: default

{% elif service.type == "oauth2" %}
---
# {{ service.name }} OAuth2 IngressRoute (No middleware - service handles OAuth2)
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: {{ service.name }}-oauth2
  namespace: default
  labels:
    app: {{ service.name }}
    type: protected
    auth_type: oauth2
    routing: unified
    protection: oauth2-direct
spec:
  entryPoints:
    - web
  routes:
    # Unified routing for all domains using HostRegexp
    # Matches: {{ service.name }}.localhost, {{ service.name }}.dog-pence.ts.net, {{ service.name }}.urbalurba.no, etc.
    - match: HostRegexp(`{{ service.name }}\..+`)
      kind: Rule
      services:
        - name: {{ service.name }}
          port: 80
      # No middlewares - service handles OAuth2 flow directly

  {% elif service.type == "basic" %}
---
# {{ service.name }} Basic Auth IngressRoute
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: {{ service.name }}-basic
  namespace: default
  labels:
    app: {{ service.name }}
    type: protected
    auth_type: basic
    routing: unified
    protection: basic-auth
    generated_by: auth10
spec:
  entryPoints:
    - web
  routes:
    # Unified routing for all domains using HostRegexp
    # Matches: {{ service.name }}.localhost, {{ service.name }}.dog-pence.ts.net, {{ service.name }}.urbalurba.no, etc.
    - match: HostRegexp(`{{ service.name }}\..+`)
      kind: Rule
      services:
        - name: {{ service.name }}
          port: 80
      middlewares:
        - name: basic-auth
          namespace: default
  {% endif %}
{% endfor %}

