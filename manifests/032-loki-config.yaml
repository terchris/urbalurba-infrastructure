# File: manifests/032-loki-config.yaml
# Description: Helm values file for deploying Grafana Loki
# Usage: Referenced by ansible/playbooks/032-setup-loki.yml
# Prerequisites: Monitoring namespace must exist
#
# Features:
# - Log aggregation system with 24-hour retention
# - Single binary deployment mode for simplicity
# - Persistent volume for log storage (10Gi)
# - Structured metadata support enabled
# - TSDB schema for efficient indexing
# - HTTP API on port 3100, gRPC on port 9095

# Deployment mode - using SingleBinary for simplicity
deploymentMode: SingleBinary

# Loki configuration
loki:
  auth_enabled: false

  commonConfig:
    path_prefix: /var/loki
    replication_factor: 1

  # Compactor settings for log retention
  compactor:
    compaction_interval: 10m
    delete_request_store: filesystem
    retention_delete_delay: 2h
    retention_delete_worker_count: 150
    retention_enabled: true
    working_directory: /var/loki/compactor

  # Ingester configuration
  ingester:
    chunk_idle_period: 5m
    chunk_retain_period: 30s
    lifecycler:
      final_sleep: 0s
      ring:
        kvstore:
          store: inmemory
        replication_factor: 1
    wal:
      dir: /var/loki/wal

  # Limits and retention configuration
  limits_config:
    allow_structured_metadata: true
    ingestion_burst_size_mb: 20
    ingestion_rate_mb: 10
    max_cache_freshness_per_query: 10m
    max_line_size: 256000
    max_streams_per_user: 0
    per_stream_rate_limit: 3MB
    per_stream_rate_limit_burst: 15MB
    reject_old_samples: true
    reject_old_samples_max_age: 168h
    retention_period: 24h
    split_queries_by_interval: 15m

  # Schema configuration
  schemaConfig:
    configs:
    - from: "2024-01-01"
      index:
        period: 24h
        prefix: index_
      object_store: filesystem
      schema: v13
      store: tsdb

  # Server ports
  server:
    grpc_listen_port: 9095
    http_listen_port: 3100

  # Storage configuration
  storage:
    type: filesystem

  storage_config:
    filesystem:
      directory: /var/loki/chunks
    tsdb_shipper:
      active_index_directory: /var/loki/tsdb-index
      cache_location: /var/loki/tsdb-cache

# Single binary persistence
singleBinary:
  persistence:
    enabled: true
    size: 10Gi

# Disable unused components (using SingleBinary mode)
backend:
  replicas: 0
chunksCache:
  enabled: false
compactor:
  replicas: 0
distributor:
  replicas: 0
indexGateway:
  replicas: 0
ingester:
  replicas: 0
querier:
  replicas: 0
queryFrontend:
  replicas: 0
queryScheduler:
  replicas: 0
read:
  replicas: 0
resultsCache:
  enabled: false
ruler:
  replicas: 0
write:
  replicas: 0
