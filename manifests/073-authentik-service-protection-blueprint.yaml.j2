# File: manifests/073-authentik-service-protection-blueprint.yaml.j2
#
# Description:
# Jinja2 template for Authentik blueprint that creates providers for all protected services
# across all configured domains. Supports both proxy and OAuth2 provider types.
#
# Template Variables (from kubernetes-secrets.yml):
# - protected_services: List of services to protect
# - domains: Dictionary of domain configurations
#
# Usage:
#   Generated by Ansible from kubernetes-secrets.yml
#   kubectl apply -f manifests/073-authentik-service-protection-blueprint.yaml
#
# Prerequisites:
# - In the authentik helm values you must have the following:
# - blueprints:
#   configMaps:
#     - "service-protection-blueprint"
#
# This blueprint creates:
# 1. Proxy providers for each service-domain combination
# 2. OAuth2 providers for services that require OAuth2
# 3. Applications linked to providers
# 4. Property mappings for group/role claims

apiVersion: v1
kind: ConfigMap
metadata:
  name: service-protection-blueprint
  namespace: authentik
  labels:
    app.kubernetes.io/name: authentik
    app.kubernetes.io/component: blueprint
    blueprints.goauthentik.io/instantiate: "true"
data:
  service-protection.yaml: |
    # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
    version: 1
    metadata:
      name: "Dynamic Service Protection"
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    
    context: {}
    
    entries:
      # ================================================================
      # PROXY PROVIDERS - For services using forward auth
      # ================================================================
{% for service in protected_services %}
{% if service.type == "proxy" %}
{% for domain_type in service.domains %}
{% if domains[domain_type].enabled %}
      # {{ service.name }} {{ domain_type }} proxy provider
      - model: authentik_providers_proxy.proxyprovider
        state: present
        identifiers:
          name: {{ service.name }}-{{ domain_type }}-provider
        attrs:
          name: {{ service.name }}-{{ domain_type }}-provider
          external_host: {{ domains[domain_type].protocol }}://{{ service.name }}.{{ domains[domain_type].base_domain }}
          internal_host: http://{{ service.name }}.default.svc.cluster.local
          mode: forward_single
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          access_token_validity: hours=24

      # Create application for {{ service.name }} {{ domain_type }}
      - model: authentik_core.application
        state: present
        identifiers:
          slug: {{ service.name }}-{{ domain_type }}-app
        attrs:
          name: {{ service.name }}-{{ domain_type }}-app
          slug: {{ service.name }}-{{ domain_type }}-app
          meta_launch_url: ""
          policy_engine_mode: any
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, {{ service.name }}-{{ domain_type }}-provider]]
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}

      # ================================================================
      # OAUTH2 PROVIDERS - For services using OAuth2/OIDC
      # ================================================================
      {% for service in protected_services %}
        {% if service.type == "oauth2" %}
          {% for domain_type in service.domains %}
            {% if domains[domain_type].enabled %}
              # {{ service.name }} {{ domain_type }} OAuth2 provider
              - model: authentik_providers_oauth2.oauth2provider
                state: present
                identifiers:
                  name: {{ service.name }}-{{ domain_type }}-provider
                attrs:
                  name: {{ service.name }}-{{ domain_type }}-provider
                  client_type: confidential
                  client_id: {{ service.oauth_config.client_id }}
                  client_secret: {{ service.oauth_config.client_secret }}
                  # Redirect URIs for this domain
                  redirect_uris:
                    - matching_mode: strict
                      url: {{ domains[domain_type].protocol }}://{{ service.name }}.{{ domains[domain_type].base_domain }}{{ service.oauth_config.redirect_uri }}
                  # Token validity settings
                  access_code_validity: minutes=1
                  access_token_validity: minutes=5
                  refresh_token_validity: days=30
                  # Additional settings
                  sub_mode: hashed_user_id
                  issuer_mode: per_provider
                  include_claims_in_id_token: true
                  # Flow references
                  authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
                  invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
                  signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
                  # Property mappings
                  property_mappings:
                    - !Find [authentik_providers_oauth2.scopemapping, [name, "authentik default OAuth Mapping: OpenID 'openid'"]]
                    - !Find [authentik_providers_oauth2.scopemapping, [name, "authentik default OAuth Mapping: OpenID 'email'"]]
                    - !Find [authentik_providers_oauth2.scopemapping, [name, "authentik default OAuth Mapping: OpenID 'profile'"]]
                    - !Find [authentik_providers_oauth2.scopemapping, [name, "Service Groups Mapping"]]
                    - !Find [authentik_providers_oauth2.scopemapping, [name, "Service Roles Mapping"]]
              
              # Create application for {{ service.name }} {{ domain_type }}
              - model: authentik_core.application
                state: present
                identifiers:
                  slug: {{ service.name }}-{{ domain_type }}-app
                attrs:
                  name: {{ service.name }}-{{ domain_type }}-app
                  slug: {{ service.name }}-{{ domain_type }}-app
                  meta_launch_url: ""
                  policy_engine_mode: any
                  provider: !Find [authentik_providers_oauth2.oauth2provider, [name, {{ service.name }}-{{ domain_type }}-provider]]
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endfor %}

      # ================================================================
      # PROPERTY MAPPINGS - For group and role claims
      # ================================================================
      
      # Create property mapping to include groups in tokens
      - model: authentik_providers_oauth2.scopemapping
        state: present
        identifiers:
          name: "Service Groups Mapping"
        attrs:
          name: "Service Groups Mapping"
          scope_name: "groups"
          description: "Service groups scope mapping"
          expression: |
            return {
              "groups": [group.name for group in user.ak_groups.all()],
            }
            
      # Create property mapping for roles
      - model: authentik_providers_oauth2.scopemapping
        state: present
        identifiers:
          name: "Service Roles Mapping"
        attrs:
          name: "Service Roles Mapping"
          scope_name: "roles"
          description: "Service roles scope mapping"
          expression: |
            roles = []
            # Map groups to roles - customize this logic as needed
            user_groups = [group.name for group in user.ak_groups.all()]
            
            if "HQ" in user_groups:
                roles.append("admin")  # HQ users get admin role
            else:
                roles.append("user")   # Other users get user role
                
            return {
              "roles": roles,
            }

      # ================================================================
      # OUTPOST CONFIGURATION - Link providers to embedded outpost
      # ================================================================

      # Update embedded outpost to include all new providers
      - model: authentik_outposts.outpost
        state: present
        identifiers:
          name: "authentik Embedded Outpost"
        attrs:
          name: "authentik Embedded Outpost"
          type: proxy
          # Configuration for the embedded outpost
          # WORKAROUND for Authentik bug #5922: embedded outpost ignores authentik_host_browser
          # Set authentik_host to external URL for correct OAuth redirects
          # The embedded outpost still reaches the server locally (same pod)
          config:
            authentik_host: "{{ domains.localhost.protocol }}://authentik.{{ domains.localhost.base_domain }}"
            authentik_host_browser: "{{ domains.localhost.protocol }}://authentik.{{ domains.localhost.base_domain }}"
          # Link all proxy providers to the embedded outpost
          providers:
{% for service in protected_services %}
{% if service.type == "proxy" %}
{% for domain_type in service.domains %}
{% if domains[domain_type].enabled %}
            - !Find [authentik_providers_proxy.proxyprovider, [name, {{ service.name }}-{{ domain_type }}-provider]]
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}
