# File: manifests/079-basic-auth-middleware.yaml.j2
#
# Description:
# Jinja2 template for generating Traefik BasicAuth middleware and Kubernetes secrets
# Generates middleware and secrets for all services with type: basic
#
# Template Variables (from kubernetes-secrets.yml):
# - protected_services: List of services to protect
#
# Usage:
#   Generated by Ansible from kubernetes-secrets.yml
#   kubectl apply -f manifests/079-basic-auth-middleware.yaml
#
# Dependencies:
#   - Services with type: basic must have basic_auth.username and basic_auth.password configured
#
# Generated Resources:
#   - Kubernetes Secret for each basic auth service
#   - Traefik BasicAuth Middleware for each basic auth service

{% for service in protected_services %}
  {% if service.type == "basic" %}
---
# {{ service.name }} Basic Auth Secret
apiVersion: v1
kind: Secret
metadata:
  name: basic-auth
  namespace: default
  labels:
    app: {{ service.name }}
    type: basic-auth
    generated_by: auth10
type: Opaque
data:
  users: {{ service.basic_auth.username }}:{{ service.basic_auth.password | b64encode }}

---
# {{ service.name }} Basic Auth Middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: basic-auth
  namespace: default
  labels:
    app: {{ service.name }}
    type: basic-auth
    generated_by: auth10
spec:
  basicAuth:
    secret: basic-auth
  {% endif %}
{% endfor %}
