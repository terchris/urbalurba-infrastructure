# File: manifests/075-authentik-config.yaml.j2
#
# Description:
# Jinja2 template for Authentik Helm values with dynamic service protection
# Generates CSRF trusted origins and blueprint configuration based on protected services
#
# Template Variables (from kubernetes-secrets.yml):
# - domains: Dictionary of domain configurations
# - protected_services: List of services to protect
# - All existing Authentik configuration variables
#
# Usage:
#   Generated by Ansible from kubernetes-secrets.yml
#   helm upgrade authentik authentik/authentik -n authentik -f 075-authentik-config.yaml

# Authentik Helm Chart Values
# Generated automatically by Auth10 system
authentik:
  # Secret key will be loaded from environment variables
  secret_key: ""  # Empty - loaded via global.env

  # Debugging and error reporting
  error_reporting:
    enabled: false

  # External PostgreSQL configuration
  postgresql:
    host: "postgresql.default.svc.cluster.local"
    name: authentik
    user: authentik
    port: 5432
    password: ""  # Empty - loaded via global.env

  # External Redis configuration
  redis:
    host: "redis-master.default.svc.cluster.local"
    port: 6379
    password: ""  # Empty - loaded via global.env

# CRITICAL: Environment variables for Authentik + outpost communication
global:
  envFrom:
    - secretRef:
        name: urbalurba-secrets
  env:
    # Bootstrap admin account (only used on *first startup*)
    - name: AUTHENTIK_BOOTSTRAP_EMAIL
      valueFrom:
        secretKeyRef:
          name: urbalurba-secrets
          key: AUTHENTIK_BOOTSTRAP_EMAIL
    - name: AUTHENTIK_BOOTSTRAP_PASSWORD
      valueFrom:
        secretKeyRef:
          name: urbalurba-secrets
          key: AUTHENTIK_BOOTSTRAP_PASSWORD
    # CRITICAL: Internal cluster URL for multi-domain support (localhost + external domains)
    # This MUST use the internal service URL to enable dynamic domain detection
    # When set to internal URL, Authentik detects the actual domain from X-Forwarded-Host header
    # This allows both authentik.localhost (development) and authentik.urbalurba.no (production) to work
    # DO NOT set this to a specific external domain - it will break other domains
    - name: AUTHENTIK_HOST
      value: "http://authentik-server.authentik.svc.cluster.local"

    # REMOVED: AUTHENTIK_HOST_BROWSER - DO NOT ADD BACK!
    #
    # WHY REMOVED:
    # 1. AUTHENTIK_HOST_BROWSER hardcodes a specific domain (e.g., http://authentik.localhost)
    # 2. This breaks multi-domain support - only works for one domain at a time
    # 3. When removed, Authentik auto-detects the actual domain from request headers
    # 4. This enables seamless support for both localhost AND external domains
    # 5. No hardcoded values = truly dynamic, future-proof configuration
    #
    # CONSEQUENCES OF REMOVAL:
    # ✅ Works with any domain automatically (localhost, urbalurba.no, etc.)
    # ✅ No configuration changes needed when adding new domains
    # ✅ OAuth redirects use the correct domain the user actually accessed
    # ✅ CORS and security policies work correctly with actual domains
    # ✅ Future-proof for any new domains you add
    #
    # DO NOT ADD AUTHENTIK_HOST_BROWSER BACK - IT BREAKS MULTI-DOMAIN SUPPORT!

    # Allow HTTP (⚠️ dev only — don't use in production)
    - name: AUTHENTIK_INSECURE
      value: "true"
    # Secret key for session encryption and security
    - name: AUTHENTIK_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: urbalurba-secrets
          key: AUTHENTIK_SECRET_KEY
    # PostgreSQL password
    - name: AUTHENTIK_POSTGRESQL__PASSWORD
      valueFrom:
        secretKeyRef:
          name: urbalurba-secrets
          key: AUTHENTIK_POSTGRESQL__PASSWORD
    # Redis password
    - name: AUTHENTIK_REDIS__PASSWORD
      valueFrom:
        secretKeyRef:
          name: urbalurba-secrets
          key: AUTHENTIK_REDIS__PASSWORD

    # CSRF trusted origins for external domain access
    # DYNAMICALLY GENERATED from protected_services and domains configuration
    # Allows admin UI access via all configured domains
    - name: AUTHENTIK_WEB__CSRF_TRUSTED_ORIGINS
      value: |
        {% set csrf_origins = [] %}
        {% for domain_type, domain_config in domains.items() %}
          {% if domain_config.enabled %}
            {% for service in protected_services %}
              {% if domain_type in service.domains or service.domains == "auto" %}
                {% set _ = csrf_origins.append(domain_config.protocol + "://" + service.name + "." + domain_config.base_domain) %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endfor %}
        {{ csrf_origins | join(',') }}

# Blueprint system configuration with volume mounting
blueprints:
  # List of ConfigMaps containing blueprints
  # Only keys ending with .yaml will be discovered and applied
  configMaps:
    - "test-users-groups-blueprint" # test users and groups blueprint
    - "openwebui-blueprint" # openwebui blueprint
    - "app-slot1-blueprint" # app slot 1 blueprint
    - "service-protection-blueprint" # DYNAMICALLY GENERATED service protection blueprint

# Authentik server configuration with blueprint volume mounting
server:
  # Ingress configuration
  # NOTE: Ingress is now managed by separate IngressRoute (076-authentik-ingressroute.yaml)
  # This provides HostRegexp support for unified internal/external routing
  ingress:
    enabled: false  # Disabled - using separate IngressRoute for better control
    # ingressClassName: traefik  # Not needed when disabled
    # hosts:                     # Managed by IngressRoute with HostRegexp
    #   - authentik.localhost    # Pattern: authentik\..+ for multi-domain support

  # Blueprint volume configuration for automatic discovery
  volumes:
    # Mount blueprint ConfigMaps as volumes for automatic discovery
    - name: test-users-groups-blueprint
      configMap:
        name: test-users-groups-blueprint
    - name: openwebui-blueprint
      configMap:
        name: openwebui-blueprint
    - name: app-slot1-blueprint
      configMap:
        name: app-slot1-blueprint
    - name: service-protection-blueprint
      configMap:
        name: service-protection-blueprint
  volumeMounts:
    # Mount blueprints to /blueprints/ directory for discovery
    - name: test-users-groups-blueprint
      mountPath: /blueprints/test-users-groups
      readOnly: true
    - name: openwebui-blueprint
      mountPath: /blueprints/openwebui
      readOnly: true
    - name: app-slot1-blueprint
      mountPath: /blueprints/app-slot1
      readOnly: true
    - name: service-protection-blueprint
      mountPath: /blueprints/service-protection
      readOnly: true

# Worker configuration with blueprint volume mounting and metrics
worker:
  enabled: true
  # Enable metrics for better observability of background tasks
  metrics:
    enabled: true
    # Optional: Enable ServiceMonitor for Prometheus scraping
    serviceMonitor:
      enabled: false  # Set to true if using Prometheus Operator

  # Blueprint volume configuration for automatic discovery
  volumes:
    # Mount blueprint ConfigMaps as volumes for automatic discovery
    - name: test-users-groups-blueprint
      configMap:
        name: test-users-groups-blueprint
    - name: openwebui-blueprint
      configMap:
        name: openwebui-blueprint
    - name: app-slot1-blueprint
      configMap:
        name: app-slot1-blueprint
    - name: service-protection-blueprint
      configMap:
        name: service-protection-blueprint
  volumeMounts:
    # Mount blueprints to /blueprints/ directory for discovery
    - name: test-users-groups-blueprint
      mountPath: /blueprints/test-users-groups
      readOnly: true
    - name: openwebui-blueprint
      mountPath: /blueprints/openwebui
      readOnly: true
    - name: app-slot1-blueprint
      mountPath: /blueprints/app-slot1
      readOnly: true
    - name: service-protection-blueprint
      mountPath: /blueprints/service-protection
      readOnly: true

# Disable built-in Postgres/Redis (using external services)
postgresql:
  enabled: false
redis:
  enabled: false
