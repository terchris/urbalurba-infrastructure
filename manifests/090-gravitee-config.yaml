# file: /mnt/urbalurbadisk/manifests/090-gravitee-config.yaml
# description: Updated for Gravitee APIM 4.8.4 with proper UI constants configuration
#
# HOSTNAME STRATEGY:
# - api.localhost → API Gateway (for developers)
# - portal.localhost → Developer Portal  
# - gravitee.localhost → Management Console (for admins)
# - gravitee-api.localhost → Management API (for admins)

# Global settings
global:
  cluster: gravitee

# Disable bundled dependencies
mongodb-replicaset:
  enabled: false
elasticsearch:
  enabled: false

# MongoDB configuration
mongo:
  uri: mongodb://gravitee_user:SecretPassword1@mongodb.default.svc.cluster.local:27017/graviteedb?authSource=admin

# Elasticsearch configuration
es:
  endpoints:
    - http://elasticsearch-master.default.svc.cluster.local:9200
  security:
    enabled: false

# API Management API configuration  
api:
  enabled: true
  replicaCount: 1
  autoscaling:
    enabled: false
  
  # Specify 4.8.4 image explicitly
  image:
    repository: graviteeio/apim-management-api
    tag: 4.8.4-debian
    pullPolicy: Always
  
  # Configure ingress with proper hostname
  ingress:
    management:
      enabled: true
      path: /
      pathType: Prefix
      hosts:
        - gravitee-api.localhost
      annotations:
        kubernetes.io/ingress.class: "traefik"
    portal:
      enabled: true
      path: /
      pathType: Prefix  
      hosts:
        - gravitee-api.localhost
      annotations:
        kubernetes.io/ingress.class: "traefik"

# Gateway configuration
gateway:
  enabled: true
  replicaCount: 1
  autoscaling:
    enabled: false
    
  # Specify 4.8.4 image explicitly
  image:
    repository: graviteeio/apim-gateway
    tag: 4.8.4-debian
    pullPolicy: Always
    
  # Configure ingress for API access
  ingress:
    enabled: true
    path: /
    pathType: Prefix
    hosts:
      - api.localhost
    annotations:
      kubernetes.io/ingress.class: "traefik"

# Management UI configuration
ui:
  enabled: true
  replicaCount: 1
  autoscaling:
    enabled: false
    
  # Specify 4.8.4 image explicitly  
  image:
    repository: graviteeio/apim-management-ui
    tag: 4.8.4
    pullPolicy: Always
    
  # Configure ingress for admin console
  ingress:
    enabled: true
    path: /
    pathType: Prefix
    hosts:
      - gravitee.localhost
    annotations:
      kubernetes.io/ingress.class: "traefik"
  
  # Configure constants.json for proper API URLs
  constants: |
    {
      "baseURL": "http://gravitee-api.localhost/management",
      "basePortalURL": "http://gravitee-api.localhost/portal", 
      "production": false,
      "defaultPortal": "classic"
    }

# Portal UI configuration
portal:
  enabled: true
  replicaCount: 1
  autoscaling:
    enabled: false
    
  # Specify 4.8.4 image explicitly
  image:
    repository: graviteeio/apim-portal-ui
    tag: 4.8.4
    pullPolicy: Always
    
  # Configure ingress for developer portal
  ingress:
    enabled: true
    path: /
    pathType: Prefix
    hosts:
      - portal.localhost
    annotations:
      kubernetes.io/ingress.class: "traefik"
  
  # Configure constants.json for proper API URLs
  constants: |
    {
      "portalURL": "http://gravitee-api.localhost/portal"
    }

# Rate limit configuration
ratelimit:
  type: mongodb
  mongodb:
    uri: mongodb://gravitee_user:SecretPassword1@mongodb.default.svc.cluster.local:27017/graviteedb?authSource=admin

# Installation type configuration (4.2+ requirement)
installation:
  type: standalone
