# 641-adm-pgadmin.yaml
# Installs pgAdmin for administering the postgres database - uses secrets
# IMPORTANT: Apply 640-pgadmin-configmap.yaml BEFORE running this Helm chart
# Usage: helm install pgadmin runix/pgadmin4 -f 641-adm-pgadmin.yaml

# CHECK the Pod: kubectl get pods -l app.kubernetes.io/name=pgadmin4 -o wide
# CHECK Port Forwarding to localhost on port 8998: kubectl port-forward \$(kubectl get pod -l app.kubernetes.io/name=pgadmin4 -o jsonpath="{.items[0].metadata.name}") 8998:80
# CHECK Accessing pgAdmin via localhost: curl http://localhost:8998
# DEBUG Display Logs: kubectl logs -f \$(kubectl get pods -l app.kubernetes.io/name=pgadmin4 -o jsonpath="{.items[0].metadata.name}")

# REMOVE: helm uninstall pgadmin

# Main chart configuration
existingSecret: pgadmin4-password  # the existingSecret is set in 000-secrets.yaml

env:
  email: terje@businessmodel.io
  enhanced_cookie_protection: "False"

envVarsExtra:
  - name: PGPASS_FILE
    value: "/var/lib/pgadmin/pgpassfile"

persistentVolume:
  enabled: true
  size: 10Gi

# Pre-configure PostgreSQL server connection for ease of use
# PassFile enables auto-login (pgpass secret created by deploy playbook)
serverDefinitions:
  enabled: true
  resourceType: ConfigMap
  servers:
    "1":
      Name: "PostgreSQL Database"
      Group: "Servers"
      Username: "postgres"
      Host: "postgresql.default.svc.cluster.local"
      Port: 5432
      SSLMode: "prefer"
      MaintenanceDB: "postgres"
      PassFile: "/var/lib/pgadmin/pgpassfile"
      Comment: "Pre-configured PostgreSQL server connection"

# pgpass auto-login: init container copies secret with correct ownership (uid 5050)
# Kubernetes secret mounts are always owned by root, but libpq requires the pgpass
# file to be owned by the process user (pgadmin, uid 5050) with permissions 0600.
extraInitContainers: |
  - name: fix-pgpass-permissions
    image: busybox:latest
    command: ['sh', '-c', 'cp /tmp/pgpass-secret/pgpassfile /tmp/pgpass/pgpassfile && chown 5050:5050 /tmp/pgpass/pgpassfile && chmod 0600 /tmp/pgpass/pgpassfile']
    volumeMounts:
      - name: pgpass-secret
        mountPath: /tmp/pgpass-secret
        readOnly: true
      - name: pgpass-volume
        mountPath: /tmp/pgpass

extraVolumes:
  - name: pgpass-secret
    secret:
      secretName: pgadmin-pgpass
  - name: pgpass-volume
    emptyDir: {}

extraVolumeMounts:
  - name: pgpass-volume
    mountPath: /var/lib/pgadmin/pgpassfile
    subPath: pgpassfile
    readOnly: true

ingress:
  enabled: false  # Using Traefik IngressRoute instead

service:
  type: ClusterIP

# extraConfigmapMounts: # Removed - using chart defaults for root path deployment

resources:
  requests:
    memory: "256Mi"
    cpu: "100m"
  limits:
    memory: "512Mi"
    cpu: "500m"

# Custom probes for root path deployment
livenessProbe:
  httpGet:
    path: /misc/ping
    port: http
  initialDelaySeconds: 30
  timeoutSeconds: 15
  periodSeconds: 60
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /misc/ping
    port: http
  initialDelaySeconds: 30
  timeoutSeconds: 15
  periodSeconds: 60
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /misc/ping
    port: http
  initialDelaySeconds: 10
  timeoutSeconds: 5
  periodSeconds: 10
  failureThreshold: 18  # 18 * 10s = 3 minutes total

securityContext:
  runAsUser: 5050
  runAsGroup: 5050
  fsGroup: 5050

containerSecurityContext:
  allowPrivilegeEscalation: false