# File: manifests/076-authentik-ingressroute.yaml.j2
#
# Description:
# Jinja2 template for Authentik IngressRoute with dynamic domain support
# Consolidates both 076-authentik-ingressroute.yaml and 076-authentik-localhost-ingressroute.yaml
# Generates IngressRoute configuration for Authentik server across all configured domains
#
# Template Variables (from kubernetes-secrets.yml):
# - domains: Dictionary of domain configurations
#
# Usage:
#   Generated by Ansible from kubernetes-secrets.yml
#   kubectl apply -f manifests/076-authentik-ingressroute.yaml
#
# Dependencies:
# - 075-authentik-config.yaml (Authentik Helm deployment with ingress disabled)
# - 076-authentik-csp-middleware.yaml (CSP middleware for mixed content resolution)
# - Authentik service must exist in authentik namespace

---
# Main IngressRoute for external domains (with CSP middleware)
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: authentik-server
  namespace: authentik
  labels:
    app: authentik
    component: server
    type: public
    routing: unified
    app.kubernetes.io/name: authentik
    app.kubernetes.io/component: server
spec:
  entryPoints:
    - web
  routes:
    # External domains (with CSP middleware for mixed content resolution)
    - match: HostRegexp(`authentik\..+`) && !Host(`authentik.localhost`)
      kind: Rule
      services:
        - name: authentik-server
          port: 80
      middlewares:
        - name: authentik-csp-upgrade
          namespace: authentik

---
# Separate IngressRoute for localhost (without CSP middleware)
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: authentik-server-localhost
  namespace: authentik
  labels:
    app: authentik
    component: server
    type: localhost
    routing: localhost-only
    app.kubernetes.io/name: authentik
    app.kubernetes.io/component: server
spec:
  entryPoints:
    - web
  routes:
    # Localhost (without CSP middleware to avoid SSL certificate issues)
    - match: Host(`authentik.localhost`)
      kind: Rule
      services:
        - name: authentik-server
          port: 80
