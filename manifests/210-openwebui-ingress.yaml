# File: manifests/210-openwebui-ingress.yaml
#
# Description:
# Traefik IngressRoute for OpenWebUI using unified routing with HostRegexp pattern.
# Provides consistent access to OpenWebUI application across multiple domains.
# Follows cluster standards for IngressRoute configuration and multi-domain support.
# Replaces previous standard Kubernetes Ingress with Traefik IngressRoute CRD.
#
# HostRegexp Routing:
# This IngressRoute uses HostRegexp('openwebui\..+') to automatically handle:
# - openwebui.localhost (internal development access)
# - openwebui.urbalurba.no (external demo access via Cloudflare tunnel)
# - Any future domains (future-proof routing)
#
# Usage:
# kubectl apply -f 210-openwebui-ingress.yaml
#
# Dependencies:
# - 208-openwebui-config.yaml (OpenWebUI Helm deployment)
# - open-webui service must exist in ai namespace
# - Authentik authentication system for OAuth integration
#
# Testing:
# Internal: curl http://openwebui.localhost
# External: curl https://openwebui.urbalurba.no
# Both should return OpenWebUI interface (with OAuth redirect if not authenticated)
#
# Integration:
# - Routes both internal and external domains to open-webui service automatically
# - Supports OAuth integration with Authentik via consistent hostname resolution
# - Enables CoreDNS resolution for *.localhost domains in pod contexts
# - Works with OAuth callback URI: http://openwebui.localhost/oauth/oidc/callback
# - No priority configuration needed (IngressRoute handles routing differently than Ingress)
#
# Cluster Standards Compliance:
# - Uses traefik.io/v1alpha1 API version (current working version in Traefik 3.3.6)
# - IngressRoute CRD following established cluster standards per doc/traefik-ingress-rules.md
# - HostRegexp pattern for unified routing (recommended approach)
# - Descriptive labels matching cluster conventions
# - Service port 80 reference (not pod port 8080)
#
# HostRegexp Pattern Explanation:
# - 'openwebui\..+' matches any domain that starts with 'openwebui.'
# - Examples: openwebui.localhost, openwebui.urbalurba.no, openwebui.example.com
# - The '\.' escapes the literal dot, '.+' matches one or more characters
# - Enables automatic external access without duplicating IngressRoute rules
#
# OAuth Integration Benefits:
# - Consistent hostname (openwebui.localhost) for OAuth callback configuration
# - Works in both browser context (via Traefik) and pod context (via CoreDNS)
# - Supports OAuth discovery and authentication flow with Authentik
# - Single configuration works for all access patterns
#
# Migration Notes:
# - Converted from standard Kubernetes Ingress to Traefik IngressRoute
# - Removed priority annotation (not needed for IngressRoute)
# - Removed SSL redirect annotation (managed at IngressRoute level)
# - Updated to use HostRegexp for multi-domain support
# - Maintains same service routing (open-webui:80)

---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: open-webui
  namespace: ai
  labels:
    app: open-webui
    component: ingress
    type: public
    routing: unified
spec:
  entryPoints:
    - web
  routes:
    - match: HostRegexp(`openwebui\..+`)
      kind: Rule
      services:
        - name: open-webui
          port: 80
