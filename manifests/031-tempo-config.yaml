# File: manifests/031-tempo-config.yaml
#
# Description:
# Helm values file for deploying Tempo with the official Helm chart.
# Tempo is a distributed tracing backend for storing and querying traces.
# It provides the traces storage backend for Grafana dashboards and integrates
# with OpenTelemetry Collector for trace ingestion.
#
# Features:
# - Distributed tracing storage with 24-hour retention
# - Persistent volume for trace data durability (10Gi)
# - OTLP receivers for both gRPC (4317) and HTTP (4318) protocols
# - ClusterIP service for internal cluster access
# - Native integration with OpenTelemetry Collector
# - Efficient trace storage and query capabilities
#
# Usage:
#   helm upgrade --install tempo grafana/tempo \
#     -n monitoring -f manifests/031-tempo-config.yaml
#
# Prerequisites:
# - The 'monitoring' namespace must exist
# - PersistentVolume support in the cluster
# - Helm repository: https://grafana.github.io/helm-charts
#
# Integration:
# - Receives traces from OpenTelemetry Collector via OTLP protocol
# - Provides traces datasource for Grafana
# - Accessible at: tempo.monitoring.svc.cluster.local:4317 (gRPC)
# - Accessible at: tempo.monitoring.svc.cluster.local:4318 (HTTP)
#
# Access:
# - Internal cluster: tempo.monitoring.svc.cluster.local:4317 (gRPC)
# - Internal cluster: tempo.monitoring.svc.cluster.local:4318 (HTTP)
# - No external access required (internal service only)

# Tempo configuration
tempo:
  # OTLP receivers configuration
  receivers:
    otlp:
      protocols:
        # gRPC endpoint for OTLP traces
        grpc:
          endpoint: 0.0.0.0:4317
        # HTTP endpoint for OTLP traces
        http:
          endpoint: 0.0.0.0:4318

  # Trace retention period
  retention: 24h

  # Metrics generator for automatic service graphs and span metrics
  metricsGenerator:
    enabled: true
    remoteWriteUrl: "http://prometheus-server.monitoring.svc.cluster.local:80/api/v1/write"

  # Additional Tempo configuration via structuredConfig
  structuredConfig:
    metrics_generator:
      registry:
        external_labels:
          source: tempo
      storage:
        path: /var/tempo/generator/wal
        remote_write:
          - url: http://prometheus-server.monitoring.svc.cluster.local:80/api/v1/write
            send_exemplars: true
      traces_storage:
        path: /var/tempo/generator/traces
      processor:
        service_graphs:
          dimensions:
            - service.name
            - peer.service
          histogram_buckets: [0.1, 0.2, 0.5, 1, 2, 5, 10]
        span_metrics:
          dimensions:
            - service.name
            - peer.service
            - log.type
    overrides:
      defaults:
        metrics_generator:
          processors: [service-graphs, span-metrics]

# Persistence configuration
persistence:
  enabled: true
  size: 10Gi

# Service configuration
service:
  type: ClusterIP

# ServiceMonitor configuration
# Disabled as Prometheus scraping is not required for Tempo
serviceMonitor:
  enabled: false
