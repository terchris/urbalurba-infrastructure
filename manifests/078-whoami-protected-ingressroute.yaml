# File: manifests/078-whoami-protected-ingressroute.yaml
#
# Description:
# IngressRoute for whoami service with Authentik forward authentication middleware
# Routes whoami.localhost through authentication before serving content
# Provides protected access to the same service available publicly at whoami-public.localhost
#
# Usage:
# kubectl apply -f 078-whoami-protected-ingressroute.yaml
#
# Dependencies:
# - 070-whoami-service-and-deployment.yaml (whoami service must exist)
# - 075-authentik-complete-hardcoded.yaml (Authentik must be deployed and running)
# - 077-authentik-forward-auth-middleware.yaml (middleware must be defined)
# - Authentik UI configuration must be completed (see UI Configuration section)
#
# UI Configuration Prerequisites:
# Before deploying this file, complete these steps in Authentik UI (http://authentik.localhost):
# 1. Create Application: name="whoami", slug="whoami"
# 2. Create Proxy Provider: name="whoami-provider", mode="Forward auth (single application)", external_host="http://whoami.localhost"
# 3. Link Provider to Application: edit whoami application, assign whoami-provider
# 4. Configure Outpost: edit "authentik Embedded Outpost", add whoami application
#
# Testing:
# Unauthenticated: curl -L http://whoami.localhost
# Should redirect to Authentik login page
#
# Authenticated (browser): open http://whoami.localhost
# Should redirect to login, then return to whoami with authentication headers
#
# Compare with public route: curl http://whoami-public.localhost
# Should show same service without authentication requirements
#
# Authentication Headers:
# When properly configured, the following headers are passed to whoami:
# - X-Forwarded-User
# - X-Forwarded-Email
# - X-Forwarded-Groups
# - X-Forwarded-Name
# - X-Forwarded-Preferred-Username
# - X-Forwarded-User-Id
#
# Cluster Standards Compliance:
# - Uses traefik.io/v1alpha1 API version
# - IngressRoute CRD (follows cluster ingress standards)
# - References middleware by name and namespace
#
# Authentik 2025.8 Compatibility:
# - Forward authentication flow unchanged
# - Middleware integration unchanged
# - Authentication headers unchanged

---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: whoami-protected
  namespace: default
  labels:
    app: whoami
    component: protected-routing
    protection: authentik-forward-auth
spec:
  entryPoints:
    - web
  routes:
    - match: Host(`whoami.localhost`)
      kind: Rule
      services:
        - name: whoami
          port: 80
      middlewares:
        - name: authentik-forward-auth
          namespace: default