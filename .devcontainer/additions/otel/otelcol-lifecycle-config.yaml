# File: .devcontainer/additions/otel/otelcol-lifecycle-config.yaml
# OpenTelemetry Collector Configuration for Devcontainer Monitoring
# Purpose: Tracks developer activity, sends logs and system metrics to k8s observability stack
#
# This config uses OTEL's native environment variable expansion: ${env:VARIABLE_NAME}
# Variables are automatically sourced by service-otel-monitoring.sh from:
#   - ~/.devcontainer-identity (DEVELOPER_ID, DEVELOPER_EMAIL, PROJECT_NAME, TS_HOSTNAME)
#   - ~/.git-identity (GIT_PROVIDER, GIT_ORG, GIT_REPO - for project/org filtering)
#   - /workspace/.devcontainer.secrets/env-vars/.host-info (HOST_OS, HOST_USER, HOST_HOSTNAME, HOST_DOMAIN, HOST_CPU_ARCH)
#   - /workspace/.devcontainer.secrets/env-vars/.host-info (HOST_WIN_PROCESSORS, HOST_WIN_PROC_ARCH, HOST_WIN_LOGONSERVER - Windows only)
#   - ~/.nginx-backend-config (NGINX_OTEL_PORT)

receivers:
  # OTLP receiver - receives telemetry from applications
  # Security: Bind to localhost only - telemetry should come from within container
  # Applications send to localhost:4317 (gRPC) or localhost:4318 (HTTP/OTLP)
  otlp:
    protocols:
      grpc:
        endpoint: 127.0.0.1:4317
      http:
        endpoint: 127.0.0.1:4318

processors:
  # Batch processor - batches telemetry for efficient transmission
  batch:
    timeout: 10s
    send_batch_size: 1024

  # Resource processor - adds developer/project identity to ALL telemetry
  resource:
    attributes:
      # Developer identity (using underscores to match Loki ingestion format)
      - key: developer_id
        value: ${env:DEVELOPER_ID}
        action: upsert
      - key: developer_email
        value: ${env:DEVELOPER_EMAIL}
        action: upsert

      # Project identity
      - key: project_name
        value: ${env:PROJECT_NAME}
        action: upsert

      # Git repository information (from config-git.sh / git-identity.sh)
      - key: git.provider
        value: ${env:GIT_PROVIDER}
        action: upsert
      - key: git.organization
        value: ${env:GIT_ORG}
        action: upsert
      - key: git.repository
        value: ${env:GIT_REPO}
        action: upsert

      # Service identification (using service.name per OpenTelemetry spec)
      - key: service.name
        value: devcontainer-monitor
        action: upsert
      - key: service_namespace
        value: devcontainer
        action: upsert

      # Environment
      - key: deployment_environment
        value: development
        action: upsert

      # Host identification
      - key: host_name
        value: ${env:TS_HOSTNAME}
        action: upsert

      # Host machine information (from config-host-info.sh)
      - key: host.name
        value: ${env:TS_HOSTNAME}
        action: upsert
      - key: host.os
        value: ${env:HOST_OS}
        action: upsert
      - key: host.user
        value: ${env:HOST_USER}
        action: upsert
      - key: host.hostname
        value: ${env:HOST_HOSTNAME}
        action: upsert
      - key: host.domain
        value: ${env:HOST_DOMAIN}
        action: upsert
      - key: host.cpu.arch
        value: ${env:HOST_CPU_ARCH}
        action: upsert

      # Windows extended variables - using OTel semantic conventions where available
      # (values are "undefined" on Mac/Linux)
      - key: host.arch
        value: ${env:HOST_ARCH}
        action: upsert
      - key: host.cpu.model.name
        value: ${env:HOST_CPU_MODEL_NAME}
        action: upsert
      - key: host.cpu.logical.count
        value: ${env:HOST_CPU_LOGICAL_COUNT}
        action: upsert

      # Organization detection (from Windows OneDrive/LOGONSERVER)
      - key: organization.name
        value: ${env:ORGANIZATION_NAME}
        action: upsert
      - key: organization.prefix
        value: ${env:ORGANIZATION_PREFIX}
        action: upsert
      - key: organization.machine.ownership
        value: ${env:ORGANIZATION_MACHINE_OWNERSHIP}
        action: upsert

  # Memory limiter - prevents OOM by limiting memory usage
  memory_limiter:
    check_interval: 1s
    limit_mib: 512
    spike_limit_mib: 128

exporters:
  # OTLP HTTP exporter - sends telemetry to k8s cluster via nginx proxy
  otlphttp:
    endpoint: http://localhost:${env:NGINX_OTEL_PORT}
    headers:
      Host: otel.localhost
    # Note: Routes through nginx reverse proxy on localhost:${env:NGINX_OTEL_PORT}
    # Nginx forwards to backend infrastructure with Host header for Traefik routing
    compression: gzip
    timeout: 10s
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s

# Telemetry configuration for the collector itself
service:
  # Internal telemetry for the collector
  telemetry:
    logs:
      level: info
      # Output collector's own logs to stdout/stderr instead of directly to /var/log/
      # Why: Collector runs as non-root vscode user and cannot write to /var/log/otelcol.log
      # Solution: stdout/stderr are captured by nohup in start-otel-monitoring.sh and redirected
      # to /var/log/otelcol-lifecycle.log (which has proper permissions set by the start script)
      # This avoids "permission denied" errors while still logging to /var/log/
      output_paths:
        - stdout
      error_output_paths:
        - stderr

    metrics:
      # Disable collector's internal metrics
      level: none

  # Telemetry pipelines
  pipelines:
    # Logs pipeline - receives logs and forwards to k8s
    logs:
      receivers: [otlp]
      processors: [memory_limiter, resource, batch]
      exporters: [otlphttp]

    # Traces pipeline - receives traces and forwards to k8s
    traces:
      receivers: [otlp]
      processors: [memory_limiter, resource, batch]
      exporters: [otlphttp]

    # Metrics pipeline - receives application metrics and forwards to k8s
    # Note: System metrics (CPU, RAM, disk) handled by separate metrics collector
    metrics:
      receivers: [otlp]
      processors: [memory_limiter, resource, batch]
      exporters: [otlphttp]
