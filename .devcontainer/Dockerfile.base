# file: .devcontainer/Dockerfile.base
# Description: Optimized base install for all devcontainers
# OPTIMIZATIONS APPLIED:
# - Combined RUN commands to reduce layers (fewer layers = smaller image)
# - Aggressive cleanup in same layer (critical for size reduction)
# - Direct Node.js binary installation (most reliable, no external repos)
# - Added GitHub CLI (gh) for enhanced Git workflow
# - Added Supervisord for multi-process management in devcontainers
# - Added Docker CLI (static binary, ~25MB - no buildx/compose bloat)

# Use the official Python devcontainer image as the base
# Note: Using bookworm (Debian 12) as trixie images are not yet available from Microsoft
FROM mcr.microsoft.com/devcontainers/python:1-3.12-bookworm

# Switch to vscode user for all operations
USER vscode

# =============================================================================
# BUILD ARGUMENTS - Environment variables from host system
# =============================================================================
# Mac environment variables
ARG DEV_MAC_LOGNAME
ARG DEV_MAC_USER

# Linux environment variables
ARG DEV_LINUX_LOGNAME
ARG DEV_LINUX_USER

# Windows environment variables
ARG DEV_WIN_USERDNSDOMAIN
ARG DEV_WIN_USERDOMAIN
ARG DEV_WIN_USERDOMAIN_ROAMINGPROFILE
ARG DEV_WIN_USERNAME
ARG DEV_WIN_COMPUTERNAME
ARG DEV_WIN_OS

# Set Node.js version (update this as needed)
ARG NODE_VERSION=22.12.0

# Set Docker CLI version (update this as needed)
ARG DOCKER_VERSION=27.5.1

# Set environment variables in container (combined for efficiency)
ENV DEV_MAC_LOGNAME=$DEV_MAC_LOGNAME \
    DEV_MAC_USER=$DEV_MAC_USER \
    DEV_LINUX_LOGNAME=$DEV_LINUX_LOGNAME \
    DEV_LINUX_USER=$DEV_LINUX_USER \
    DEV_WIN_USERDNSDOMAIN=$DEV_WIN_USERDNSDOMAIN \
    DEV_WIN_USERDOMAIN=$DEV_WIN_USERDOMAIN \
    DEV_WIN_USERDOMAIN_ROAMINGPROFILE=$DEV_WIN_USERDOMAIN_ROAMINGPROFILE \
    DEV_WIN_USERNAME=$DEV_WIN_USERNAME \
    DEV_WIN_COMPUTERNAME=$DEV_WIN_COMPUTERNAME \
    DEV_WIN_OS=$DEV_WIN_OS \
    DEBIAN_FRONTEND=noninteractive \
    PATH="/usr/local/bin:/workspace/.devcontainer:$PATH"

# =============================================================================
# COMBINED INSTALLATION - All tools in one layer for size optimization
# =============================================================================
# Install system packages, Node.js, Docker CLI, GitHub CLI, and Supervisord in a single layer
# This reduces the number of Docker layers and allows aggressive cleanup
#
# Packages installed:
# - libcap2-bin: File capabilities for network/permission management
# - iputils-ping: Network connectivity testing (ping command)
# - iproute2: Network interface and routing management (ip command)
# - traceroute: Network route diagnostics
# - jc: Convert CLI output to JSON for parsing
# - xdg-utils: Open URLs/files (xdg-open for clickable links)
# - git, curl, wget: Version control and download utilities
# - zip, unzip: Archive handling (required by many scripts)
# - ca-certificates, gnupg, lsb-release: Required for adding repositories
# - xz-utils: Required for extracting Node.js tarball
# - supervisor: Process control system for managing multiple services
#
# Tools installed:
# - Node.js LTS (22.12.0): JavaScript runtime with npm (direct binary install)
# - Docker CLI (27.5.1): Container management (static binary, ~25MB)
# - GitHub CLI (gh): Enhanced Git/GitHub workflow
# - Supervisord: Multi-process manager for devcontainer services

RUN sudo apt-get update && \
    # Install base system packages including supervisor
    sudo apt-get install -y --no-install-recommends \
        libcap2-bin \
        iputils-ping \
        iproute2 \
        traceroute \
        jc \
        xdg-utils \
        git \
        curl \
        wget \
        zip \
        unzip \
        ca-certificates \
        gnupg \
        lsb-release \
        xz-utils \
        supervisor && \

    # Install Node.js directly from official binaries (most reliable method)
    # Supports x86_64 (amd64), ARM64, and ARM32 (armhf) architectures
    # Determine system architecture for binary downloads
    ARCH=$(dpkg --print-architecture) && \    
    case "$ARCH" in \
        amd64) NODE_ARCH="x64" ;; \
        arm64) NODE_ARCH="arm64" ;; \
        armhf) NODE_ARCH="armv7l" ;; \
        *) echo "Unsupported architecture: $ARCH" && exit 1 ;; \
    esac && \
    curl -fsSL "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-${NODE_ARCH}.tar.xz" -o /tmp/node.tar.xz && \
    sudo tar -xJf /tmp/node.tar.xz -C /usr/local --strip-components=1 && \
    rm /tmp/node.tar.xz && \
    # Verify Node.js and npm are installed
    node --version && npm --version && \
    # Install Docker CLI (static binary - minimal footprint, ~25MB)
    case "$ARCH" in \
        amd64) DOCKER_ARCH="x86_64" ;; \
        arm64) DOCKER_ARCH="aarch64" ;; \
        armhf) DOCKER_ARCH="armhf" ;; \
        *) echo "Unsupported architecture for Docker: $ARCH" && exit 1 ;; \
    esac && \
    curl -fsSL "https://download.docker.com/linux/static/stable/${DOCKER_ARCH}/docker-${DOCKER_VERSION}.tgz" | \
        sudo tar xzv --strip-components=1 -C /usr/local/bin docker/docker && \
    # Verify Docker CLI is installed
    docker --version && \
    # Create docker group matching host socket GID and add vscode user
    # This allows vscode user to access Docker socket without sudo
    sudo groupadd -g 102 docker 2>/dev/null || true && \
    sudo usermod -aG docker vscode && \
    # Install GitHub CLI
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
    sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$ARCH signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
    sudo apt-get update && \
    sudo apt-get install -y --no-install-recommends gh && \
    # Configure npm for vscode user
    sudo mkdir -p /usr/local/lib/node_modules /usr/local/bin && \
    sudo chown -R vscode:vscode /usr/local/lib/node_modules /usr/local/bin && \
    npm config set prefix '/usr/local' && \
    echo 'export PATH=/usr/local/bin:$PATH' >> ~/.bashrc && \
    # Configure Supervisord base structure
    sudo mkdir -p /var/log/supervisor /var/run/supervisor /etc/supervisor/conf.d && \
    sudo chown -R vscode:vscode /var/log/supervisor && \
    printf '%s\n' \
        '[supervisord]' \
        'nodaemon=true' \
        'user=root' \
        'logfile=/var/log/supervisor/supervisord.log' \
        'pidfile=/var/run/supervisord.pid' \
        'childlogdir=/var/log/supervisor' \
        '' \
        '[unix_http_server]' \
        'file=/var/run/supervisor.sock' \
        'chmod=0700' \
        '' \
        '[supervisorctl]' \
        'serverurl=unix:///var/run/supervisor.sock' \
        '' \
        '[rpcinterface:supervisor]' \
        'supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface' \
        '' \
        '[include]' \
        'files = /etc/supervisor/conf.d/*.conf' \
        | sudo tee /etc/supervisor/supervisord.conf > /dev/null && \
    # AGGRESSIVE CLEANUP (critical for size reduction - must be in same layer!)
    sudo apt-get clean && \
    sudo rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /var/cache/apt/archives/*

# =============================================================================
# OPTIONAL TOOLS - Install via scripts in .devcontainer/additions/
# =============================================================================
# These tools are now optional and managed via the enabled-tools.conf system.
# Run 'dev-setup' to see available tools and install what you need.
#
# Supervisord services:
# - Services are configured by dropping .conf files into /etc/supervisor/conf.d/
# - Use install scripts to add service configurations automatically
# - Start services with: sudo supervisord -c /etc/supervisor/supervisord.conf
# - Manage services with: sudo supervisorctl {start|stop|restart|status}

# =============================================================================
# FINAL ENVIRONMENT RESET
# =============================================================================
# Reset DEBIAN_FRONTEND to allow interactive prompts in the running container
ENV DEBIAN_FRONTEND=

# =============================================================================
# CONTAINER SUMMARY
# =============================================================================
# Base tools installed in this container:
# - Python 3.12 (from base image)
# - Node.js 22.12.0 LTS with npm (direct binary installation)
# - Docker CLI 27.5.1 (static binary, ~25MB - no buildx/compose)
# - GitHub CLI (gh) for enhanced Git workflow
# - Supervisord for multi-process management (~500KB, always available)
# - Essential networking and development tools (ping, traceroute, jc, etc.)
# - Archive tools (zip, unzip)
# - All environment variables from host system (Mac/Windows)
#
# Base OS: Debian 12 "Bookworm" (stable, released June 2023)
# Kernel: 6.1 LTS
# Support: Until June 2028 (5 years of support)
#
# PATH includes:
# - /usr/local/bin (npm global packages, docker, custom tools)
# - /workspace/.devcontainer (dev-setup and other scripts)
#
# Supervisord structure:
# - Config: /etc/supervisor/supervisord.conf
# - Service configs: /etc/supervisor/conf.d/*.conf
# - Logs: /var/log/supervisor/
# - Socket: /var/run/supervisor.sock
# - Commands: supervisord, supervisorctl
#
# - Run 'dev-setup' for interactive tool management
#
# Why these versions:
# - Python 3.12: Widely supported, stable, perfect for observability tooling
# - Debian Bookworm: Stable and supported until 2028 (Trixie images not yet available)
# - Node.js 22.12.0: Latest LTS, includes npm by default
# - Docker CLI 27.5.1: Latest stable, static binary for minimal footprint
# - Supervisord: Lightweight process manager for running multiple services
# - Direct binary install: Most reliable, no dependency on external repos
#
# Architecture support:
# - x86_64 (amd64): Intel/AMD processors ✅
# - ARM64: Apple Silicon (M1/M2/M3/M4), AWS Graviton ✅
# - ARM32 (armhf): Raspberry Pi and other ARM devices ✅
#
# This Dockerfile works on:
# - Mac (Intel and Apple Silicon)
# - Windows (Intel/AMD)
# - Linux (x64, ARM64, ARM32)
#
# =============================================================================