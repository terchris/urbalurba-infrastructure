---
# file: ansible/playbooks/220-setup-argocd.yml
# Description:
# Set up ArgoCD on Kubernetes
# - Installs ArgoCD using Helm chart
# - Configures ArgoCD with appropriate settings
#
# Usage:
# ansible-playbook playbooks/220-setup-argocd.yml -e target_host="rancher-desktop"

- name: Set up ArgoCD on Kubernetes
  hosts: localhost
  gather_facts: true
  vars:
    manifests_folder: "/mnt/urbalurbadisk/manifests"
    merged_kubeconf_file: "/mnt/urbalurbadisk/kubeconfig/kubeconf-all"
    argocd_namespace: "argocd"
    installation_timeout: 600  # 10 minutes timeout for installations
    pod_readiness_timeout: 300  # 5 minutes timeout for pod readiness
    # Helm chart references
    argocd_chart: "argo/argo-cd"
    argocd_chart_version: "7.8.26"  # Specify the chart version to ensure reproducibility
    # Config files
    argocd_config_file: "{{ manifests_folder }}/220-argocd-config.yaml"
    argocd_ingress_config_file: "{{ manifests_folder }}/221-argocd-ingressroute.yaml"

  tasks:
    - name: 1. Check if required variables are provided
      ansible.builtin.fail:
        msg: "The variable 'target_host' is mandatory. Use -e target_host=your_host_name to specify it."
      when: target_host is not defined

    - name: 2. Print playbook description
      ansible.builtin.debug:
        msg: "Setting up ArgoCD on Kubernetes context: {{ target_host }}"
    
    - name: 3. Create argocd namespace if it doesn't exist
      ansible.builtin.shell: kubectl create namespace {{ argocd_namespace }} --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: namespace_result
      changed_when: namespace_result.rc == 0
      failed_when: namespace_result.rc != 0

    - name: 4. Check existing Helm repositories
      ansible.builtin.command: helm repo list
      register: helm_repo_list
      changed_when: false

    - name: 5. Add Argo Helm repository if needed
      kubernetes.core.helm_repository:
        name: "argo"
        repo_url: "https://argoproj.github.io/argo-helm"
      when: "'argo' not in helm_repo_list.stdout"
      register: helm_repo_result

    - name: 6. Update Helm repositories
      ansible.builtin.command: helm repo update
      changed_when: false
    
    # Generate bcrypt hash and pass it to Helm so the admin password is set correctly
    # on first install. Helm manages argocd-secret â€” no pre-creating or patching needed.
    - name: 7. Check for urbalurba-secrets in argocd namespace
      kubernetes.core.k8s_info:
        kind: Secret
        name: urbalurba-secrets
        namespace: "{{ argocd_namespace }}"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: argocd_secrets

    - name: 7b. Verify urbalurba-secrets exists
      ansible.builtin.assert:
        that:
          - argocd_secrets.resources | length > 0
        fail_msg: "FATAL: urbalurba-secrets not found in {{ argocd_namespace }} namespace. Secrets must be applied before deploying ArgoCD."
        success_msg: "urbalurba-secrets found in {{ argocd_namespace }} namespace"

    - name: 8. Create bcrypt hash for ArgoCD admin password
      ansible.builtin.shell: |
        PASSWORD=$(kubectl get secret urbalurba-secrets -n {{ argocd_namespace }} -o jsonpath='{.data.ARGOCD_ADMIN_PASSWORD}' | base64 -d)
        printf '%s' "$PASSWORD" | python3 -c "import bcrypt,sys; print(bcrypt.hashpw(sys.stdin.buffer.read(), bcrypt.gensalt(10)).decode())"
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: argocd_bcrypt_password
      changed_when: false

    - name: 8b. Verify bcrypt hash was generated
      ansible.builtin.assert:
        that:
          - argocd_bcrypt_password.stdout | length > 0
        fail_msg: "FATAL: bcrypt hash generation failed. stdout='{{ argocd_bcrypt_password.stdout }}' stderr='{{ argocd_bcrypt_password.stderr }}'"
        success_msg: "bcrypt hash generated successfully ({{ argocd_bcrypt_password.stdout | length }} chars)"

    - name: 9. Write temporary Helm values with bcrypt password
      ansible.builtin.copy:
        dest: /tmp/argocd-password-values.yaml
        content: |
          configs:
            secret:
              argocdServerAdminPassword: "{{ argocd_bcrypt_password.stdout }}"
        mode: '0600'

    - name: 10. Deploy ArgoCD using Helm
      ansible.builtin.command: >
        helm upgrade --install argocd {{ argocd_chart }}
        --namespace {{ argocd_namespace }}
        --version {{ argocd_chart_version }}
        -f {{ argocd_config_file }}
        -f /tmp/argocd-password-values.yaml
        --timeout {{ installation_timeout }}s
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: argocd_result
      changed_when: true

    - name: 10b. Clean up temporary password values file
      ansible.builtin.file:
        path: /tmp/argocd-password-values.yaml
        state: absent
      changed_when: false

    # Two-Stage Pod Readiness Verification
    - name: 11. Wait for ArgoCD server pods to be ready (Stage 1 - Running)
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ argocd_namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=argocd-server"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: argocd_pods
      retries: 20
      delay: 15
      until: >
        argocd_pods.resources | length > 0 and
        argocd_pods.resources[0].status.phase == "Running"

    - name: 12. Wait for ArgoCD server pods to be fully ready (Stage 2 - Ready)
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ argocd_namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=argocd-server"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: argocd_pods_ready
      retries: 30
      delay: 10
      until: >
        argocd_pods_ready.resources | length > 0 and
        argocd_pods_ready.resources[0].status.containerStatuses[0].ready == true

    - name: 13. Verify ArgoCD service is running
      ansible.builtin.command:
        cmd: >
          kubectl get svc argocd-server
          --namespace {{ argocd_namespace }}
          --kubeconfig {{ merged_kubeconf_file }}
      register: argocd_svc
      changed_when: false

    - name: 14. Get ArgoCD server pod name
      ansible.builtin.command:
        cmd: >
          kubectl get pods -n {{ argocd_namespace }}
          -l app.kubernetes.io/name=argocd-server
          -o jsonpath='{.items[0].metadata.name}'
          --kubeconfig {{ merged_kubeconf_file }}
      register: argocd_pod_name
      changed_when: false

    # Cluster-Internal Testing - Test from within cluster
    - name: 15. Test ArgoCD HTTP response from within cluster
      ansible.builtin.shell: |
        kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n {{ argocd_namespace }} -- \
        curl -s -w "HTTP_CODE:%{http_code}" http://argocd-server:80/
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: argocd_http_response
      retries: 15
      delay: 15
      until: argocd_http_response.rc == 0 and (argocd_http_response.stdout.find('HTTP_CODE:200') != -1 or argocd_http_response.stdout.find('HTTP_CODE:302') != -1)

    - name: 16. Apply ArgoCD IngressRoute configuration
      kubernetes.core.k8s:
        kubeconfig: "{{ merged_kubeconf_file }}"
        state: present
        src: "{{ argocd_ingress_config_file }}"
        namespace: "{{ argocd_namespace }}"

    - name: 17. Verify ArgoCD IngressRoute is created
      kubernetes.core.k8s_info:
        api_version: traefik.io/v1alpha1
        kind: IngressRoute
        namespace: "{{ argocd_namespace }}"
        name: argocd-server
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: ingress_check
      retries: 5
      delay: 2
      until: ingress_check.resources | length > 0

    - name: 18. Get standardized ArgoCD credentials
      ansible.builtin.shell: |
        kubectl get secret urbalurba-secrets -n {{ argocd_namespace }} -o jsonpath='{.data.ARGOCD_ADMIN_USERNAME}' | base64 -d
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: argocd_username
      changed_when: false

    - name: 19. Run end-to-end ArgoCD tests
      ansible.builtin.command: >
        ansible-playbook /mnt/urbalurbadisk/ansible/playbooks/220-test-argocd.yml
        -e kube_context={{ target_host | default('rancher-desktop') }}
      register: argocd_test_result
      failed_when: false
      changed_when: false

    - name: 20. Display test results
      ansible.builtin.debug:
        msg: "{{ argocd_test_result.stdout_lines | default(['No test output']) }}"
      when: argocd_test_result.stdout_lines is defined

    - name: 21. Display final deployment status
      ansible.builtin.debug:
        msg:
          - "==============================================="
          - "ğŸš€ ArgoCD Deployment Status"
          - "==============================================="
          - ""
          - "âœ… SUCCESS - All components verified and running"
          - ""
          - "ğŸ”„ Status:"
          - "â€¢ Service connectivity: âœ… Internal cluster communication verified"
          - "â€¢ HTTP responding: âœ… ArgoCD web interface accessible"
          - "â€¢ Pod readiness: âœ… ArgoCD server pod ready and operational"
          - "â€¢ IngressRoute: âœ… Traefik routing configured (rules-compliant)"
          - "â€¢ Admin secret: {{ 'âœ… Standardized credentials available' if argocd_username.rc == 0 else 'âš ï¸ Credentials not found' }}"
          - ""
          - "ğŸŒ Access Instructions:"
          - "â€¢ Primary: http://argocd.localhost (Traefik IngressRoute)"
          - "â€¢ Port-forward: kubectl port-forward svc/argocd-server -n {{ argocd_namespace }} 8080:80"
          - "â€¢ External: https://argocd.urbalurba.no (when Cloudflare tunnel configured)"
          - "â€¢ Interface: Web-based GitOps continuous delivery"
          - ""
          - "ğŸ” Login Credentials (Novice-Friendly):"
          - "â€¢ Username: {{ argocd_username.stdout if argocd_username.rc == 0 else 'admin' }}"
          - "â€¢ Password: Same as your DEFAULT_ADMIN_PASSWORD (from urbalurba-secrets)"
          - "â€¢ Quick check: kubectl get secret urbalurba-secrets -n {{ argocd_namespace }} -o jsonpath='{.data.ARGOCD_ADMIN_PASSWORD}' | base64 -d"
          - ""
          - "âœ¨ User-Friendly Features:"
          - "â€¢ Standardized password - same across all services"
          - "â€¢ No need to retrieve random generated passwords"
          - "â€¢ Consistent with other management interfaces"
          - ""
          - "ğŸ”§ Troubleshooting:"
          - "â€¢ Check pod status: kubectl get pods -n {{ argocd_namespace }}"
          - "â€¢ View logs: kubectl logs -f {{ argocd_pod_name.stdout }} -n {{ argocd_namespace }}"
          - "â€¢ Restart deployment: kubectl rollout restart deployment/argocd-server -n {{ argocd_namespace }}"
          - "==============================================="
