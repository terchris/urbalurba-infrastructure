---
# file: ansible/playbooks/220-setup-argocd.yml
# Description:
# Set up ArgoCD on Kubernetes
# - Installs ArgoCD using Helm chart
# - Configures ArgoCD with appropriate settings
#
# Usage:
# ansible-playbook playbooks/220-setup-argocd.yml -e target_host="rancher-desktop"

- name: Set up ArgoCD on Kubernetes
  hosts: localhost
  gather_facts: true
  vars:
    manifests_folder: "/mnt/urbalurbadisk/manifests"
    merged_kubeconf_file: "/mnt/urbalurbadisk/kubeconfig/kubeconf-all"
    argocd_namespace: "argocd"
    installation_timeout: 600  # 10 minutes timeout for installations
    pod_readiness_timeout: 300  # 5 minutes timeout for pod readiness
    # Helm chart references
    argocd_chart: "argo/argo-cd"
    argocd_chart_version: "7.8.26"  # Specify the chart version to ensure reproducibility
    # Config files
    argocd_config_file: "{{ manifests_folder }}/220-argocd-config.yaml"
    argocd_ingress_config_file: "{{ manifests_folder }}/221-argocd-ingressroute.yaml"

  tasks:
    - name: 1. Check if required variables are provided
      ansible.builtin.fail:
        msg: "The variable 'target_host' is mandatory. Use -e target_host=your_host_name to specify it."
      when: target_host is not defined

    - name: 2. Print playbook description
      ansible.builtin.debug:
        msg: "Setting up ArgoCD on Kubernetes context: {{ target_host }}"
    
    - name: 3. Create argocd namespace if it doesn't exist
      ansible.builtin.shell: kubectl create namespace {{ argocd_namespace }} --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: namespace_result
      changed_when: namespace_result.rc == 0
      failed_when: namespace_result.rc != 0

    - name: 4. Check existing Helm repositories
      ansible.builtin.command: helm repo list
      register: helm_repo_list
      changed_when: false

    - name: 5. Add Argo Helm repository if needed
      kubernetes.core.helm_repository:
        name: "argo"
        repo_url: "https://argoproj.github.io/argo-helm"
      when: "'argo' not in helm_repo_list.stdout"
      register: helm_repo_result

    - name: 6. Update Helm repositories
      ansible.builtin.command: helm repo update
      changed_when: false
    
    # Install ArgoCD
    - name: 7. Get ArgoCD credentials from urbalurba-secrets
      kubernetes.core.k8s_info:
        kind: Secret
        name: urbalurba-secrets
        namespace: "{{ argocd_namespace }}"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: argocd_secrets
      failed_when: false

    - name: 8. Create bcrypt hash for ArgoCD admin password
      ansible.builtin.shell: |
        PASSWORD=$(kubectl get secret urbalurba-secrets -n {{ argocd_namespace }} -o jsonpath='{.data.ARGOCD_ADMIN_PASSWORD}' | base64 -d)
        echo "$PASSWORD" | htpasswd -niBC 10 admin | cut -d ':' -f 2
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: argocd_bcrypt_password
      when: argocd_secrets.resources | length > 0
      changed_when: false

    - name: 9. Create ArgoCD secret with hashed password
      kubernetes.core.k8s:
        kubeconfig: "{{ merged_kubeconf_file }}"
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: argocd-secret
            namespace: "{{ argocd_namespace }}"
            labels:
              app.kubernetes.io/name: argocd-secret
              app.kubernetes.io/part-of: argocd
          type: Opaque
          stringData:
            admin.password: "{{ argocd_bcrypt_password.stdout }}"
            admin.passwordMtime: "{{ ansible_date_time.iso8601 }}"
      when: argocd_secrets.resources | length > 0 and argocd_bcrypt_password.stdout is defined

    - name: 10. Deploy ArgoCD using Helm
      ansible.builtin.command: >
        helm upgrade --install argocd {{ argocd_chart }}
        --namespace {{ argocd_namespace }}
        --version {{ argocd_chart_version }}
        -f {{ argocd_config_file }}
        --timeout {{ installation_timeout }}s
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: argocd_result
      changed_when: true

    # Rule 6: Two-Stage Pod Readiness Verification
    - name: 11. Wait for ArgoCD server pods to be ready (Stage 1 - Running)
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ argocd_namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=argocd-server"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: argocd_pods
      retries: 20
      delay: 15
      until: >
        argocd_pods.resources | length > 0 and
        argocd_pods.resources[0].status.phase == "Running"

    - name: 12. Wait for ArgoCD server pods to be fully ready (Stage 2 - Ready)
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ argocd_namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=argocd-server"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: argocd_pods_ready
      retries: 30
      delay: 10
      until: >
        argocd_pods_ready.resources | length > 0 and
        argocd_pods_ready.resources[0].status.containerStatuses[0].ready == true
    - name: 13. Verify ArgoCD service is running
      ansible.builtin.command:
        cmd: >
          kubectl get svc argocd-server
          --namespace {{ argocd_namespace }}
          --kubeconfig {{ merged_kubeconf_file }}
      register: argocd_svc
      changed_when: false

    - name: 14. Display ArgoCD service details
      ansible.builtin.debug:
        var: argocd_svc.stdout_lines

    - name: 15. Get ArgoCD server pod name
      ansible.builtin.command:
        cmd: >
          kubectl get pods -n {{ argocd_namespace }}
          -l app.kubernetes.io/name=argocd-server
          -o jsonpath='{.items[0].metadata.name}'
          --kubeconfig {{ merged_kubeconf_file }}
      register: argocd_pod_name
      changed_when: false

    # Rule 3: Cluster-Internal Testing - Test from within cluster
    - name: 16. Test ArgoCD HTTP response from within cluster
      ansible.builtin.shell: |
        kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n {{ argocd_namespace }} -- \
        curl -s -w "HTTP_CODE:%{http_code}" http://argocd-server:80/
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: argocd_http_response
      retries: 15
      delay: 15
      until: argocd_http_response.rc == 0 and (argocd_http_response.stdout.find('HTTP_CODE:200') != -1 or argocd_http_response.stdout.find('HTTP_CODE:302') != -1)

    - name: 17. Apply ArgoCD IngressRoute configuration
      kubernetes.core.k8s:
        kubeconfig: "{{ merged_kubeconf_file }}"
        state: present
        src: "{{ argocd_ingress_config_file }}"
        namespace: "{{ argocd_namespace }}"

    - name: 18. Verify ArgoCD IngressRoute is created
      kubernetes.core.k8s_info:
        api_version: traefik.io/v1alpha1
        kind: IngressRoute
        namespace: "{{ argocd_namespace }}"
        name: argocd-server
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: ingress_check
      retries: 5
      delay: 2
      until: ingress_check.resources | length > 0

    - name: 19. Check if ArgoCD credentials are available
      ansible.builtin.shell: |
        kubectl get secret argocd-initial-admin-secret -n {{ argocd_namespace }} --kubeconfig {{ merged_kubeconf_file }}
      register: admin_secret_check
      changed_when: false

    - name: 20. Get standardized ArgoCD credentials
      ansible.builtin.shell: |
        kubectl get secret urbalurba-secrets -n {{ argocd_namespace }} -o jsonpath='{.data.ARGOCD_ADMIN_USERNAME}' | base64 -d
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: argocd_username
      changed_when: false

    - name: 21. Display final deployment status
      ansible.builtin.debug:
        msg:
          - "==============================================="
          - "üöÄ ArgoCD Deployment Status"
          - "==============================================="
          - ""
          - "‚úÖ SUCCESS - All components verified and running"
          - ""
          - "üîÑ Status:"
          - "‚Ä¢ Service connectivity: ‚úÖ Internal cluster communication verified"
          - "‚Ä¢ HTTP responding: ‚úÖ ArgoCD web interface accessible"
          - "‚Ä¢ Pod readiness: ‚úÖ ArgoCD server pod ready and operational"
          - "‚Ä¢ IngressRoute: ‚úÖ Traefik routing configured (rules-compliant)"
          - "‚Ä¢ Admin secret: {{ '‚úÖ Standardized credentials available' if argocd_username.rc == 0 else '‚ö†Ô∏è Credentials not found' }}"
          - ""
          - "üåê Access Instructions:"
          - "‚Ä¢ Primary: http://argocd.localhost (Traefik IngressRoute)"
          - "‚Ä¢ Port-forward: kubectl port-forward svc/argocd-server -n {{ argocd_namespace }} 8080:80"
          - "‚Ä¢ External: https://argocd.urbalurba.no (when Cloudflare tunnel configured)"
          - "‚Ä¢ Interface: Web-based GitOps continuous delivery"
          - ""
          - "üîê Login Credentials (Novice-Friendly):"
          - "‚Ä¢ Username: {{ argocd_username.stdout if argocd_username.rc == 0 else 'admin' }}"
          - "‚Ä¢ Password: Same as your DEFAULT_ADMIN_PASSWORD (from urbalurba-secrets)"
          - "‚Ä¢ Quick check: kubectl get secret urbalurba-secrets -n {{ argocd_namespace }} -o jsonpath='{.data.ARGOCD_ADMIN_PASSWORD}' | base64 -d"
          - ""
          - "‚ú® User-Friendly Features:"
          - "‚Ä¢ Standardized password - same across all services"
          - "‚Ä¢ No need to retrieve random generated passwords"
          - "‚Ä¢ Consistent with other management interfaces"
          - ""
          - "üîß Troubleshooting:"
          - "‚Ä¢ Check pod status: kubectl get pods -n {{ argocd_namespace }}"
          - "‚Ä¢ View logs: kubectl logs -f {{ argocd_pod_name.stdout }} -n {{ argocd_namespace }}"
          - "‚Ä¢ Restart deployment: kubectl rollout restart deployment/argocd-server -n {{ argocd_namespace }}"
          - "==============================================="
