---
# File: ansible/playbooks/034-remove-grafana.yml
# Description: Remove Grafana from Urbalurba Infrastructure
# Usage: ansible-playbook 034-remove-grafana.yml -e "target_host=rancher-desktop"

- name: Remove Grafana from Urbalurba Infrastructure
  hosts: localhost
  gather_facts: false

  vars:
    # target_host passed via -e, use _target for internal reference to avoid recursion
    _target: "{{ target_host | default('rancher-desktop') }}"
    namespace: "monitoring"
    component_name: "grafana"
    manifests_folder: "/mnt/urbalurbadisk/manifests"

  tasks:
    - name: 1. Display removal information
      ansible.builtin.debug:
        msg:
          - "====================================="
          - "Grafana Removal"
          - "File: ansible/playbooks/034-remove-grafana.yml"
          - "====================================="
          - "Target Host: {{ _target }}"
          - "Namespace: {{ namespace }}"
          - "Component: {{ component_name }}"

    - name: 2. Remove Grafana IngressRoute
      kubernetes.core.k8s:
        state: absent
        src: "{{ manifests_folder }}/038-grafana-ingressroute.yaml"
        context: "{{ _target }}"
      failed_when: false

    - name: 3. Remove Installation Test Suite dashboards manifest
      kubernetes.core.k8s:
        state: absent
        src: "{{ manifests_folder }}/035-grafana-test-dashboards.yaml"
        context: "{{ _target }}"
      failed_when: false

    - name: 4. Remove ALL dashboard ConfigMaps (cleanup any leftovers)
      ansible.builtin.command: >
        kubectl delete configmap -n {{ namespace }} -l grafana_dashboard=1 --context={{ _target }} --ignore-not-found=true
      register: dashboard_cleanup
      failed_when: false

    - name: 5. Remove Grafana Helm chart
      kubernetes.core.helm:
        name: grafana
        release_namespace: "{{ namespace }}"
        state: absent
        context: "{{ _target }}"
      register: grafana_removal
      failed_when: false

    - name: 6. Wait for Grafana to be removed
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ namespace }}"
        label_selectors:
          - app.kubernetes.io/name=grafana
        context: "{{ _target }}"
      register: grafana_pods
      retries: 10
      delay: 5
      until: grafana_pods.resources | length == 0

    - name: 7. Display removal status
      ansible.builtin.debug:
        msg:
          - "âœ… Grafana removal completed!"
          - ""
          - "Removed components:"
          - "  ğŸ“Š Grafana UI and API"
          - "  ğŸ“ˆ Prometheus datasource"
          - "  ğŸ“‹ Loki datasource"
          - "  ğŸ” Tempo datasource"
          - "  ğŸŒ IngressRoute (grafana.*)"
          - "  ğŸ“Š All dashboard ConfigMaps (cleaned up with label grafana_dashboard=1)"
          - "  ğŸ’¾ Persistent volume claim (data retained)"
          - ""
          - "Verification:"
          - "  kubectl get pods -n {{ namespace }} -l app.kubernetes.io/name=grafana --context={{ _target }}"
          - "  kubectl get configmaps -n {{ namespace }} -l grafana_dashboard=1 --context={{ _target }}"
          - "  kubectl get ingressroute -n {{ namespace }} grafana --context={{ _target }}"
          - "  (All should show 'No resources found')"
