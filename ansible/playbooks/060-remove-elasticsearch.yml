---
# file: playbooks/060-remove-elasticsearch.yml
# Remove Elasticsearch from Kubernetes cluster
#
# Works with both Elastic's official chart and legacy Bitnami deployments.
#
# Usage:
# ansible-playbook playbooks/060-remove-elasticsearch.yml -e target_host="rancher-desktop"

- name: Remove Elasticsearch from Kubernetes
  hosts: localhost
  gather_facts: false
  vars:
    merged_kubeconf_file: "/mnt/urbalurbadisk/.uis.secrets/generated/kubeconfig/kubeconf-all"
    elasticsearch_namespace: "default"
    # Labels for both Elastic official and Bitnami charts
    elasticsearch_pod_label_elastic: "app=elasticsearch-master"
    elasticsearch_pod_label_bitnami: "app.kubernetes.io/name=elasticsearch"

  tasks:
    - name: 1. Print removal description
      ansible.builtin.debug:
        msg: |
          ðŸ§¹ Starting Elasticsearch removal
          ðŸŽ¯ Target: {{ target_host | default('rancher-desktop') }}
          ðŸ“ Namespace: {{ elasticsearch_namespace }}

    - name: 2. Check for Elasticsearch Helm release in search namespace
      ansible.builtin.shell: helm list -n {{ elasticsearch_namespace }} | grep -w elasticsearch
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: helm_search_check
      changed_when: false
      ignore_errors: true

    - name: 3. Check for Elasticsearch Helm release in default namespace (legacy)
      ansible.builtin.shell: helm list -n default | grep -w elasticsearch
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: helm_default_check
      changed_when: false
      ignore_errors: true

    - name: 4. Remove Elasticsearch Helm release from search namespace
      ansible.builtin.command: helm uninstall elasticsearch -n {{ elasticsearch_namespace }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      when: helm_search_check.rc == 0
      changed_when: true
      ignore_errors: true

    - name: 5. Remove Elasticsearch Helm release from default namespace (legacy)
      ansible.builtin.command: helm uninstall elasticsearch -n default
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      when: helm_default_check.rc == 0
      changed_when: true
      ignore_errors: true

    - name: 6. Wait for Elasticsearch pods to terminate (Elastic chart)
      ansible.builtin.shell: kubectl get pods -n {{ elasticsearch_namespace }} -l {{ elasticsearch_pod_label_elastic }} --no-headers 2>/dev/null | wc -l
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: elastic_pods_count
      until: elastic_pods_count.stdout | int == 0
      retries: 20
      delay: 5
      changed_when: false
      ignore_errors: true

    - name: 7. Wait for Elasticsearch pods to terminate (Bitnami chart - legacy)
      ansible.builtin.shell: kubectl get pods -n default -l {{ elasticsearch_pod_label_bitnami }} --no-headers 2>/dev/null | wc -l
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: bitnami_pods_count
      until: bitnami_pods_count.stdout | int == 0
      retries: 20
      delay: 5
      changed_when: false
      ignore_errors: true

    - name: 8. Remove PVCs with Elastic chart labels
      ansible.builtin.shell: kubectl delete pvc -n {{ elasticsearch_namespace }} -l {{ elasticsearch_pod_label_elastic }} --ignore-not-found
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      changed_when: true
      ignore_errors: true

    - name: 9. Remove PVCs with Bitnami chart labels (legacy)
      ansible.builtin.shell: kubectl delete pvc -n default -l {{ elasticsearch_pod_label_bitnami }} --ignore-not-found
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      changed_when: true
      ignore_errors: true

    - name: 10. Display removal result
      ansible.builtin.debug:
        msg: |
          ===============================================
          Elasticsearch Removal Complete
          ===============================================

          âœ… Elasticsearch resources removed from:
          â€¢ Namespace: {{ elasticsearch_namespace }}
          â€¢ Legacy namespace: default (if existed)

          ===============================================
