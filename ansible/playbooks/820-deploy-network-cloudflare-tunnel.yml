---
# file: ansible/playbooks/820-deploy-network-cloudflare-tunnel.yml
# Description: Deploy Cloudflare tunnel to Kubernetes cluster (token-based)
#
# This playbook:
# 1. Validates prerequisites (kubeconfig, secrets)
# 2. Verifies CLOUDFLARE_TUNNEL_TOKEN is set and not a placeholder
# 3. Applies the static manifest (2 replicas of cloudflared)
# 4. Waits for pods to be running
# 5. Tests end-to-end connectivity through the tunnel
#
# Usage:
#   ansible-playbook playbooks/820-deploy-network-cloudflare-tunnel.yml

- name: Deploy Cloudflare tunnel to Kubernetes cluster
  hosts: localhost
  gather_facts: false
  vars:
    manifests_folder: "/mnt/urbalurbadisk/manifests"
    kubeconfig_file: "/mnt/urbalurbadisk/.uis.secrets/generated/kubeconfig/kubeconf-all"
    manifest_file: "820-cloudflare-tunnel-base.yaml"
    tunnel_namespace: "default"

  tasks:
    - name: "01 Verify kubeconfig file exists"
      ansible.builtin.stat:
        path: "{{ kubeconfig_file }}"
      register: kubeconfig_stat

    - name: "02 Fail if kubeconfig file does not exist"
      ansible.builtin.fail:
        msg: "Kubeconfig file not found at {{ kubeconfig_file }}"
      when: not kubeconfig_stat.stat.exists

    - name: "03 Retrieve secrets from urbalurba-secrets"
      kubernetes.core.k8s_info:
        kind: Secret
        name: urbalurba-secrets
        namespace: default
        kubeconfig: "{{ kubeconfig_file }}"
      register: urbalurba_secrets

    - name: "04 Fail if urbalurba-secrets not found"
      ansible.builtin.fail:
        msg: "urbalurba-secrets not found in default namespace. Run 'uis secrets apply' first."
      when: urbalurba_secrets.resources | length == 0

    - name: "05 Extract Cloudflare tunnel token and domain"
      ansible.builtin.set_fact:
        cf_tunnel_token: "{{ urbalurba_secrets.resources[0].data.CLOUDFLARE_TUNNEL_TOKEN | b64decode }}"
        cf_domain: "{{ urbalurba_secrets.resources[0].data.BASE_DOMAIN_CLOUDFLARE | default('') | b64decode | default('', true) }}"
      when: urbalurba_secrets.resources | length > 0

    - name: "06 Validate tunnel token is not a placeholder"
      ansible.builtin.fail:
        msg: |
          CLOUDFLARE_TUNNEL_TOKEN is still set to a placeholder value.

          To fix:
          1. Create a tunnel in the Cloudflare dashboard (Zero Trust > Networks > Tunnels)
          2. Copy the tunnel token
          3. Set CLOUDFLARE_TUNNEL_TOKEN in .uis.secrets/secrets-config/00-common-values.env.template
          4. Run: uis secrets generate && uis secrets apply
          5. Then: uis deploy cloudflare-tunnel
      when: >-
        cf_tunnel_token is not defined or
        cf_tunnel_token == "" or
        "your-cloudflare-tunnel-token" in cf_tunnel_token

    - name: "07 Verify manifest file exists"
      ansible.builtin.stat:
        path: "{{ manifests_folder }}/{{ manifest_file }}"
      register: manifest_stat

    - name: "08 Fail if manifest not found"
      ansible.builtin.fail:
        msg: "Manifest not found at {{ manifests_folder }}/{{ manifest_file }}"
      when: not manifest_stat.stat.exists

    - name: "09 Apply Cloudflare tunnel manifest"
      kubernetes.core.k8s:
        src: "{{ manifests_folder }}/{{ manifest_file }}"
        kubeconfig: "{{ kubeconfig_file }}"
        state: present

    - name: "10 Wait for cloudflared pods to appear"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ tunnel_namespace }}"
        label_selectors:
          - "app=cloudflared"
        kubeconfig: "{{ kubeconfig_file }}"
      register: cf_pods
      until:
        - cf_pods.resources | length > 0
      retries: 12
      delay: 5

    - name: "11 Wait for cloudflared pods to be running"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ tunnel_namespace }}"
        label_selectors:
          - "app=cloudflared"
        kubeconfig: "{{ kubeconfig_file }}"
      register: cf_pods_status
      until:
        - cf_pods_status.resources | length > 0
        - cf_pods_status.resources | map(attribute='status.phase') | list | select('equalto', 'Running') | list | length == cf_pods_status.resources | length
      retries: 24
      delay: 10

    - name: "12 Check for pods in error state"
      ansible.builtin.fail:
        msg: |
          Cloudflare tunnel pods failed to start.
          Pod statuses: {{ cf_pods_status.resources | map(attribute='status.phase') | list | join(', ') }}

          Common issues:
          - Invalid tunnel token (check Cloudflare dashboard)
          - Port 7844 blocked by corporate firewall
          - DNS resolution issues

          Check logs: kubectl logs -n default -l app=cloudflared --tail=50
      when:
        - cf_pods_status.resources | length > 0
        - cf_pods_status.resources | map(attribute='status.phase') | list | select('in', ['Failed', 'Error']) | list | length > 0

    - name: "13 Wait for tunnel to register with Cloudflare edge"
      ansible.builtin.pause:
        seconds: 15
        prompt: "Waiting for Cloudflare tunnel to register and DNS to stabilize..."

    - name: "14 Test Cloudflare tunnel end-to-end connectivity"
      ansible.builtin.uri:
        url: "https://{{ cf_domain }}"
        method: GET
        status_code: [200, 301, 302, 404]
        validate_certs: true
        timeout: 30
      register: tunnel_test
      retries: 12
      delay: 10
      until: tunnel_test.status is defined and tunnel_test.status in [200, 301, 302, 404]
      failed_when: false
      when: cf_domain != "" and "your-domain" not in cf_domain

    - name: "15 Final deployment summary"
      ansible.builtin.debug:
        msg:
          - "==================================================="
          - "Cloudflare Tunnel Deployment"
          - "==================================================="
          - ""
          - "Status: DEPLOYED"
          - "Pods: {{ cf_pods_status.resources | length }} running"
          - "Namespace: {{ tunnel_namespace }}"
          - "Domain: {{ cf_domain if cf_domain != '' and 'your-domain' not in cf_domain else 'not configured' }}"
          - "Connectivity: {{ 'PASS - HTTP ' + (tunnel_test.status | string) if tunnel_test.status is defined and tunnel_test.status in [200, 301, 302, 404] else 'SKIP - domain not configured or test failed' }}"
          - ""
          - "Cloudflare dashboard: Zero Trust > Networks > Tunnels"
          - ""
          - "To verify: uis cloudflare verify"
          - "To remove: uis undeploy cloudflare-tunnel"
          - "==================================================="
