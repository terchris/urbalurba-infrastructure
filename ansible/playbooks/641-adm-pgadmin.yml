---
# File: playbooks/641-adm-pgadmin.yml
# Description: Set up pgAdmin for PostgreSQL database administration
# Usage: ansible-playbook playbooks/641-adm-pgadmin.yml -e target_host="rancher-desktop"

- name: Set up pgAdmin for PostgreSQL Administration
  hosts: localhost
  gather_facts: false
  vars:
    manifests_folder: "/mnt/urbalurbadisk/manifests"
    merged_kubeconf_file: "/mnt/urbalurbadisk/.uis.secrets/generated/kubeconfig/kubeconf-all"
    pgadmin_namespace: "default"
    pgadmin_pod_label: "app.kubernetes.io/name=pgadmin4"
    pgadmin_service_name: "pgadmin-pgadmin4"
    pgadmin_secret: "urbalurba-secrets"
    pgadmin_username_key: "PGADMIN_DEFAULT_EMAIL"
    pgadmin_password_key: "PGADMIN_DEFAULT_PASSWORD"
    # pgadmin_configmap_file: "640-pgadmin-configmap.yaml" # Removed - no longer needed
    pgadmin_values_file: "641-adm-pgadmin.yaml"
    pgadmin_ingress_config_file: "741-pgadmin-ingressroute.yaml"

  tasks:
    - name: 1. Check if required variables are provided
      ansible.builtin.fail:
        msg: "The variable 'target_host' is mandatory. Use -e target_host=your_host_name to specify it."
      when: target_host is not defined
      ignore_errors: true

    - name: 2. Print playbook description
      ansible.builtin.debug:
        msg: >
          Setting up pgAdmin for PostgreSQL administration on Kubernetes cluster: {{ target_host }}
          with manifests from: {{ manifests_folder }}.
          Using namespace: {{ pgadmin_namespace }}

    - name: 3. Get pgAdmin credentials from Kubernetes secrets
      ansible.builtin.shell: |
        set -o pipefail
        kubectl get secret --namespace {{ pgadmin_namespace }} {{ pgadmin_secret }} \
        -o jsonpath="{.data.{{ pgadmin_username_key }}}" \
        --kubeconfig {{ merged_kubeconf_file }} | base64 -d
      args:
        executable: /bin/bash
      register: pgadmin_username
      changed_when: false

    - name: 4. Get pgAdmin password from Kubernetes secrets
      ansible.builtin.shell: |
        set -o pipefail
        kubectl get secret --namespace {{ pgadmin_namespace }} {{ pgadmin_secret }} \
        -o jsonpath="{.data.{{ pgadmin_password_key }}}" \
        --kubeconfig {{ merged_kubeconf_file }} | base64 -d
      args:
        executable: /bin/bash
      register: pgadmin_password
      changed_when: false

    - name: 5. Set pgAdmin credential facts
      ansible.builtin.set_fact:
        pgadmin_username_fact: "{{ pgadmin_username.stdout }}"
        pgadmin_password_fact: "{{ pgadmin_password.stdout }}"

    - name: 6. Debug pgAdmin credentials (masked)
      ansible.builtin.debug:
        msg:
          - "pgAdmin username: {{ pgadmin_username_fact }}"
          - "pgAdmin password: {{ pgadmin_password_fact | regex_replace('.', '*') }}"

    - name: 7. Get PostgreSQL password for pgpass file
      ansible.builtin.shell: |
        set -o pipefail
        kubectl get secret --namespace {{ pgadmin_namespace }} {{ pgadmin_secret }} \
        -o jsonpath="{.data.PGPASSWORD}" \
        --kubeconfig {{ merged_kubeconf_file }} | base64 -d
      args:
        executable: /bin/bash
      register: pg_password
      changed_when: false

    - name: 8. Create pgpass secret for auto-login
      kubernetes.core.k8s:
        kubeconfig: "{{ merged_kubeconf_file }}"
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: pgadmin-pgpass
            namespace: "{{ pgadmin_namespace }}"
          type: Opaque
          stringData:
            pgpassfile: "postgresql.default.svc.cluster.local:5432:*:postgres:{{ pg_password.stdout }}"

    - name: 9. Check existing Helm repositories
      ansible.builtin.command: helm repo list
      register: helm_repo_list
      changed_when: false

    - name: 10. Add required Helm repositories if missing
      kubernetes.core.helm_repository:
        name: "{{ item.name }}"
        repo_url: "{{ item.url }}"
      loop:
        - { name: 'runix', url: 'https://helm.runix.net' }
      when: item.name not in helm_repo_list.stdout

    - name: 11. Update Helm repositories
      ansible.builtin.command: helm repo update
      changed_when: false

    - name: 12. Deploy pgAdmin using Helm with centralized credentials
      ansible.builtin.command: >
        helm upgrade --install pgadmin runix/pgadmin4
        -f {{ manifests_folder }}/{{ pgadmin_values_file }}
        --set env.email="{{ pgadmin_username_fact | quote }}"
        --set env.password="{{ pgadmin_password_fact | quote }}"
        --namespace {{ pgadmin_namespace }}
        --create-namespace
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      changed_when: true

    - name: 13. Wait for pgAdmin pods to be ready (with progress indicators)
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ pgadmin_namespace }}"
        label_selectors:
          - "{{ pgadmin_pod_label }}"
      register: pgadmin_pods
      retries: 20
      delay: 15
      until: >
        pgadmin_pods.resources | length > 0 and
        pgadmin_pods.resources[0].status.phase == "Running"

    - name: 14. Wait for pgAdmin pods to be fully ready (1/1)
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ pgadmin_namespace }}"
        label_selectors:
          - "{{ pgadmin_pod_label }}"
      register: pgadmin_pods_ready
      retries: 30
      delay: 10
      until: >
        pgadmin_pods_ready.resources | length > 0 and
        pgadmin_pods_ready.resources[0].status.containerStatuses[0].ready == true

    - name: 15. Verify pgAdmin service is running
      ansible.builtin.command:
        cmd: >
          kubectl get svc {{ pgadmin_service_name }}
          --namespace {{ pgadmin_namespace }}
          --kubeconfig {{ merged_kubeconf_file }}
      register: pgadmin_svc
      changed_when: false

    - name: 16. Display pgAdmin service details
      ansible.builtin.debug:
        var: pgadmin_svc.stdout_lines

    - name: 17. Get pgAdmin pod name
      ansible.builtin.command:
        cmd: >
          kubectl get pods -n {{ pgadmin_namespace }}
          -l {{ pgadmin_pod_label }}
          -o jsonpath='{.items[0].metadata.name}'
          --kubeconfig {{ merged_kubeconf_file }}
      register: pgadmin_pod_name
      changed_when: false

    - name: 18. Test pgAdmin HTTP response from within cluster
      ansible.builtin.shell: |
        kubectl run curl-test --image=curlimages/curl --rm -i --restart=Never -n {{ pgadmin_namespace }} -- \
        curl -s -w "HTTP_CODE:%{http_code}" http://{{ pgadmin_service_name }}:80/
      register: pgadmin_http_response
      retries: 15
      delay: 15
      until: pgadmin_http_response.rc == 0 and (pgadmin_http_response.stdout.find('HTTP_CODE:200') != -1 or pgadmin_http_response.stdout.find('HTTP_CODE:302') != -1)

    - name: 19. Apply pgAdmin ingress configuration
      kubernetes.core.k8s:
        kubeconfig: "{{ merged_kubeconf_file }}"
        state: present
        src: "{{ manifests_folder }}/{{ pgadmin_ingress_config_file }}"
        namespace: "{{ pgadmin_namespace }}"

    - name: 20. Verify pgAdmin ingress is created
      kubernetes.core.k8s_info:
        api_version: traefik.io/v1alpha1
        kind: IngressRoute
        namespace: "{{ pgadmin_namespace }}"
        name: pgadmin
      register: ingress_check
      retries: 5
      delay: 2
      until: ingress_check.resources | length > 0

    - name: 21. Display final deployment status
      ansible.builtin.debug:
        msg:
          - "==============================================="
          - "ğŸš€ pgAdmin Deployment Status"
          - "==============================================="
          - ""
          - "âœ… SUCCESS - All components verified and running"
          - ""
          - "ğŸ”„ Status:"
          - "â€¢ Service connectivity: âœ… Internal cluster communication verified"
          - "â€¢ HTTP responding: âœ… pgAdmin web interface accessible"
          - "â€¢ IngressRoute: âœ… Traefik routing configured"
          - ""
          - "ğŸŒ Access Instructions:"
          - "â€¢ Port-forward: kubectl port-forward svc/{{ pgadmin_service_name }} 8080:80 -n {{ pgadmin_namespace }}"
          - "â€¢ Ingress: http://pgadmin.localhost"
          - "â€¢ Username: {{ pgadmin_username_fact }}"
          - "â€¢ Password: [configured from secrets]"
          - ""
          - "ğŸ”§ Troubleshooting:"
          - "â€¢ Check pod status: kubectl get pods -n {{ pgadmin_namespace }}"
          - "â€¢ View logs: kubectl logs -f {{ pgadmin_pod_name.stdout }} -n {{ pgadmin_namespace }}"
          - "==============================================="