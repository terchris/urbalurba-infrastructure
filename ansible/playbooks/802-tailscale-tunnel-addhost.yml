---
# file: playbooks/802-tailscale-tunnel-addhost.yml
# Description: Create a Tailscale ingress for a specific service
#
# This playbook creates a Tailscale ingress that exposes a service at:
# https://SERVICE.dog-pence.ts.net with public internet access via Funnel
#
# Usage:
#   ansible-playbook playbooks/802-tailscale-tunnel-addhost.yml \
#     -e service_name=whoami \
#     -e tailscale_domain=dog-pence.ts.net
#
# Optional parameters (have sensible defaults):
#     -e ingress_hostname=my-hostname
#
# Required parameters (passed via -e):
#   service_name: Name of the Kubernetes service to expose
#   tailscale_domain: Tailscale MagicDNS domain (e.g. dog-pence.ts.net)

- name: Create Tailscale ingress for service
  hosts: localhost
  gather_facts: false
  vars:
    kubeconfig_file: "/mnt/urbalurbadisk/.uis.secrets/generated/kubeconfig/kubeconf-all"
    ingress_namespace: "default"

  tasks:
    - name: "00 Set computed variable defaults"
      ansible.builtin.set_fact:
        ingress_hostname: "{{ ingress_hostname | default(service_name) }}"

    - name: "00a Set ingress name from hostname"
      ansible.builtin.set_fact:
        ingress_name: "{{ ingress_hostname }}-tailscale"

    - name: "01 Validate required parameters"
      ansible.builtin.fail:
        msg: "service_name is required. Usage: -e service_name=whoami"
      when: service_name is not defined or service_name == ""

    - name: "01a Validate Tailscale domain parameter"
      ansible.builtin.fail:
        msg: "tailscale_domain is required. Pass via -e tailscale_domain=your-domain.ts.net"
      when: tailscale_domain is not defined or tailscale_domain == ""

    - name: "02 Verify kubeconfig file exists"
      ansible.builtin.stat:
        path: "{{ kubeconfig_file }}"
      register: kubeconfig_stat

    - name: "03 Fail if kubeconfig file does not exist"
      ansible.builtin.fail:
        msg: "Kubeconfig file not found at {{ kubeconfig_file }}"
      when: not kubeconfig_stat.stat.exists

    - name: "04 Display ingress plan"
      ansible.builtin.debug:
        msg: |
          Creating Tailscale ingress for service '{{ service_name }}' in namespace '{{ ingress_namespace }}'
          Target URL: https://{{ ingress_hostname }}.{{ tailscale_domain }}
          Backend: {{ service_name }}:80

    - name: "06 Skip operator check if SKIP_OPERATOR_CHECK is set"
      ansible.builtin.set_fact:
        tailscale_operator_found: true
      when: SKIP_OPERATOR_CHECK is defined and SKIP_OPERATOR_CHECK == "true"

    - name: "06a Check if Tailscale operator is running (try app=operator)"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: tailscale
        label_selectors:
          - "app=operator"
        kubeconfig: "{{ kubeconfig_file }}"
      register: tailscale_operator_app
      failed_when: false
      when: SKIP_OPERATOR_CHECK is not defined or SKIP_OPERATOR_CHECK != "true"

    - name: "06b Check if Tailscale operator is running (try app.kubernetes.io/name=tailscale-operator)"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: tailscale
        label_selectors:
          - "app.kubernetes.io/name=tailscale-operator"
        kubeconfig: "{{ kubeconfig_file }}"
      register: tailscale_operator_helm
      failed_when: false
      when: SKIP_OPERATOR_CHECK is not defined or SKIP_OPERATOR_CHECK != "true"

    - name: "06c Check if Tailscale operator is running (try field selector)"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: tailscale
        field_selectors:
          - "status.phase=Running"
        kubeconfig: "{{ kubeconfig_file }}"
      register: tailscale_operator_pods
      failed_when: false
      when: SKIP_OPERATOR_CHECK is not defined or SKIP_OPERATOR_CHECK != "true"

    - name: "06d Set operator found flag based on detection results"
      ansible.builtin.set_fact:
        tailscale_operator_found: "{{ (tailscale_operator_app.resources | length > 0) or (tailscale_operator_helm.resources | length > 0) or (tailscale_operator_pods.resources | selectattr('metadata.name', 'search', 'operator') | list | length > 0) }}"
      when: SKIP_OPERATOR_CHECK is not defined or SKIP_OPERATOR_CHECK != "true"

    - name: "07 Fail if Tailscale operator is not running"
      ansible.builtin.fail:
        msg: |
          Tailscale operator not found in 'tailscale' namespace.
          Run ./802-tailscale-tunnel-deploy.sh first to deploy the operator.
      when: not tailscale_operator_found

    - name: "08 Check if ingress already exists"
      kubernetes.core.k8s_info:
        kind: Ingress
        name: "{{ ingress_name }}"
        namespace: "{{ ingress_namespace }}"
        kubeconfig: "{{ kubeconfig_file }}"
      register: existing_ingress

    - name: "09 Display existing ingress warning"
      ansible.builtin.debug:
        msg: |
          Ingress '{{ ingress_name }}' already exists in namespace '{{ ingress_namespace }}'.
          This will update the existing ingress configuration.
      when: existing_ingress.resources | length > 0

    - name: "10 Create Tailscale ingress manifest"
      kubernetes.core.k8s:
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: "{{ ingress_name }}"
            namespace: "{{ ingress_namespace }}"
            annotations:
              tailscale.com/funnel: "true"
              tailscale.com/tags: "tag:k8s-operator"
              tailscale.com/hostname: "{{ ingress_hostname }}"
              tailscale.com/expose-metrics: "true"
            labels:
              created-by: "tailscale-tunnel-addhost"
              service-name: "{{ service_name }}"
          spec:
            ingressClassName: tailscale
            defaultBackend:
              service:
                name: "{{ service_name }}"
                port:
                  number: 80
            tls:
              - hosts:
                  - "{{ ingress_hostname }}"
        kubeconfig: "{{ kubeconfig_file }}"
        state: present

    - name: "11 Wait for ingress to be assigned address"
      kubernetes.core.k8s_info:
        kind: Ingress
        name: "{{ ingress_name }}"
        namespace: "{{ ingress_namespace }}"
        kubeconfig: "{{ kubeconfig_file }}"
      register: ingress_status
      until:
        - ingress_status.resources | length > 0
        - ingress_status.resources[0].status.loadBalancer.ingress is defined
        - ingress_status.resources[0].status.loadBalancer.ingress | length > 0
      retries: 30
      delay: 5
      failed_when: false

    - name: "12 Get final ingress status"
      kubernetes.core.k8s_info:
        kind: Ingress
        name: "{{ ingress_name }}"
        namespace: "{{ ingress_namespace }}"
        kubeconfig: "{{ kubeconfig_file }}"
      register: final_ingress

    - name: "13 Extract actual FQDN from ingress status"
      ansible.builtin.set_fact:
        actual_fqdn: "{{ final_ingress.resources[0].status.loadBalancer.ingress[0].hostname | default(ingress_hostname + '.' + tailscale_domain) }}"
      when:
        - final_ingress.resources | length > 0
        - final_ingress.resources[0].status.loadBalancer.ingress is defined
        - final_ingress.resources[0].status.loadBalancer.ingress | length > 0

    - name: "13a Set fallback FQDN if status not available"
      ansible.builtin.set_fact:
        actual_fqdn: "{{ ingress_hostname }}.{{ tailscale_domain }}"
      when: actual_fqdn is not defined

    - name: "14 Display success message"
      ansible.builtin.debug:
        msg:
          - "Tailscale ingress created successfully!"
          - "Service: {{ service_name }}"
          - "Ingress: {{ ingress_name }}"
          - "URL: https://{{ actual_fqdn }}"
          - ""
          - "Note: DNS propagation may take 1-2 minutes"

    - name: "15 Wait for DNS propagation"
      ansible.builtin.pause:
        seconds: 10
        prompt: "Waiting for Tailscale DNS to stabilize..."

    - name: "16 Test service connectivity"
      ansible.builtin.uri:
        url: "https://{{ actual_fqdn }}"
        method: GET
        status_code: [200, 301, 302, 404]
        validate_certs: false
        timeout: 30
      register: connectivity_test
      retries: 6
      delay: 10
      until: connectivity_test.status is defined
      failed_when: false

    - name: "17 Display connectivity test results"
      ansible.builtin.debug:
        msg:
          - "Connectivity test results:"
          - "URL: https://{{ actual_fqdn }}"
          - "Status: {{ connectivity_test.status | default('Failed to connect') }}"
          - "{% if connectivity_test.status is defined %}Service is accessible via Tailscale Funnel!{% else %}Service not yet accessible (may need more time for DNS){% endif %}"

    - name: "18 Final summary"
      ansible.builtin.debug:
        msg:
          - "Tailscale ingress deployment complete!"
          - ""
          - "Your service is now accessible at:"
          - "  https://{{ actual_fqdn }}"
          - ""
          - "This URL is accessible from anywhere on the public internet."
          - "No Tailscale client needed for visitors."
