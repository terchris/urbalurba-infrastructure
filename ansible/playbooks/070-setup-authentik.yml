# file: ansible/playbooks/070-setup-authentik.yml
# Description:
# Deploy complete Authentik authentication infrastructure with forward auth integration
# Following the complete manual deployment guide with full dependency checking and verification
# - Prerequisites verification (PostgreSQL, Redis, Traefik, secrets)
# - Helm repository management with version validation
# - Database preparation using utility playbook
# - Blueprint deployment BEFORE Helm (critical for mounting)
# - Authentik server/worker deployment via Helm (v2025.8.1)
# - Forward auth middleware configuration
# - Whoami test application deployment and protection
# - Complete authentication flow testing and verification
# - Enhanced monitoring and error recovery
# - Post-deployment verification using verification playbook
#
# Prerequisites:
# - Kubernetes cluster with proper RBAC permissions
# - Generated secrets file at .uis.secrets/generated/kubernetes/kubernetes-secrets.yml
# - DNS resolution for *.localhost (for external testing)
#
# Note: Secrets are automatically applied at playbook start (creates namespace + secrets)
#
# Usage:
# ansible-playbook ansible/playbooks/070-setup-authentik.yml -e kube_context="rancher-desktop"
#   (add -e deploy_test_apps=false to skip test application deployment)

- name: Set up Authentik Authentication System on Kubernetes
  hosts: localhost
  gather_facts: false
  vars:
    manifests_folder: "/mnt/urbalurbadisk/manifests"
    merged_kubeconf_file: "/mnt/urbalurbadisk/kubeconfig/kubeconf-all"
    authentik_namespace: "authentik"
    default_namespace: "default"
    installation_timeout: 900  # 15 minutes timeout for installations
    pod_readiness_timeout: 600  # 10 minutes timeout for pod readiness
    
    # Helm chart references
    authentik_chart: "authentik/authentik"
    authentik_repo_url: "https://charts.goauthentik.io"
    authentik_version: "2025.8.1"
    
    # Manifest files (following manual deployment guide order)
    whoami_service_file: "{{ manifests_folder }}/070-whoami-service-and-deployment.yaml"
    whoami_public_ingress_file: "{{ manifests_folder }}/071-whoami-public-ingressroute.yaml"

    # Auth10 Templates (located in manifests folder)
    auth10_templates_folder: "/mnt/urbalurbadisk/manifests"
    service_protection_blueprint_file: "{{ manifests_folder }}/073-authentik-service-protection-blueprint.yaml"

    # Static blueprints (unchanged)
    test_users_groups_blueprint_file: "{{ manifests_folder }}/073-authentik-1-test-users-groups-blueprint.yaml"
    openwebui_blueprint_file: "{{ manifests_folder }}/073-authentik-2-openwebui-blueprint.yaml"
    app_slot1_blueprint_file: "{{ manifests_folder }}/073-authentik-3-app-slot1-blueprint.yaml"

    # Auth10 generated files (dynamic)
    authentik_helm_values_file: "{{ manifests_folder }}/075-authentik-config.yaml"
    service_protection_ingressroute_file: "{{ manifests_folder }}/078-service-protection-ingressroute.yaml"

    # Static middleware and routing files (unchanged)
    authentik_csp_middleware_file: "{{ manifests_folder }}/076-authentik-csp-middleware.yaml"
    authentik_ingressroute_file: "{{ manifests_folder }}/076-authentik-ingressroute.yaml"
    forward_auth_middleware_file: "{{ manifests_folder }}/077-authentik-forward-auth-middleware.yaml"

    # Auth10 configuration (loaded from Kubernetes secret)

    # Other playbooks
    verify_authentik_playbook: "/mnt/urbalurbadisk/ansible/playbooks/070-verify-authentik.yml"
    test_authentik_playbook: "/mnt/urbalurbadisk/ansible/playbooks/070-test-authentik-auth.yml"
    create_postgres_playbook: "/mnt/urbalurbadisk/ansible/playbooks/utility/u09-authentik-create-postgres.yml"

    # Secrets file (auto-applied at start to create namespace and credentials)
    secrets_file: "/mnt/urbalurbadisk/.uis.secrets/generated/kubernetes/kubernetes-secrets.yml"

  tasks:

    # Phase 1: Prerequisites Verification
    - name: "1. Display deployment initiation"
      ansible.builtin.debug:
        msg: |
          üöÄ Authentik Authentication System Deployment
          ===============================================
          üìù Target: {{ kube_context | default('default') }}

    - name: "1.5. Apply secrets file to create namespace and credentials"
      ansible.builtin.command: >
        kubectl apply -f {{ secrets_file }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: secrets_apply_result
      changed_when: "'created' in secrets_apply_result.stdout or 'configured' in secrets_apply_result.stdout"

    - name: "1.6. Display secrets application status"
      ansible.builtin.debug:
        msg: |
          ‚úÖ Secrets applied successfully
          üìÅ Source: {{ secrets_file }}
          üîß Created: authentik namespace and urbalurba-secrets
          üìã Output: {{ secrets_apply_result.stdout_lines | default([]) | select('search', 'authentik') | list }}

    - name: "2. Check if authentik namespace exists"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ authentik_namespace }}"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: namespace_check
      failed_when: namespace_check.resources | length == 0

    - name: "3. Verify authentik namespace is ready"
      ansible.builtin.debug:
        msg: "‚úÖ Authentik namespace '{{ authentik_namespace }}' is ready"

    - name: "4. Check urbalurba-secrets in authentik namespace"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: urbalurba-secrets
        namespace: "{{ authentik_namespace }}"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: authentik_secret_check
      failed_when: false

    - name: "5. Validate authentik secrets requirements"
      ansible.builtin.fail:
        msg: |
          ‚ùå Missing required secret configuration for Authentik!
      when: 
        - authentik_secret_check.resources | length == 0 or 
          'AUTHENTIK_SECRET_KEY' not in (authentik_secret_check.resources[0].data | default({})) or
          'AUTHENTIK_POSTGRESQL__PASSWORD' not in (authentik_secret_check.resources[0].data | default({}))

    - name: "6. Check PostgreSQL dependency"
      ansible.builtin.shell: |
        kubectl get pods -n {{ default_namespace }} | grep postgresql | grep Running
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: postgres_check
      failed_when: postgres_check.rc != 0
      changed_when: false

    - name: "7. Check Redis dependency"
      ansible.builtin.shell: |
        kubectl get pods -n {{ default_namespace }} | grep redis | grep Running
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: redis_check
      failed_when: redis_check.rc != 0
      changed_when: false

    - name: "8. Check Traefik dependency"
      ansible.builtin.shell: |
        kubectl get pods -A | grep traefik | grep Running
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: traefik_check
      failed_when: traefik_check.rc != 0
      changed_when: false

    - name: "9. Display dependency verification"
      ansible.builtin.debug:
        msg: |
          ‚úÖ All dependencies verified:
          ‚Ä¢ PostgreSQL: Running in {{ default_namespace }} namespace
          ‚Ä¢ Redis: Running in {{ default_namespace }} namespace  
          ‚Ä¢ Traefik: Running and available
          ‚Ä¢ Secrets: urbalurba-secrets exists in {{ authentik_namespace }} namespace

    # Phase 2: Helm Repository Management with Enhanced Validation
    - name: "10. Add Authentik Helm repository"
      kubernetes.core.helm_repository:
        name: "authentik"
        repo_url: "{{ authentik_repo_url }}"
      register: helm_repo_result

    - name: "11. Update Helm repositories"
      ansible.builtin.command: helm repo update
      changed_when: false

    - name: "12. Verify Authentik chart availability"
      ansible.builtin.command: helm search repo authentik/authentik
      register: chart_search
      changed_when: false

    - name: "12.1. Verify Authentik chart version compatibility"
      ansible.builtin.shell: |
        helm search repo authentik/authentik --version {{ authentik_version }}
      register: version_check
      failed_when: version_check.rc != 0
      changed_when: false

    - name: "13. Display Helm setup status"
      ansible.builtin.debug:
        msg: |
          ‚úÖ Helm repository setup complete
          üì¶ Available chart: {{ chart_search.stdout_lines[1] if chart_search.stdout_lines | length > 1 else 'authentik/authentik found' }}
          üîñ Target version: {{ authentik_version }} {{ '‚úÖ Available' if version_check.rc == 0 else '‚ùå Not available' }}

    # Phase 3: Whoami Service Deployment with Enhanced Error Handling
    - name: "14. Deploy whoami service and deployment"
      ansible.builtin.command: >
        kubectl apply -f {{ whoami_service_file }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: whoami_deploy_result
      changed_when: true

    - name: "15. Wait for whoami pod to be ready with retry"
      ansible.builtin.shell: |
        kubectl wait --for=condition=ready pod -l app=whoami --timeout=60s -n {{ default_namespace }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: whoami_wait_result
      retries: 3
      delay: 15
      changed_when: false
      until: whoami_wait_result.rc == 0

    - name: "16. Test whoami service direct access with enhanced cleanup"
      block:
        - name: "16.1. Start port-forward in background"
          ansible.builtin.shell: |
            kubectl port-forward svc/whoami 8081:80 -n {{ default_namespace }} > /tmp/pf-whoami.log 2>&1 &
            PF_PID=$!
            echo $PF_PID > /tmp/pf-whoami.pid
            sleep 3
          environment:
            KUBECONFIG: "{{ merged_kubeconf_file }}"
          
        - name: "16.2. Test the service"
          ansible.builtin.shell: |
            curl -s --max-time 10 http://localhost:8081 || echo "CURL_FAILED"
          register: whoami_direct_test
          failed_when: false
          changed_when: false
          
      always:
        - name: "16.3. Ensure port-forward cleanup"
          ansible.builtin.shell: |
            if [ -f /tmp/pf-whoami.pid ]; then
              kill $(cat /tmp/pf-whoami.pid) || true
              rm -f /tmp/pf-whoami.pid
            fi
            pkill -f "kubectl port-forward.*whoami" || true
          changed_when: false
          failed_when: false

    - name: "17. Verify whoami service is responding"
      ansible.builtin.fail:
        msg: |
          ‚ùå Whoami service test failed!
          Service is not responding properly.
          Troubleshooting: kubectl get pods -l app=whoami -n {{ default_namespace }}
      when: "'Hostname:' not in whoami_direct_test.stdout"

    - name: "18. Display whoami direct test success"
      ansible.builtin.debug:
        msg: "‚úÖ Whoami Direct Service Test: PASS - Service responding"

    - name: "19. Deploy whoami public route"
      ansible.builtin.command: >
        kubectl apply -f {{ whoami_public_ingress_file }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: whoami_public_result
      changed_when: true

    - name: "20. Wait for IngressRoute to be ready"
      ansible.builtin.shell: |
        kubectl wait --for=condition=Ready ingressroute whoami-public --timeout=30s -n {{ default_namespace }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: ingress_wait_result
      failed_when: false
      changed_when: false

    - name: "21. Test whoami public access via cluster"
      ansible.builtin.shell: |
        kubectl run curl-test-public --image=curlimages/curl --rm -i --restart=Never --command -- \
          curl -s -H "Host: whoami-public.localhost" -w "HTTP_STATUS:%{http_code}" \
          http://traefik.kube-system.svc.cluster.local
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: whoami_public_test
      failed_when: false
      changed_when: false

    - name: "22. Verify whoami public route is working"
      ansible.builtin.fail:
        msg: |
          ‚ùå Whoami public route test failed!
          Public route is not accessible through Traefik.
          Troubleshooting: kubectl get ingressroute whoami-public -n {{ default_namespace }}
      when: "'200' not in whoami_public_test.stdout"

    - name: "23. Display whoami public test success"
      ansible.builtin.debug:
        msg: |
          ‚úÖ Whoami Public Route Test: PASS - Route accessible via Traefik
          Note: External access from host requires DNS resolution for *.localhost

    - name: "24. Display whoami deployment status"
      ansible.builtin.debug:
        msg: |
          ‚úÖ Whoami test application deployed
          üåê Public route: http://whoami-public.localhost
          üß™ Ready for authentication integration

    # Phase 3.5: Auth10 Template Rendering (Dynamic Configuration Generation)
    - name: "24.1. Get Auth10 configuration from Kubernetes secret"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: urbalurba-secrets
        namespace: default
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: auth10_secret

    - name: "24.2. Parse Auth10 domains and services from secret"
      ansible.builtin.set_fact:
        auth10_config:
          domains: "{{ auth10_secret.resources[0].data.AUTH10_DOMAINS | b64decode | from_yaml }}"
          protected_services: "{{ auth10_secret.resources[0].data.AUTH10_PROTECTED_SERVICES | b64decode | from_yaml }}"

    - name: "24.3. Display Auth10 configuration loaded"
      ansible.builtin.debug:
        msg: |
          ‚úÖ Auth10 Configuration Loaded from Kubernetes Secret
          üåê Domains: {{ auth10_config.domains.keys() | list }}
          üõ°Ô∏è Protected services: {{ auth10_config.protected_services | map(attribute='name') | list }}

    - name: "24.4. Render Auth10 service protection blueprint"
      ansible.builtin.template:
        src: "{{ auth10_templates_folder }}/073-authentik-service-protection-blueprint.yaml.j2"
        dest: "{{ service_protection_blueprint_file }}"
        mode: '0644'
      vars:
        domains: "{{ auth10_config.domains }}"
        protected_services: "{{ auth10_config.protected_services }}"
      register: blueprint_generation

    - name: "24.5. Render Auth10 Authentik configuration"
      ansible.builtin.template:
        src: "{{ auth10_templates_folder }}/075-authentik-config.yaml.j2"
        dest: "{{ authentik_helm_values_file }}"
        mode: '0644'
      vars:
        domains: "{{ auth10_config.domains }}"
        protected_services: "{{ auth10_config.protected_services }}"
      register: config_generation

    - name: "24.6. Render Auth10 service protection IngressRoute"
      ansible.builtin.template:
        src: "{{ auth10_templates_folder }}/078-service-protection-ingressroute.yaml.j2"
        dest: "{{ service_protection_ingressroute_file }}"
        mode: '0644'
      vars:
        domains: "{{ auth10_config.domains }}"
        protected_services: "{{ auth10_config.protected_services }}"

    - name: "24.7. Render Auth10 Authentik IngressRoute"
      ansible.builtin.template:
        src: "{{ auth10_templates_folder }}/076-authentik-ingressroute.yaml.j2"
        dest: "{{ authentik_ingressroute_file }}"
        mode: '0644'
      vars:
        domains: "{{ auth10_config.domains }}"
      register: ingressroute_generation

    - name: "24.8. Display Auth10 template rendering status"
      ansible.builtin.debug:
        msg: |
          ‚úÖ Auth10 Templates Rendered Successfully
          üìù Generated files:
          ‚Ä¢ Service protection blueprint: {{ service_protection_blueprint_file }}
          ‚Ä¢ Authentik configuration: {{ authentik_helm_values_file }}
          ‚Ä¢ Service protection IngressRoute: {{ service_protection_ingressroute_file }}
          ‚Ä¢ Authentik IngressRoute: {{ authentik_ingressroute_file }}
          üéØ Dynamic configuration: {{ auth10_config.protected_services | length }} services across {{ auth10_config.domains.keys() | list | length }} domains

    # Phase 4: Blueprint Deployment (CRITICAL - must be before Helm)
    - name: "25. Deploy Auth10 service protection blueprint BEFORE Helm deployment"
      ansible.builtin.command: >
        kubectl apply -f {{ service_protection_blueprint_file }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: service_protection_blueprint_deploy_result
      changed_when: true

    - name: "26. Verify blueprint ConfigMap exists before Helm"
      ansible.builtin.shell: |
        kubectl get configmap -n {{ authentik_namespace }} | grep blueprint
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: blueprint_verify
      changed_when: false

    - name: "27. Display blueprint pre-deployment status"
      ansible.builtin.debug:
        msg: |
          ‚úÖ Blueprint ConfigMap deployed BEFORE Helm installation
          üìù This ensures proper mounting during pod creation
          üîß Blueprint status: {{ blueprint_verify.stdout if blueprint_verify.stdout else 'ConfigMap ready' }}

    - name: "27.1. Deploy test users and groups blueprint"
      ansible.builtin.command: >
        kubectl apply -f {{ test_users_groups_blueprint_file }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: test_users_groups_blueprint_result
      changed_when: true

    - name: "27.2. Get OAuth credentials from secrets"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: urbalurba-secrets
        namespace: ai
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: oauth_secrets

    - name: "27.2.1. Extract OAuth credentials from secret data"
      ansible.builtin.set_fact:
        openwebui_oauth_client_id: "{{ oauth_secrets.resources[0].data.OPENWEBUI_OAUTH_CLIENT_ID | b64decode }}"
        openwebui_oauth_client_secret: "{{ oauth_secrets.resources[0].data.OPENWEBUI_OAUTH_CLIENT_SECRET | b64decode }}"
        openwebui_oauth_redirect_uri: "{{ oauth_secrets.resources[0].data.OPENWEBUI_OPENID_REDIRECT_URI | b64decode }}"
      when: oauth_secrets.resources[0].data is defined

    - name: "27.2.1.1. Extract OAuth credentials from secret stringData (fallback)"
      ansible.builtin.set_fact:
        openwebui_oauth_client_id: "{{ oauth_secrets.resources[0].stringData.OPENWEBUI_OAUTH_CLIENT_ID }}"
        openwebui_oauth_client_secret: "{{ oauth_secrets.resources[0].stringData.OPENWEBUI_OAUTH_CLIENT_SECRET }}"
        openwebui_oauth_redirect_uri: "{{ oauth_secrets.resources[0].stringData.OPENWEBUI_OPENID_REDIRECT_URI }}"
      when: oauth_secrets.resources[0].stringData is defined

    - name: "27.2.2. Generate OpenWebUI blueprint from template and secrets"
      ansible.builtin.template:
        src: "{{ manifests_folder }}/073-authentik-2-openwebui-blueprint.yaml.j2"
        dest: "{{ openwebui_blueprint_file }}"
        mode: '0644'
      register: openwebui_blueprint_generation
      changed_when: true

    - name: "27.2.3. Deploy generated OpenWebUI OAuth2/OIDC blueprint"
      ansible.builtin.command: >
        kubectl apply -f {{ openwebui_blueprint_file }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: openwebui_blueprint_result
      changed_when: true

    - name: "27.3. Deploy app slot 1 blueprint"
      ansible.builtin.command: >
        kubectl apply -f {{ app_slot1_blueprint_file }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: app_slot1_blueprint_result
      changed_when: true

    - name: "27.4. Verify all blueprints are deployed"
      ansible.builtin.shell: |
        kubectl get configmap -n {{ authentik_namespace }} | grep blueprint
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: all_blueprints_verify
      changed_when: false

    - name: "27.5. Display all blueprints deployment status"
      ansible.builtin.debug:
        msg: |
          ‚úÖ All Blueprint ConfigMaps deployed BEFORE Helm installation
          üìù Blueprints deployed:
          ‚Ä¢ service-protection-blueprint (Auth10 generated - multi-domain service protection)
          ‚Ä¢ test-users-groups-blueprint (test users and groups)
          ‚Ä¢ openwebui-blueprint (OpenWebUI OAuth2/OIDC)
          ‚Ä¢ app-slot1-blueprint (expansion slot for future apps)
          üéØ Auth10 Features: Dynamic multi-domain authentication for {{ auth10_config.protected_services | length }} services
          üîß Total blueprints: {{ all_blueprints_verify.stdout_lines | length if all_blueprints_verify.stdout_lines else '4' }}
          üìã Blueprint status: {{ all_blueprints_verify.stdout if all_blueprints_verify.stdout else 'All ConfigMaps ready' }}

    # Phase 5: Database Setup
    - name: "28. Setup Authentik PostgreSQL database"
      ansible.builtin.command: >
        ansible-playbook {{ create_postgres_playbook }}
        -e operation=create
        -e kube_context={{ kube_context | default('rancher-desktop') }}
      register: postgres_setup_result
      failed_when: false
      changed_when: true

    - name: "29. Display database setup completion"
      ansible.builtin.debug:
        msg: |
          üìä PostgreSQL Database Setup: {{ 'COMPLETED' if postgres_setup_result.rc == 0 else 'FAILED' }}
          Exit Code: {{ postgres_setup_result.rc }}
          {% if postgres_setup_result.rc == 0 %}
          ‚úÖ Authentik PostgreSQL database setup completed
          üìä Database: authentik (with full permissions)
          üë§ User: authentik (with CREATEDB privilege)
          üîê Compatible with PostgreSQL 15+ and Django migrations
          {% else %}
          ‚ùå Database setup failed - cannot continue without database
          {% endif %}

    - name: "29.1. Fail if database setup failed"
      ansible.builtin.fail:
        msg: |
          ‚ùå Authentik PostgreSQL database setup failed (exit code {{ postgres_setup_result.rc }}).
          Without the 'authentik' database and user, Authentik pods will crash-loop.

          Debug: Run manually inside the container:
            ansible-playbook /mnt/urbalurbadisk/ansible/playbooks/utility/u09-authentik-create-postgres.yml -e operation=create -v
      when: postgres_setup_result.rc != 0

    # Phase 6: Authentik Deployment via Helm with Enhanced Monitoring
    - name: "30. Deploy Authentik via Helm (Helm version: {{ authentik_version }})"
      ansible.builtin.command: >
        helm upgrade --install authentik {{ authentik_chart }}
        -f {{ authentik_helm_values_file }}
        --namespace {{ authentik_namespace }}
        --version {{ authentik_version }}
        --timeout {{ installation_timeout }}s
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: authentik_helm_result
      changed_when: true

    - name: "30.1. Verify Helm deployment status"
      ansible.builtin.command: >
        helm status authentik -n {{ authentik_namespace }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: helm_status
      changed_when: false

    - name: "31. Wait for Authentik server pods to be ready with enhanced retry"
      ansible.builtin.shell: |
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=authentik,app.kubernetes.io/component=server -n {{ authentik_namespace }} --timeout={{ pod_readiness_timeout }}s
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: server_wait_result
      retries: 3
      delay: 30
      changed_when: false
      until: server_wait_result.rc == 0

    - name: "32. Wait for Authentik worker pods to be ready with enhanced retry"
      ansible.builtin.shell: |
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=authentik,app.kubernetes.io/component=worker -n {{ authentik_namespace }} --timeout={{ pod_readiness_timeout }}s
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: worker_wait_result
      retries: 3
      delay: 30
      changed_when: false
      until: worker_wait_result.rc == 0

    - name: "32.1. Verify blueprints were processed in logs"
      ansible.builtin.shell: |
        kubectl logs -n {{ authentik_namespace }} deployment/authentik-server --tail=200 | grep -i blueprint || echo "No blueprint logs found yet"
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: blueprint_logs
      changed_when: false
      failed_when: false

    - name: "32.2. Check for specific blueprint processing in logs"
      ansible.builtin.shell: |
        kubectl logs -n {{ authentik_namespace }} deployment/authentik-server --tail=200 | grep -E "(openwebui|users-groups|whoami)" || echo "No specific blueprint logs found yet"
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: specific_blueprint_logs
      changed_when: false
      failed_when: false

    - name: "33. Give Authentik time (60 seconds) to process blueprints"
      ansible.builtin.pause:
        seconds: 60
        prompt: "Waiting for Authentik to process blueprints and initialize..."

    # Phase 6.1: Deploy CSP Middleware and Authentik IngressRoute (CRITICAL - required for UI access)
    - name: "34. Deploy Authentik CSP middleware for mixed content resolution"
      ansible.builtin.command: >
        kubectl apply -f {{ authentik_csp_middleware_file }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: authentik_csp_middleware_result
      changed_when: true

    - name: "35. Deploy Auth10 Authentik IngressRoute (unified localhost + external domains)"
      ansible.builtin.command: >
        kubectl apply -f {{ authentik_ingressroute_file }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: authentik_ingressroute_result
      changed_when: true

    - name: "36. Wait for Authentik IngressRoutes to be ready"
      ansible.builtin.shell: |
        kubectl wait --for=condition=Ready ingressroute authentik-server --timeout=60s -n {{ authentik_namespace }} && \
        kubectl wait --for=condition=Ready ingressroute authentik-server-localhost --timeout=60s -n {{ authentik_namespace }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: authentik_ingressroute_wait
      failed_when: false
      changed_when: false

    - name: "37. Test Authentik UI accessibility via cluster"
      ansible.builtin.shell: |
        kubectl run curl-test-authentik --image=curlimages/curl --rm -i --restart=Never --command -- \
          curl -s -H "Host: authentik.localhost" -w "HTTP_STATUS:%{http_code}" \
          http://traefik.kube-system.svc.cluster.local
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: authentik_ui_test
      failed_when: false
      changed_when: false

    - name: "38. Verify Authentik UI is accessible"
      ansible.builtin.fail:
        msg: |
          ‚ùå Authentik UI accessibility test failed!
          Authentik may not be ready or routing is not configured.
          Troubleshooting: kubectl get pods -n {{ authentik_namespace }}
      when: "'200' not in authentik_ui_test.stdout and '302' not in authentik_ui_test.stdout"

    - name: "39. Display Authentik accessibility test results"
      ansible.builtin.debug:
        msg: |
          ‚úÖ Authentik UI Test: PASS - Accessible via Traefik
          Status: {{ 'Redirect (302)' if '302' in authentik_ui_test.stdout else 'Direct (200)' if '200' in authentik_ui_test.stdout else 'Unknown' }}
          Note: External access from host requires DNS resolution for *.localhost

    - name: "40. Display Authentik deployment status"
      ansible.builtin.debug:
        msg: |
          ‚úÖ Authentik server and worker pods are running
          üìù Blueprint processing: {{ 'Found in logs' if 'blueprint' in blueprint_logs.stdout.lower() else 'Completed or initializing' }}
          üìã Specific blueprints: {{ 'Found references' if specific_blueprint_logs.stdout and 'No specific blueprint logs found yet' not in specific_blueprint_logs.stdout else 'Processing or completed' }}
          üîß IngressRoutes deployed, ready for forward authentication setup

    - name: "41. Test Authentik access via IngressRoute"
      ansible.builtin.shell: |
        kubectl run curl-test-authentik-ingressroute --image=curlimages/curl --rm -i --restart=Never --command -- \
          curl -s -H "Host: authentik.localhost" -w "HTTP_STATUS:%{http_code}" \
          http://traefik.kube-system.svc.cluster.local
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: authentik_ingressroute_test
      failed_when: false
      changed_when: false

    - name: "42. Verify Authentik IngressRoute is working"
      ansible.builtin.fail:
        msg: |
          ‚ùå Authentik IngressRoute test failed!
          Expected HTTP 200 or 302, but got different response.
          Troubleshooting: kubectl get ingressroute authentik-server -n {{ authentik_namespace }}
      when: "'200' not in authentik_ingressroute_test.stdout and '302' not in authentik_ingressroute_test.stdout"

    - name: "43. Display Authentik IngressRoute deployment status"
      ansible.builtin.debug:
        msg: |
          ‚úÖ Authentik IngressRoute deployed successfully
          üåê Pattern: HostRegexp(`authentik\\..+`) for multi-domain support
          üîí CSP Middleware: {{ 'Deployed' if authentik_csp_middleware_result is succeeded else 'Check deployment' }} (fixes mixed content for external domains)
          üîó Access: http://authentik.localhost (external) + internal service discovery
          üìä Status: {{ 'SUCCESS (200/302)' if '200' in authentik_ingressroute_test.stdout or '302' in authentik_ingressroute_test.stdout else 'NEEDS_REVIEW' }}
          üöÄ Ready for OAuth integration and CoreDNS resolution

    - name: "44. Run comprehensive deployment verification"
      ansible.builtin.command: >
        ansible-playbook {{ verify_authentik_playbook }}
        -e app_name=whoami
        -e kube_context={{ kube_context | default('rancher-desktop') }}
      register: verification_result
      failed_when: false
      changed_when: false

    - name: "45. Display verification results"
      ansible.builtin.debug:
        msg: |
          üîç Deployment Verification Results:
          Exit Code: {{ verification_result.rc }}
          Status: {{ 'PASSED' if verification_result.rc == 0 else 'NEEDS REVIEW' }}
          {% if verification_result.rc != 0 %}
          Note: Verification may fail during initial deployment while services are starting.
          This is normal and doesn't indicate deployment failure.
          {% endif %}

    # Phase 7: Forward Authentication Setup
    - name: "46. Deploy forward auth middleware"
      ansible.builtin.command: >
        kubectl apply -f {{ forward_auth_middleware_file }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: middleware_result
      changed_when: true

    - name: "46.5. Remove standard whoami Ingress (conflicts with protected IngressRoute)"
      ansible.builtin.shell: |
        kubectl delete ingress whoami -n {{ default_namespace }} --ignore-not-found=true
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      changed_when: false

    - name: "47. Deploy Auth10 service protection IngressRoute"
      ansible.builtin.command: >
        kubectl apply -f {{ service_protection_ingressroute_file }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: protected_route_result
      changed_when: true

    - name: "48. Verify middleware deployment"
      ansible.builtin.shell: |
        kubectl get middleware -n {{ default_namespace }} | grep authentik-forward-auth
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: middleware_check
      changed_when: false

    - name: "49. Wait for middleware to propagate"
      ansible.builtin.shell: |
        kubectl wait --for=condition=Ready ingressroute whoami-protected --timeout=30s -n {{ default_namespace }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: protected_ingress_wait
      failed_when: false
      changed_when: false

    - name: "50. Test whoami authentication requirement via cluster"
      ansible.builtin.shell: |
        kubectl run curl-test-auth --image=curlimages/curl --rm -i --restart=Never --command -- \
          curl -s -H "Host: whoami.localhost" -w "HTTP_STATUS:%{http_code}" \
          http://traefik.kube-system.svc.cluster.local
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: whoami_auth_test
      failed_when: false
      changed_when: false

    - name: "51. Test cluster-internal routing"
      ansible.builtin.shell: |
        kubectl run curl-test-auth-internal --image=curlimages/curl --rm -i --restart=Never --command -- \
          curl -s -H "Host: whoami.localhost" -w "HTTP_STATUS:%{http_code}" \
          http://traefik.kube-system.svc.cluster.local
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: whoami_internal_auth_test
      failed_when: false
      changed_when: false

    - name: "52. Verify authentication flow is working"
      ansible.builtin.fail:
        msg: |
          ‚ùå Authentication flow test failed!
          Expected 302 redirect to Authentik, but got different response.
          Troubleshooting: 
          - kubectl get middleware authentik-forward-auth -n {{ default_namespace }}
          - kubectl get ingressroute whoami-protected -n {{ default_namespace }}
      when: "'302' not in whoami_auth_test.stdout and '302' not in whoami_internal_auth_test.stdout"

    - name: "53. Display authentication test results"
      ansible.builtin.debug:
        msg: |
          ‚úÖ Authentication Flow Tests: PASS
          External Test: {{ 'REDIRECT (302)' if '302' in whoami_auth_test.stdout else 'NO_REDIRECT' }}
          Internal Test: {{ 'REDIRECT (302)' if '302' in whoami_internal_auth_test.stdout else 'NO_REDIRECT' }}
          
          Expected: 302 redirect to Authentik login (indicates auth working)
          Note: External access from host requires DNS resolution for *.localhost

    - name: "54. Display forward auth setup status"
      ansible.builtin.debug:
        msg: |
          ‚úÖ Forward authentication configured
          üîß Middleware: {{ middleware_check.stdout if middleware_check.stdout else 'authentik-forward-auth deployed' }}
          üõ°Ô∏è Protected route: http://whoami.localhost (requires authentication)
          üåê Public route: http://whoami-public.localhost (direct access)

    # Phase 7.5: End-to-End Authentication Tests
    - name: "54.5. Run end-to-end authentication tests"
      ansible.builtin.command: >
        ansible-playbook {{ test_authentik_playbook }}
        -e kube_context={{ kube_context | default('rancher-desktop') }}
      register: auth_test_result
      failed_when: false
      changed_when: false

    - name: "54.6. Display end-to-end test results"
      ansible.builtin.debug:
        msg: |
          üß™ End-to-End Auth Tests: {{ 'PASSED' if auth_test_result.rc == 0 else 'NEEDS REVIEW' }}
          Exit Code: {{ auth_test_result.rc }}
          {% if auth_test_result.rc != 0 %}
          Note: Some tests may fail if blueprints are still processing.
          Re-run independently: ansible-playbook {{ test_authentik_playbook }}
          {% endif %}

    # Phase 8: Final Status and Enhanced Summary
    - name: "55. Get final pod status"
      ansible.builtin.shell: |
        kubectl get pods -n {{ authentik_namespace }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: final_pods
      changed_when: false

    - name: "55.1. Get detailed pod status with conditions"
      ansible.builtin.shell: |
        kubectl get pods -n {{ authentik_namespace }} -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.phase}{"\t"}{.status.conditions[?(@.type=="Ready")].status}{"\n"}{end}'
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: detailed_pod_status
      changed_when: false

    - name: "56. Count running pods for success determination"
      ansible.builtin.shell: |
        kubectl get pods -n {{ authentik_namespace }} | grep -v NAME | grep -c Running || echo "0"
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: running_pods_count
      changed_when: false

    - name: "56.1. Check resource usage"
      ansible.builtin.shell: |
        kubectl top pods -n {{ authentik_namespace }} || echo "Metrics not available"
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: resource_usage
      changed_when: false
      failed_when: false

    - name: "57. Determine overall installation success"
      ansible.builtin.set_fact:
        installation_successful: "{{ (running_pods_count.stdout | int >= 2) }}"

    - name: "58. Display comprehensive final status with enhanced monitoring"
      ansible.builtin.debug:
        msg:
          - "==============================================="
          - "üöÄ Authentik Authentication System Status"
          - "==============================================="
          - ""
          - "{{ '‚úÖ SUCCESS - All components are running' if installation_successful else '‚ö†Ô∏è PARTIAL SUCCESS - Some components may not be running yet' }}"
          - ""
          - "üì¶ Components deployed (with Auth10 integration):"
          - "‚Ä¢ Step 1: Prerequisites verified (PostgreSQL, Redis, Traefik)"
          - "‚Ä¢ Step 2: Whoami service deployed"
          - "‚Ä¢ Step 3: Auth10 template rendering (dynamic configuration)"
          - "‚Ä¢ Step 4: Blueprints deployed BEFORE Helm (critical)"
          - "  - service-protection-blueprint (Auth10 generated - multi-domain)"
          - "  - test-users-groups-blueprint (test users and groups)"
          - "  - openwebui-blueprint (OpenWebUI OAuth2/OIDC)"
          - "  - app-slot1-blueprint (expansion slot for future apps)"
          - "‚Ä¢ Step 5: PostgreSQL database created (authentik)"
          - "‚Ä¢ Step 6: Authentik server/worker deployed (Helm {{ authentik_version }})"
          - "‚Ä¢ Step 7: Authentik IngressRoute deployed (CRITICAL for access)"
          - "‚Ä¢ Step 8: Forward auth middleware configured"
          - "‚Ä¢ Step 9: Auth10 service protection routes established"
          - "‚Ä¢ Step 10: Verification completed"
          - ""
          - "üîÑ Status:"
          - "‚Ä¢ Running pods: {{ running_pods_count.stdout }} / 2+"
          - "‚Ä¢ Authentication flow: Ready for testing"
          - "‚Ä¢ IngressRoute: {{ 'Deployed with HostRegexp' if authentik_ingressroute_result is succeeded else 'Check deployment' }}"
          - "‚Ä¢ Blueprint processing: {{ 'Found in logs' if 'blueprint' in blueprint_logs.stdout.lower() else 'Completed' }}"
          - "‚Ä¢ Specific blueprints: {{ 'Found references' if specific_blueprint_logs.stdout and 'No specific blueprint logs found yet' not in specific_blueprint_logs.stdout else 'Processing or completed' }}"
          - "‚Ä¢ Helm status: {{ 'Deployed' if helm_status.rc == 0 else 'Check required' }}"
          - ""
          - "üìä Resource Usage:"
          - "{{ resource_usage.stdout if resource_usage.stdout and 'not available' not in resource_usage.stdout else '‚Ä¢ Metrics not available (normal for some clusters)' }}"
          - ""
          - "üåê Access Information:"
          - "‚Ä¢ Admin Interface: http://authentik.localhost/if/admin/"
          - "‚Ä¢ Default Login: admin@urbalurba.local"
          - "‚Ä¢ Default Password: SecretPassword1"
          - ""
          - "üß™ Test Auth10 Multi-Domain Authentication:"
          - "üåê Localhost: http://whoami.localhost (development)"
          - "üîí External domains: Automatically configured for {% for domain_type, domain_config in auth10_config.domains.items() %}{% if domain_config.enabled %}{{ domain_config.protocol }}://whoami.{{ domain_config.base_domain }}{% if not loop.last %}, {% endif %}{% endif %}{% endfor %}"
          - "üìã Flow: All domains ‚Üí redirect to authentik.localhost ‚Üí login ‚Üí redirect back"
          - "‚úÖ Auth10 benefit: Add new services by updating kubernetes-secrets.yml only"
          - ""
          - "üë• Test Users Available (Password: Password123):"
          - "‚Ä¢ it1@urbalurba.no (IT Bruker 1) - Group: √òk.Adm IT"
          - "‚Ä¢ it2@urbalurba.no (IT Bruker 2) - Group: √òk.Adm IT"
          - "‚Ä¢ ok1@urbalurba.no (√òkonomi Bruker 1) - Group: √òk.Adm"
          - "‚Ä¢ ok2@urbalurba.no (√òkonomi Bruker 2) - Group: √òk.Adm"
          - ""
          - "ü§ñ OpenWebUI OAuth2/OIDC Integration:"
          - "‚Ä¢ Application: openwebui-dev"
          - "‚Ä¢ Provider: openwebui-dev-provider"
          - "‚Ä¢ Callback URL: http://openwebui.localhost/oauth/oidc/callback"
          - "‚Ä¢ Client ID: 1c37QuM0qm0g2BzdLbhppVwmUwUUrhmB83e9inEe"
          - ""
          - "üîß Verification Commands:"
          - "‚Ä¢ Check pods: kubectl get pods -n {{ authentik_namespace }}"
          - "‚Ä¢ Check services: kubectl get svc -n {{ authentik_namespace }}"
          - "‚Ä¢ Check IngressRoute: kubectl get ingressroute -n {{ authentik_namespace }}"
          - "‚Ä¢ Check middleware: kubectl get middleware -n {{ default_namespace }}"
          - "‚Ä¢ Check protected ingress: kubectl get ingressroute -n {{ default_namespace }}"
          - "‚Ä¢ View logs: kubectl logs -n {{ authentik_namespace }} deployment/authentik-server"
          - "‚Ä¢ Check Helm: helm status authentik -n {{ authentik_namespace }}"
          - "‚Ä¢ Test external: curl -I http://authentik.localhost/if/admin/"
          - ""
          - "üéØ OAuth Ready Architecture:"
          - "‚Ä¢ HostRegexp IngressRoute: authentik\\..+ pattern deployed"
          - "‚Ä¢ Multi-domain support: .localhost, .urbalurba.no, future domains"
          - "‚Ä¢ CoreDNS ready: Same hostnames work in browser and pod contexts"
          - "‚Ä¢ OAuth discovery: http://authentik.localhost/.well-known/openid-configuration"
          - ""
          - "üîß Troubleshooting:"
          - "‚Ä¢ External access requires host machine DNS for *.localhost"
          - "‚Ä¢ Some external tests may fail during deployment (normal)"
          - "‚Ä¢ Check that all dependencies are running if issues occur"
          - "‚Ä¢ Blueprint logs: {{ 'Available in deployment logs' if 'blueprint' in blueprint_logs.stdout.lower() else 'Check deployment logs' }}"
          - "‚Ä¢ Check applications: kubectl exec -n {{ authentik_namespace }} deployment/authentik-server -- python manage.py shell -c \"from authentik.core.models import Application; print([app.name for app in Application.objects.all()])\""
          - "‚Ä¢ Check users: kubectl exec -n {{ authentik_namespace }} deployment/authentik-server -- python manage.py shell -c \"from authentik.core.models import User; print([user.username for user in User.objects.all()])\""
          - "==============================================="
          - "{{ 'üéâ INSTALLATION SUCCESSFUL - OAuth Integration Ready!' if installation_successful else '‚ö†Ô∏è INSTALLATION STATUS: Some components may still be starting' }}"
          - "==============================================="

    - name: "59. Final success check with enhanced error reporting"
      ansible.builtin.fail:
        msg: |
          ‚ùå Installation did not complete successfully
          
          Running pods: {{ running_pods_count.stdout }} (expected: 2+)
          
          üìä Detailed Pod Status:
          {{ detailed_pod_status.stdout if detailed_pod_status.stdout else 'No pod details available' }}
          
          üì¶ Resource Usage:
          {{ resource_usage.stdout if resource_usage.stdout and 'not available' not in resource_usage.stdout else 'Metrics not available' }}
          
          üîß Troubleshooting:
          ‚Ä¢ Check pod logs: kubectl logs -n {{ authentik_namespace }} <pod-name>
          ‚Ä¢ Verify secrets: kubectl get secret urbalurba-secrets -n {{ authentik_namespace }}
          ‚Ä¢ Check dependencies: kubectl get pods -n {{ default_namespace }}
          ‚Ä¢ Review Helm status: helm status authentik -n {{ authentik_namespace }}
          ‚Ä¢ Check blueprint processing: kubectl logs -n {{ authentik_namespace }} deployment/authentik-server | grep -i blueprint
          ‚Ä¢ Verify resource availability: kubectl describe pods -n {{ authentik_namespace }}
      when: not installation_successful