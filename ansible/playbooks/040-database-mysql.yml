---
# File: playbooks/040-database-mysql.yml
# Description: Set up MySQL database using official MySQL image (manifest-based)
#
# This playbook deploys MySQL using the official mysql:8.0 container image
# with Kubernetes manifests (not Bitnami Helm chart).
#
# Prerequisites:
# - Kubernetes cluster is set up and accessible
# - urbalurba-secrets contains MYSQL_ROOT_PASSWORD, MYSQL_USER, MYSQL_PASSWORD, MYSQL_DATABASE
#
# Usage: ansible-playbook playbooks/040-database-mysql.yml -e target_host="rancher-desktop"

- name: Set up MySQL Database
  hosts: localhost
  gather_facts: false
  vars:
    manifests_folder: "/mnt/urbalurbadisk/manifests"
    merged_kubeconf_file: "/mnt/urbalurbadisk/.uis.secrets/generated/kubeconfig/kubeconf-all"
    mysql_manifest_file: "{{ manifests_folder }}/043-database-mysql-config.yaml"
    mysql_namespace: "default"
    mysql_pod_label: "app.kubernetes.io/name=mysql"

  tasks:
    - name: 1. Check if target_host is provided
      ansible.builtin.fail:
        msg: "The variable 'target_host' is mandatory. Use -e target_host=your_host_name to specify it."
      when: target_host is not defined

    - name: 2. Print playbook description
      ansible.builtin.debug:
        msg: |
          Setting up MySQL on Kubernetes cluster: {{ target_host }}
          Using official mysql:8.0 image (manifest-based deployment)
          Manifests from: {{ manifests_folder }}

    - name: 3. Verify MySQL secret values exist
      kubernetes.core.k8s_info:
        kind: Secret
        name: urbalurba-secrets
        namespace: "{{ mysql_namespace }}"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: secret_info

    - name: 4. Fail if MySQL secrets are not set correctly
      ansible.builtin.fail:
        msg: "MySQL secrets are not set correctly in urbalurba-secrets"
      when: >
        secret_info.resources | length == 0 or
        secret_info.resources[0].data.MYSQL_ROOT_PASSWORD is not defined or
        secret_info.resources[0].data.MYSQL_USER is not defined or
        secret_info.resources[0].data.MYSQL_PASSWORD is not defined or
        secret_info.resources[0].data.MYSQL_DATABASE is not defined

    - name: 5. Display secret status
      ansible.builtin.debug:
        msg: "MySQL secrets found in urbalurba-secrets ‚úì"

    - name: 6. Apply MySQL manifests
      kubernetes.core.k8s:
        src: "{{ mysql_manifest_file }}"
        state: present
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: mysql_apply_result

    - name: 7. Display apply result
      ansible.builtin.debug:
        msg: "MySQL manifests applied successfully"

    - name: 8. Wait for MySQL pod to be running
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ mysql_namespace }}"
        label_selectors:
          - "{{ mysql_pod_label }}"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: mysql_pods
      until: >
        mysql_pods.resources | length > 0 and
        mysql_pods.resources[0].status.phase == "Running"
      retries: 30
      delay: 10

    - name: 9. Wait for MySQL pod to be ready (1/1)
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ mysql_namespace }}"
        label_selectors:
          - "{{ mysql_pod_label }}"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: mysql_pods_ready
      until: >
        mysql_pods_ready.resources | length > 0 and
        mysql_pods_ready.resources[0].status.containerStatuses is defined and
        mysql_pods_ready.resources[0].status.containerStatuses | length > 0 and
        mysql_pods_ready.resources[0].status.containerStatuses[0].ready == true
      retries: 30
      delay: 10

    - name: 10. Verify MySQL service exists
      kubernetes.core.k8s_info:
        kubeconfig: "{{ merged_kubeconf_file }}"
        kind: Service
        namespace: "{{ mysql_namespace }}"
        name: mysql
      register: mysql_svc

    - name: 11. Get MySQL pod name
      ansible.builtin.command:
        cmd: >
          kubectl get pods -n {{ mysql_namespace }}
          -l {{ mysql_pod_label }}
          -o jsonpath='{.items[0].metadata.name}'
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: mysql_pod_name
      changed_when: false

    - name: 12. Test MySQL connectivity
      ansible.builtin.command:
        cmd: >
          kubectl exec -n {{ mysql_namespace }} {{ mysql_pod_name.stdout }}
          --kubeconfig {{ merged_kubeconf_file }}
          -- mysqladmin ping -h localhost
      register: mysql_ping
      retries: 5
      delay: 10
      until: mysql_ping.rc == 0
      changed_when: false

    - name: 13. Display MySQL service details
      ansible.builtin.debug:
        msg: |
          ===============================================
          MySQL Deployment Status
          ===============================================

          ‚úÖ SUCCESS - MySQL deployed and ready

          üìä Deployment Details:
          ‚Ä¢ Image: mysql:8.0 (official)
          ‚Ä¢ Namespace: {{ mysql_namespace }}
          ‚Ä¢ Service: mysql:3306
          ‚Ä¢ Pod: {{ mysql_pod_name.stdout }}

          üîê Credentials:
          ‚Ä¢ Stored in: urbalurba-secrets
          ‚Ä¢ Root password: MYSQL_ROOT_PASSWORD
          ‚Ä¢ User: MYSQL_USER / MYSQL_PASSWORD
          ‚Ä¢ Database: MYSQL_DATABASE

          üåê Access:
          ‚Ä¢ Cluster internal: mysql.{{ mysql_namespace }}.svc.cluster.local:3306
          ‚Ä¢ Port forward: kubectl port-forward svc/mysql 3306:3306 -n {{ mysql_namespace }}

          üîß Test connection:
          kubectl exec -it {{ mysql_pod_name.stdout }} -n {{ mysql_namespace }} -- mysql -u root -p

          ===============================================
