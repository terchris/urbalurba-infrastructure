---
# file: ansible/playbooks/040-remove-database-postgresql.yml
# Description: Remove PostgreSQL database from Kubernetes cluster
# This playbook:
# - Uninstalls the PostgreSQL Helm release
# - Waits for PostgreSQL pods to terminate
# - Optionally removes PVCs (user configurable)
# - Preserves urbalurba-secrets and namespace structure
# Usage:
# ansible-playbook playbooks/040-remove-database-postgresql.yml -e target_host="rancher-desktop"
# ansible-playbook playbooks/040-remove-database-postgresql.yml -e target_host="rancher-desktop" -e remove_pvc=true

- name: Remove PostgreSQL Database from Kubernetes
  hosts: localhost
  gather_facts: false
  vars:
    # Use _target internally to avoid Ansible variable resolution issues
    _target: "{{ target_host | default('rancher-desktop') }}"
    # Use _remove_pvc internally to avoid recursive template issues
    _remove_pvc: "{{ remove_pvc | default(false) }}"
    merged_kubeconf_file: "/mnt/urbalurbadisk/kubeconfig/kubeconf-all"
    postgresql_namespace: "default"
    postgresql_helm_release: "postgresql"
    deletion_timeout: 120

  tasks:
    - name: 1. Display removal information
      ansible.builtin.debug:
        msg:
          - "====================================="
          - "PostgreSQL Removal"
          - "====================================="
          - "Target Host: {{ _target }}"
          - "Namespace: {{ postgresql_namespace }}"
          - "PVC Removal: {{ 'Enabled' if _remove_pvc else 'Disabled' }}"
          - "====================================="

    - name: 4. Check for PostgreSQL Helm release
      ansible.builtin.shell: helm list -n {{ postgresql_namespace }} | grep {{ postgresql_helm_release }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: postgresql_helm_check
      changed_when: false
      ignore_errors: true

    - name: 5. Check for PostgreSQL StatefulSet
      ansible.builtin.shell: kubectl get statefulset {{ postgresql_helm_release }} -n {{ postgresql_namespace }} --context {{ _target }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: postgresql_statefulset_check
      changed_when: false
      ignore_errors: true

    - name: 6. Check for PostgreSQL PVCs
      ansible.builtin.shell: kubectl get pvc -l app.kubernetes.io/name=postgresql -n {{ postgresql_namespace }} --context {{ _target }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: postgresql_pvc_check
      changed_when: false
      ignore_errors: true

    - name: 7. Remove PostgreSQL Helm release
      ansible.builtin.shell: helm uninstall {{ postgresql_helm_release }} -n {{ postgresql_namespace }} --timeout {{ deletion_timeout }}s
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: postgresql_helm_removal
      changed_when: true
      ignore_errors: true
      when: postgresql_helm_check.rc == 0

    - name: 8. Wait for PostgreSQL pods to terminate
      ansible.builtin.shell: kubectl get pods -n {{ postgresql_namespace }} -l app.kubernetes.io/name=postgresql --no-headers --context {{ _target }} 2>/dev/null | wc -l
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: postgresql_pods_count
      until: postgresql_pods_count.stdout | int == 0
      retries: 20
      delay: 10
      changed_when: false

    - name: 9. Remove PostgreSQL PVCs (if requested)
      ansible.builtin.shell: kubectl delete pvc -l app.kubernetes.io/name=postgresql -n {{ postgresql_namespace }} --context {{ _target }} --timeout={{ deletion_timeout }}s
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: postgresql_pvc_removal
      changed_when: true
      ignore_errors: true
      when: _remove_pvc and postgresql_pvc_check.rc == 0

    - name: 10. Wait for PVCs to be fully deleted (if removal was requested)
      ansible.builtin.shell: kubectl get pvc -l app.kubernetes.io/name=postgresql -n {{ postgresql_namespace }} --no-headers --context {{ _target }} 2>/dev/null | wc -l
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: postgresql_pvc_count
      until: postgresql_pvc_count.stdout | int == 0
      retries: 15
      delay: 10
      changed_when: false
      ignore_errors: true
      when: _remove_pvc

    - name: 11. Verify PostgreSQL removal completion
      ansible.builtin.shell: |
        # Check for any remaining PostgreSQL resources
        echo "Checking for remaining PostgreSQL resources..."
        REMAINING_PODS=$(kubectl get pods -n {{ postgresql_namespace }} -l app.kubernetes.io/name=postgresql --no-headers --context {{ _target }} 2>/dev/null | wc -l)
        REMAINING_STS=$(kubectl get statefulset {{ postgresql_helm_release }} -n {{ postgresql_namespace }} --context {{ _target }} 2>/dev/null | wc -l)
        REMAINING_SVC=$(kubectl get svc {{ postgresql_helm_release }} -n {{ postgresql_namespace }} --context {{ _target }} 2>/dev/null | wc -l)

        {% if _remove_pvc %}
        REMAINING_PVC=$(kubectl get pvc -l app.kubernetes.io/name=postgresql -n {{ postgresql_namespace }} --no-headers --context {{ _target }} 2>/dev/null | wc -l)
        {% else %}
        REMAINING_PVC="preserved"
        {% endif %}

        echo "Remaining resources:"
        echo "- Pods: $REMAINING_PODS"
        echo "- StatefulSet: $REMAINING_STS"
        echo "- Service: $REMAINING_SVC"
        echo "- PVCs: $REMAINING_PVC"

        {% if _remove_pvc %}
        TOTAL_REMAINING=$((REMAINING_PODS + REMAINING_STS + REMAINING_SVC + REMAINING_PVC))
        {% else %}
        TOTAL_REMAINING=$((REMAINING_PODS + REMAINING_STS + REMAINING_SVC))
        {% endif %}

        if [ $TOTAL_REMAINING -eq 0 ]; then
          echo "‚úÖ All PostgreSQL resources successfully removed"
          exit 0
        else
          echo "‚ö†Ô∏è  Some PostgreSQL resources may still exist"
          exit 1
        fi
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: postgresql_cleanup_verification
      changed_when: false
      ignore_errors: true

    - name: 12. Display PostgreSQL removal result
      ansible.builtin.debug:
        msg: |
          PostgreSQL removal summary:
          - Helm Release: {{ 'Removed' if postgresql_helm_check.rc == 0 else 'Not found' }}
          - StatefulSet: {{ 'Removed' if postgresql_statefulset_check.rc == 0 else 'Not found' }}
          - Service: {{ 'Removed with Helm release' if postgresql_helm_check.rc == 0 else 'Not found' }}
          - PVCs: {{ 'Removed' if (_remove_pvc and postgresql_pvc_check.rc == 0) else ('Preserved' if postgresql_pvc_check.rc == 0 else 'Not found') }}
          - All PostgreSQL pods terminated
          - urbalurba-secrets and namespace preserved

          Verification: {{ postgresql_cleanup_verification.stdout_lines | join('\n          ') }}

    - name: 13. Display data retention notice
      ansible.builtin.debug:
        msg: |
          {% if not _remove_pvc and postgresql_pvc_check.rc == 0 %}
          üìÄ DATA RETENTION NOTICE:
          PostgreSQL data has been preserved in persistent volume claims.

          üîÑ To reinstall PostgreSQL with existing data:
          ./05-setup-postgres.sh {{ _target }}

          üóëÔ∏è  To completely remove all data:
          ansible-playbook playbooks/040-remove-database-postgresql.yml -e target_host={{ _target }} -e remove_pvc=true
          {% else %}
          üíæ All PostgreSQL data and storage has been completely removed.
          {% endif %}

    - name: 14. Final success message
      ansible.builtin.debug:
        msg: |
          üéâ PostgreSQL removal completed successfully!

          üìã What was removed:
          - PostgreSQL Helm release
          - PostgreSQL StatefulSet and pods
          - PostgreSQL services and resources
          {% if _remove_pvc %}
          - PostgreSQL persistent volume claims (DATA DELETED)
          {% endif %}

          üîê What was preserved:
          - urbalurba-secrets (PostgreSQL credentials retained for future use)
          - Kubernetes namespace structure
          - Other services and applications
          {% if not _remove_pvc %}
          - PostgreSQL persistent volume claims (DATA PRESERVED)
          {% endif %}

          ‚ÑπÔ∏è  To redeploy PostgreSQL:
          ./05-setup-postgres.sh {{ _target }}

          {% if not _remove_pvc %}
          ‚ÑπÔ∏è  To completely remove data:
          ansible-playbook playbooks/040-remove-database-postgresql.yml -e target_host={{ _target }} -e remove_pvc=true
          {% endif %}