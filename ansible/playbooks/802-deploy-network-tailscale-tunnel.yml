---
# file: playbooks/802-deploy-network-tailscale-tunnel.yml
# Description: Deploy Tailscale operator to Kubernetes cluster
#
# This playbook:
# 1. Validates prerequisites
# 2. Cleans up stale Tailscale devices via API (prevents -1, -2 hostname suffixes)
# 3. Installs the Tailscale operator via Helm
# 4. Sets up cluster ingress configuration
# 5. Verifies deployment
#
# Usage:
#   ansible-playbook playbooks/802-deploy-network-tailscale-tunnel.yml
#     -e TAILSCALE_PUBLIC_HOSTNAME="k8s"
#
# Required parameters:
#   TAILSCALE_PUBLIC_HOSTNAME: Public Funnel hostname for the cluster ingress (defaults to 'k8s')

- name: Deploy Tailscale operator to Kubernetes cluster
  hosts: localhost
  gather_facts: false
  vars:
    manifests_folder: "/mnt/urbalurbadisk/manifests"
    kubeconfig_file: "/mnt/urbalurbadisk/.uis.secrets/generated/kubeconfig/kubeconf-all"
    operator_config_template: "800-tailscale-operator-config.yaml.j2"
    ingress_manifest: "803-tailscale-cluster-ingress.yaml.j2"
    default_cluster_hostname: "k8s"
    operator_namespace: "tailscale"
    operator_release_name: "tailscale-operator"
    
  tasks:
    - name: "01 Verify kubeconfig file exists"
      ansible.builtin.stat:
        path: "{{ kubeconfig_file }}"
      register: kubeconfig_stat

    - name: "02 Fail if kubeconfig file does not exist"
      ansible.builtin.fail:
        msg: "Kubeconfig file not found at {{ kubeconfig_file }}"
      when: not kubeconfig_stat.stat.exists

    - name: "03 Retrieve Tailscale secrets from urbalurba-secrets"
      kubernetes.core.k8s_info:
        kind: Secret
        name: urbalurba-secrets
        namespace: default
        kubeconfig: "{{ kubeconfig_file }}"
      register: urbalurba_secrets

    - name: "04 Extract Tailscale credentials"
      ansible.builtin.set_fact:
        tailscale_clientid: "{{ urbalurba_secrets.resources[0].data.TAILSCALE_CLIENTID | b64decode }}"
        tailscale_clientsecret: "{{ urbalurba_secrets.resources[0].data.TAILSCALE_CLIENTSECRET | b64decode }}"
        tailscale_domain: "{{ urbalurba_secrets.resources[0].data.TAILSCALE_DOMAIN | b64decode }}"
        tailscale_public_hostname: "{{ urbalurba_secrets.resources[0].data.TAILSCALE_PUBLIC_HOSTNAME | default('') | b64decode | default(default_cluster_hostname, true) }}"
        tailscale_operator_prefix: "{{ urbalurba_secrets.resources[0].data.TAILSCALE_OPERATOR_PREFIX | default('') | b64decode | default(default_cluster_hostname, true) }}"
      when: urbalurba_secrets.resources | length > 0

    - name: "05 Ensure Tailscale credentials were retrieved"
      ansible.builtin.fail:
        msg: "Failed to retrieve Tailscale credentials from urbalurba-secrets."
      when: tailscale_clientid is not defined or tailscale_clientsecret is not defined

    # Pre-deploy cleanup: remove stale devices that would cause hostname conflicts (-1, -2 suffixes)
    - name: "05a Obtain OAuth access token for device cleanup"
      ansible.builtin.uri:
        url: "https://api.tailscale.com/api/v2/oauth/token"
        method: POST
        body_format: form-urlencoded
        body:
          client_id: "{{ tailscale_clientid }}"
          client_secret: "{{ tailscale_clientsecret }}"
          grant_type: "client_credentials"
        status_code: [200]
        timeout: 15
      register: oauth_token_response
      ignore_errors: true
      no_log: true

    - name: "05b Extract access token"
      ansible.builtin.set_fact:
        ts_access_token: "{{ oauth_token_response.json.access_token }}"
      when: oauth_token_response.status is defined and oauth_token_response.status == 200
      no_log: true

    - name: "05c List devices in tailnet"
      ansible.builtin.uri:
        url: "https://api.tailscale.com/api/v2/tailnet/{{ urbalurba_secrets.resources[0].data.TAILSCALE_TAILNET | b64decode }}/devices"
        method: GET
        headers:
          Authorization: "Bearer {{ ts_access_token }}"
        status_code: [200]
        timeout: 15
      register: devices_response
      when: ts_access_token is defined
      ignore_errors: true

    - name: "05d Find stale devices matching cluster hostname"
      ansible.builtin.set_fact:
        stale_devices: >-
          {{ devices_response.json.devices | default([]) |
             selectattr('name', 'search', '^' + tailscale_public_hostname + '(-[0-9]+)?[.]') |
             list }}
      when: devices_response.status is defined and devices_response.status == 200

    - name: "05e Find stale devices matching operator hostname"
      ansible.builtin.set_fact:
        stale_operator_devices: >-
          {{ devices_response.json.devices | default([]) |
             selectattr('name', 'search', '^' + tailscale_operator_prefix + '-tailscale-operator(-[0-9]+)?[.]') |
             list }}
      when: devices_response.status is defined and devices_response.status == 200

    - name: "05f Report stale devices found"
      ansible.builtin.debug:
        msg: "Found {{ (stale_devices | default([]) | length) + (stale_operator_devices | default([]) | length) }} stale device(s) ‚Äî cleaning up before deploy: {{ (stale_devices | default([]) + stale_operator_devices | default([])) | map(attribute='name') | join(', ') }}"
      when: (stale_devices | default([]) | length) + (stale_operator_devices | default([]) | length) > 0

    - name: "05g Delete stale cluster ingress devices"
      ansible.builtin.uri:
        url: "https://api.tailscale.com/api/v2/device/{{ item.id }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ ts_access_token }}"
        status_code: [200, 204]
        timeout: 15
      loop: "{{ stale_devices | default([]) }}"
      loop_control:
        label: "{{ item.name }}"
      ignore_errors: true
      no_log: true

    - name: "05h Delete stale operator devices"
      ansible.builtin.uri:
        url: "https://api.tailscale.com/api/v2/device/{{ item.id }}"
        method: DELETE
        headers:
          Authorization: "Bearer {{ ts_access_token }}"
        status_code: [200, 204]
        timeout: 15
      loop: "{{ stale_operator_devices | default([]) }}"
      loop_control:
        label: "{{ item.name }}"
      ignore_errors: true
      no_log: true

    - name: "06 Add Tailscale Helm repository"
      kubernetes.core.helm_repository:
        name: tailscale
        repo_url: https://pkgs.tailscale.com/helmcharts
        kubeconfig: "{{ kubeconfig_file }}"

    - name: "06a Create temp file for rendered operator config"
      ansible.builtin.tempfile:
        state: file
        suffix: .yaml
      register: temp_operator_config_file

    - name: "06b Apply variable substitution to operator config template"
      ansible.builtin.template:
        src: "{{ manifests_folder }}/{{ operator_config_template }}"
        dest: "{{ temp_operator_config_file.path }}"
      vars:
        TAILSCALE_OPERATOR_PREFIX: "{{ tailscale_operator_prefix }}"

    - name: "07 Create values file with Tailscale credentials for Helm"
      ansible.builtin.tempfile:
        state: file
        suffix: .yaml
      register: temp_values_file

    - name: "08 Write OAuth credentials to temporary file"
      ansible.builtin.copy:
        content: |
          oauth:
            clientId: "{{ tailscale_clientid }}"
            clientSecret: "{{ tailscale_clientsecret }}"
        dest: "{{ temp_values_file.path }}"
      no_log: true

    - name: "09 Install Tailscale operator using Helm"
      kubernetes.core.helm:
        name: "{{ operator_release_name }}"
        chart_ref: tailscale/tailscale-operator
        release_namespace: "{{ operator_namespace }}"
        create_namespace: true
        values_files:
          - "{{ temp_operator_config_file.path }}"
          - "{{ temp_values_file.path }}"
        wait: true
        kubeconfig: "{{ kubeconfig_file }}"
      register: helm_install_result

    - name: "09a Verify Helm installation was successful"
      ansible.builtin.fail:
        msg: "‚ùå Helm installation failed: {{ helm_install_result.msg | default('Unknown error') }}"
      when: helm_install_result.failed | default(false)

    - name: "10 Wait for Tailscale operator pod to appear"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ operator_namespace }}"
        label_selectors:
          - "app=operator"
        kubeconfig: "{{ kubeconfig_file }}"
      register: operator_pods
      until: 
        - operator_pods.resources | length > 0
        - operator_pods.resources | map(attribute='status.phase') | list | select('in', ['Pending', 'Running']) | list | length > 0
      retries: 12
      delay: 5

    - name: "10a Verify pods are not in error state"
      ansible.builtin.fail:
        msg: "‚ùå Tailscale operator pods are in error state: {{ operator_pods.resources | map(attribute='status.phase') | list | join(', ') }}"
      when: 
        - operator_pods.resources | length > 0
        - operator_pods.resources | map(attribute='status.phase') | list | select('in', ['Failed', 'Error', 'CrashLoopBackOff']) | list | length > 0
      
    - name: "11 Wait for Tailscale operator to be ready"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ operator_namespace }}"
        label_selectors:
          - "app=operator"
        kubeconfig: "{{ kubeconfig_file }}"
      register: operator_pods_status
      until: 
        - operator_pods_status.resources | length > 0
        - operator_pods_status.resources | map(attribute='status.phase') | list | unique == ['Running']
      retries: 12
      delay: 10

    - name: "11a Verify all pods are running and ready"
      ansible.builtin.fail:
        msg: "‚ùå Tailscale operator pods are not ready. Status: {{ operator_pods_status.resources | map(attribute='status.phase') | list | join(', ') }}"
      when: 
        - operator_pods_status.resources | length > 0
        - operator_pods_status.resources | map(attribute='status.phase') | list | unique != ['Running']

    - name: "12 Verify Tailscale operator is functional"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        namespace: "{{ operator_namespace }}"
        label_selectors:
          - "app=operator"
        kubeconfig: "{{ kubeconfig_file }}"
      register: operator_services
      failed_when: false
      ignore_errors: true

    - name: "12a Display operator verification success"
      ansible.builtin.debug:
        msg:
          - "‚úÖ Tailscale operator is running and functional!"
          - "Pods: {{ operator_pods_status.resources | length }}"
          - "Services: {{ operator_services.resources | length if operator_services.resources is defined else 0 }}"
          - "Status: {{ operator_pods_status.resources | map(attribute='status.phase') | list | join(', ') }}"

    - name: "11a Check operator pod logs when not ready"
      kubernetes.core.k8s_log:
        name: "{{ operator_pods.resources[0].metadata.name }}"
        namespace: "{{ operator_namespace }}"
        kubeconfig: "{{ kubeconfig_file }}"
        tail_lines: 50
      register: operator_logs
      when: 
        - operator_pods.resources | length > 0
        - operator_pods_status.resources[0].status.phase != 'Running'
      failed_when: false

    - name: "11b Show pod status and error details when not ready"
      ansible.builtin.fail:
        msg:
          - "‚ùå Tailscale operator pod failed to start!"
          - "Pod name: {{ operator_pods.resources[0].metadata.name }}"
          - "Pod status: {{ operator_pods_status.resources[0].status.phase | default('Unknown') }}"
          - "Pod conditions: {{ operator_pods_status.resources[0].status.conditions | default([]) | map(attribute='type') | list | join(', ') }}"
          - ""
          - "Recent pod logs:"
          - "{{ operator_logs.log | default('No logs available') }}"
          - ""
          - "Common issues:"
          - "- 403/auth errors: Expired or invalid Tailscale auth key"
          - "- Permission denied: Auth key missing 'tag:k8s' permission" 
          - "- Network issues: Cannot reach Tailscale control plane"
          - ""
          - "To fix auth issues:"
          - "1. Go to https://login.tailscale.com/admin/settings/keys"
          - "2. Generate new auth key with 'tag:k8s' permission"
          - "3. Update .uis.secrets/service-keys/tailscale.env"
          - "4. Run: ./uis deploy tailscale-tunnel"
      when: 
        - operator_pods.resources | length > 0
        - operator_pods_status.resources[0].status.phase != 'Running'

    - name: "12 Create temp file for Ingress manifest"
      ansible.builtin.tempfile:
        state: file
        suffix: .yaml
      register: temp_ingress_file

    - name: "13 Apply variable substitution to Ingress manifest template"
      ansible.builtin.template:
        src: "{{ manifests_folder }}/{{ ingress_manifest }}"
        dest: "{{ temp_ingress_file.path }}"
      vars:
        TAILSCALE_PUBLIC_HOSTNAME: "{{ tailscale_public_hostname }}"

    - name: "14 Apply Tailscale Ingress configuration"
      kubernetes.core.k8s:
        src: "{{ temp_ingress_file.path }}"
        kubeconfig: "{{ kubeconfig_file }}"
        state: present

    - name: "15 Clean up temporary files"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ temp_ingress_file.path }}"
        - "{{ temp_values_file.path }}"
        - "{{ temp_operator_config_file.path }}"

    - name: "16 Display deployment status"
      ansible.builtin.debug:
        msg: 
          - "‚úÖ Tailscale operator deployed successfully!"
          - "Cluster hostname: {{ tailscale_public_hostname }}"
          - "Services will be accessible at: https://service.{{ tailscale_public_hostname }}.{{ tailscale_domain }}"

    - name: "17 Wait for Tailscale ingress to be fully operational"
      ansible.builtin.pause:
        seconds: 15
        prompt: "Waiting for Tailscale Funnel and DNS to stabilize..."

    - name: "18 Test Tailscale tunnel connectivity"
      ansible.builtin.uri:
        url: "https://{{ tailscale_public_hostname }}.{{ tailscale_domain }}"
        method: GET
        status_code: 200
        validate_certs: false
        timeout: 30
      register: tunnel_test
      retries: 12
      delay: 10
      until: tunnel_test.status == 200
      failed_when: false

    - name: "19 Display tunnel test results"
      ansible.builtin.debug:
        msg:
          - "üåê Tailscale Funnel connectivity test:"
          - "URL tested: https://{{ tailscale_public_hostname }}.{{ tailscale_domain }}"
          - "Response status: {{ tunnel_test.status | default('timeout') }}"
          - "‚úÖ Tunnel is working correctly - nginx catch-all responded with 'Hello World'"
      when: tunnel_test.status is defined and tunnel_test.status == 200

    - name: "19a Display tunnel test failure"
      ansible.builtin.fail:
        msg:
          - "‚ùå Tailscale Funnel connectivity test FAILED!"
          - "URL tested: https://{{ tailscale_public_hostname }}.{{ tailscale_domain }}"
          - "Status: Connection failed or timed out"
          - ""
          - "The operator deployed successfully, but the tunnel is not accessible from the internet."
          - "This could mean:"
          - "- DNS hasn't propagated yet (try again in 10 minutes)"
          - "- Tailscale Funnel isn't properly enabled"
          - "- The ingress configuration has issues"
          - ""
          - "Check the operator pod logs:"
          - "kubectl logs -n tailscale -l app=operator"
          - ""
          - "Manual test: curl https://{{ tailscale_public_hostname }}.{{ tailscale_domain }}"
      when: tunnel_test.status is not defined or tunnel_test.status != 200

    - name: "20 Final deployment summary - SUCCESS"
      ansible.builtin.debug:
        msg:
          - "üéâ Tailscale tunnel deployment complete and VERIFIED!"
          - "‚úÖ Connectivity test passed - tunnel is working"
          - "Your cluster is now accessible via Tailscale Funnel:"
          - "  https://{{ tailscale_public_hostname }}.{{ tailscale_domain }} (cluster ingress)"
          - "  https://whoami.{{ tailscale_public_hostname }}.{{ tailscale_domain }} (whoami service)"
          - "  https://SERVICE.{{ tailscale_public_hostname }}.{{ tailscale_domain }} (any service)"
      when: tunnel_test.status is defined and tunnel_test.status == 200