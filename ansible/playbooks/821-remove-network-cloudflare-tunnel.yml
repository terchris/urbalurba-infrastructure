---
# file: ansible/playbooks/821-remove-network-cloudflare-tunnel.yml
# Description: Remove Cloudflare tunnel from Kubernetes cluster
#
# This playbook:
# 1. Deletes the cloudflare-tunnel Deployment
# 2. Cleans up legacy resources (ConfigMap, credentials Secret)
# 3. Waits for pod termination
# 4. Prints manual cleanup reminder
#
# Usage:
#   ansible-playbook playbooks/821-remove-network-cloudflare-tunnel.yml

- name: Remove Cloudflare tunnel from Kubernetes
  hosts: localhost
  gather_facts: false
  vars:
    manifests_folder: "/mnt/urbalurbadisk/manifests"
    kubeconfig_file: "/mnt/urbalurbadisk/.uis.secrets/generated/kubeconfig/kubeconf-all"
    manifest_file: "820-cloudflare-tunnel-base.yaml"
    tunnel_namespace: "default"

  tasks:
    - name: "01 Check for cloudflared deployment"
      kubernetes.core.k8s_info:
        kind: Deployment
        name: cloudflare-tunnel
        namespace: "{{ tunnel_namespace }}"
        kubeconfig: "{{ kubeconfig_file }}"
      register: cf_deployment
      ignore_errors: true

    - name: "02 Delete cloudflare-tunnel deployment"
      kubernetes.core.k8s:
        src: "{{ manifests_folder }}/{{ manifest_file }}"
        kubeconfig: "{{ kubeconfig_file }}"
        state: absent
      when: cf_deployment.resources | default([]) | length > 0
      ignore_errors: true

    - name: "03 Clean up legacy ConfigMap (cloudflare-tunnel-config)"
      kubernetes.core.k8s:
        kind: ConfigMap
        name: cloudflare-tunnel-config
        namespace: "{{ tunnel_namespace }}"
        kubeconfig: "{{ kubeconfig_file }}"
        state: absent
      ignore_errors: true

    - name: "04 Clean up legacy Secret (cloudflared-credentials)"
      kubernetes.core.k8s:
        kind: Secret
        name: cloudflared-credentials
        namespace: "{{ tunnel_namespace }}"
        kubeconfig: "{{ kubeconfig_file }}"
        state: absent
      ignore_errors: true

    - name: "05 Wait for cloudflared pods to terminate"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ tunnel_namespace }}"
        label_selectors:
          - "app=cloudflared"
        kubeconfig: "{{ kubeconfig_file }}"
      register: cf_pods_remaining
      until: cf_pods_remaining.resources | length == 0
      retries: 20
      delay: 5
      ignore_errors: true

    - name: "06 Display removal summary"
      ansible.builtin.debug:
        msg:
          - "==================================================="
          - "Cloudflare Tunnel Removal"
          - "==================================================="
          - ""
          - "Deployment: {{ 'Removed' if cf_deployment.resources | default([]) | length > 0 else 'Not found (already removed)' }}"
          - "Legacy ConfigMap: Cleaned up"
          - "Legacy Secret: Cleaned up"
          - "Pods remaining: {{ cf_pods_remaining.resources | default([]) | length }}"
          - ""
          - "NOTE: The tunnel still exists in Cloudflare dashboard."
          - "To fully clean up, delete the tunnel in:"
          - "  Cloudflare dashboard > Zero Trust > Networks > Tunnels"
          - ""
          - "To redeploy: uis deploy cloudflare-tunnel"
          - "==================================================="
