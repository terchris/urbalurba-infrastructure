---
# File: ansible/playbooks/031-setup-tempo.yml
# Description: Deploy Grafana Tempo for Urbalurba Infrastructure
# Usage: ansible-playbook 031-setup-tempo.yml -e "target_host=rancher-desktop"

- name: Deploy Grafana Tempo for Urbalurba Infrastructure
  hosts: localhost
  gather_facts: false

  vars:
    target_host: "{{ target_host | default('rancher-desktop') }}"
    namespace: "monitoring"
    component_name: "tempo"
    manifests_folder: "/mnt/urbalurbadisk/manifests"
    tempo_config_file: "{{ manifests_folder }}/031-tempo-config.yaml"

    helm_repos:
      - name: grafana
        url: https://grafana.github.io/helm-charts

  tasks:
    - name: 1. Display deployment information
      ansible.builtin.debug:
        msg:
          - "====================================="
          - "Grafana Tempo Deployment"
          - "====================================="
          - "Target Host: {{ target_host }}"
          - "Namespace: {{ namespace }}"
          - "Component: {{ component_name }}"
          - "Config File: {{ tempo_config_file }}"

    - name: 2. Create monitoring namespace
      kubernetes.core.k8s:
        name: "{{ namespace }}"
        api_version: v1
        kind: Namespace
        state: present
        context: "{{ target_host }}"

    - name: 3. Add/update Helm repositories
      kubernetes.core.helm_repository:
        name: "{{ item.name }}"
        repo_url: "{{ item.url }}"
      loop: "{{ helm_repos }}"

    - name: 4. Update Helm repositories
      ansible.builtin.command: helm repo update
      changed_when: false

    - name: 5. Install/upgrade Tempo via Helm
      ansible.builtin.command: >
        helm upgrade --install tempo grafana/tempo
        -f {{ tempo_config_file }}
        --namespace {{ namespace }}
        --create-namespace
        --timeout 600s
        --kube-context {{ target_host }}
      register: tempo_helm_result
      changed_when: true

    - name: 6. Wait for Tempo pods to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ namespace }}"
        label_selectors:
          - app.kubernetes.io/name=tempo
        context: "{{ target_host }}"
      register: tempo_pods
      retries: 20
      delay: 15
      until: >
        tempo_pods.resources | length > 0 and
        tempo_pods.resources[0].status.phase == "Running" and
        tempo_pods.resources[0].status.containerStatuses[0].ready == true

    - name: 7. Test Tempo HTTP API endpoint from within cluster
      ansible.builtin.command: >
        kubectl run curl-test-tempo-api --image=curlimages/curl --rm -i --restart=Never
        -n {{ namespace }} --context {{ target_host }} --
        curl -s -o /dev/null -w "HTTP_CODE:%{http_code}"
        http://tempo.{{ namespace }}.svc.cluster.local:3200/api/echo
      register: tempo_api_test
      retries: 15
      delay: 15
      until: tempo_api_test.rc == 0 and (tempo_api_test.stdout.find('HTTP_CODE:200') != -1)
      failed_when: false

    - name: 8. Test Tempo ready endpoint from within cluster
      ansible.builtin.command: >
        kubectl run curl-test-tempo-ready --image=curlimages/curl --rm -i --restart=Never
        -n {{ namespace }} --context {{ target_host }} --
        curl -s -o /dev/null -w "HTTP_CODE:%{http_code}"
        http://tempo.{{ namespace }}.svc.cluster.local:3200/ready
      register: tempo_ready_test
      retries: 15
      delay: 15
      until: tempo_ready_test.rc == 0 and (tempo_ready_test.stdout.find('HTTP_CODE:200') != -1)
      failed_when: false

    - name: 9. Test Tempo metrics endpoint
      ansible.builtin.command: >
        kubectl run curl-test-tempo-metrics --image=curlimages/curl --rm -i --restart=Never
        -n {{ namespace }} --context {{ target_host }} --timeout=15s --
        curl -s http://tempo.{{ namespace }}.svc.cluster.local:3200/metrics
      register: tempo_metrics_test
      retries: 3
      delay: 10
      until: tempo_metrics_test.rc == 0 and (tempo_metrics_test.stdout.find('# TYPE') != -1) and (tempo_metrics_test.stdout.find('go_gc_duration_seconds') != -1)
      failed_when: false

    - name: 10. Test Tempo search API
      ansible.builtin.command: >
        kubectl run curl-test-tempo-search --image=curlimages/curl --rm -i --restart=Never
        -n {{ namespace }} --context {{ target_host }} --timeout=15s --
        curl -s "http://tempo.{{ namespace }}.svc.cluster.local:3200/api/search"
      register: tempo_search_api_test
      retries: 3
      delay: 10
      until: tempo_search_api_test.rc == 0 and (tempo_search_api_test.stdout.find('"traces"') != -1) and (tempo_search_api_test.stdout.find('"metrics"') != -1) and (tempo_search_api_test.stdout.find('completedJobs') != -1)
      failed_when: false

    - name: 11. Test Tempo OTLP gRPC port accessibility
      ansible.builtin.command: >
        kubectl run curl-test-tempo-otlp-grpc --image=curlimages/curl --rm -i --restart=Never
        -n {{ namespace }} --context {{ target_host }} --timeout=10s --
        curl -v telnet://tempo.{{ namespace }}.svc.cluster.local:4317
      register: tempo_otlp_grpc_test
      retries: 3
      delay: 5
      until: tempo_otlp_grpc_test.rc == 0 or (tempo_otlp_grpc_test.stderr is defined and tempo_otlp_grpc_test.stderr.find('Connected') != -1)
      failed_when: false

    - name: 12. Test Tempo OTLP HTTP port accessibility
      ansible.builtin.command: >
        kubectl run curl-test-tempo-otlp-http --image=curlimages/curl --rm -i --restart=Never
        -n {{ namespace }} --context {{ target_host }} --timeout=10s --
        curl -s -o /dev/null -w "HTTP_CODE:%{http_code}"
        http://tempo.{{ namespace }}.svc.cluster.local:4318/
      register: tempo_otlp_http_test
      retries: 3
      delay: 5
      until: tempo_otlp_http_test.rc == 0
      failed_when: false

    - name: 13. Display deployment status
      ansible.builtin.debug:
        msg:
          - "âœ… Grafana Tempo deployment completed successfully!"
          - ""
          - "Service endpoints:"
          - "  ğŸ” Tempo HTTP API: tempo.monitoring.svc.cluster.local:3200"
          - "  ğŸ“¡ OTLP gRPC: tempo.monitoring.svc.cluster.local:4317"
          - "  ğŸ“¡ OTLP HTTP: tempo.monitoring.svc.cluster.local:4318"
          - "  ğŸ“Š Traces API: tempo.monitoring.svc.cluster.local:3200/api/traces"
          - "  ğŸ¥ Ready endpoint: tempo.monitoring.svc.cluster.local:3200/ready"
          - ""
          - "Health tests (ping tests):"
          - "  ğŸ“Š API endpoint: {{ 'PASS' if tempo_api_test.stdout.find('HTTP_CODE:200') != -1 else 'FAIL' }}"
          - "  ğŸ¥ Ready endpoint: {{ 'PASS' if tempo_ready_test.stdout.find('HTTP_CODE:200') != -1 else 'FAIL' }}"
          - ""
          - "OTLP endpoint tests:"
          - "  ğŸ“¡ OTLP gRPC port 4317: {{ 'PASS' if tempo_otlp_grpc_test.rc == 0 or (tempo_otlp_grpc_test.stderr is defined and tempo_otlp_grpc_test.stderr.find('Connected') != -1) else 'FAIL' }}"
          - "  ğŸ“¡ OTLP HTTP port 4318: {{ 'PASS' if tempo_otlp_http_test.rc == 0 else 'FAIL' }}"
          - ""
          - "Standalone API tests:"
          - "  ğŸ“Š Metrics endpoint: {{ 'PASS' if tempo_metrics_test.stdout.find('# TYPE') != -1 and tempo_metrics_test.stdout.find('go_gc_duration_seconds') != -1 else 'FAIL' }}"
          - "  ğŸ” Search API: {{ 'PASS' if tempo_search_api_test.stdout.find('\"traces\"') != -1 and tempo_search_api_test.stdout.find('completedJobs') != -1 else 'FAIL' }}"
          - ""
          - "Manual verification:"
          - "  kubectl get pods -n {{ namespace }} -l app.kubernetes.io/name=tempo --context={{ target_host }}"
          - "  kubectl logs -n {{ namespace }} -l app.kubernetes.io/name=tempo --context={{ target_host }}"
