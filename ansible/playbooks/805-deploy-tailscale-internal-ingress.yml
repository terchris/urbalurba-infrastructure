---
# file: playbooks/805-deploy-tailscale-internal-ingress.yml
# Description: Deploy Tailscale INTERNAL ingress (NO Funnel) to Kubernetes cluster
#
# This creates a Tailscale device that is accessible ONLY from within the Tailnet.
# NOT exposed to public internet (Funnel disabled).
#
# Used by developers via SovereignSky containers to access services like:
# - grafana.sovereignsky.no
# - otel.sovereignsky.no
# - litellm.sovereignsky.no
#
# Usage:
#   ansible-playbook playbooks/805-deploy-tailscale-internal-ingress.yml \
#     -e TAILSCALE_INTERNAL_HOSTNAME="k8s-imac"
#
# Required parameters:
#   TAILSCALE_INTERNAL_HOSTNAME: Hostname for the cluster (e.g., k8s-imac, k8s-tecmacdev)

- name: Deploy Tailscale internal ingress to Kubernetes cluster
  hosts: localhost
  gather_facts: false
  vars:
    manifests_folder: "/mnt/urbalurbadisk/manifests"
    kubeconfig_file: "/mnt/urbalurbadisk/kubeconfig/kubeconf-all"
    operator_config_template: "800-tailscale-operator-config.yaml.j2"
    internal_ingress_manifest: "805-tailscale-internal-ingress.yaml.j2"
    # Default hostname if not provided via -e or K8s secret
    default_internal_hostname: "k8s"
    operator_namespace: "tailscale"
    operator_release_name: "tailscale-operator"

  tasks:
    - name: "01 Verify kubeconfig file exists"
      ansible.builtin.stat:
        path: "{{ kubeconfig_file }}"
      register: kubeconfig_stat

    - name: "02 Fail if kubeconfig file does not exist"
      ansible.builtin.fail:
        msg: "Kubeconfig file not found at {{ kubeconfig_file }}"
      when: not kubeconfig_stat.stat.exists

    - name: "03 Retrieve Tailscale secrets from urbalurba-secrets"
      kubernetes.core.k8s_info:
        kind: Secret
        name: urbalurba-secrets
        namespace: default
        kubeconfig: "{{ kubeconfig_file }}"
      register: urbalurba_secrets

    - name: "04 Extract Tailscale credentials"
      ansible.builtin.set_fact:
        tailscale_clientid: "{{ urbalurba_secrets.resources[0].data.TAILSCALE_CLIENTID | b64decode }}"
        tailscale_clientsecret: "{{ urbalurba_secrets.resources[0].data.TAILSCALE_CLIENTSECRET | b64decode }}"
        tailscale_domain: "{{ urbalurba_secrets.resources[0].data.TAILSCALE_DOMAIN | b64decode }}"
        tailscale_internal_hostname: "{{ urbalurba_secrets.resources[0].data.TAILSCALE_INTERNAL_HOSTNAME | default('') | b64decode | default(default_internal_hostname, true) }}"
      when: urbalurba_secrets.resources | length > 0

    - name: "05 Ensure Tailscale credentials were retrieved"
      ansible.builtin.fail:
        msg: "Failed to retrieve Tailscale credentials from urbalurba-secrets."
      when: tailscale_clientid is not defined or tailscale_clientsecret is not defined

    - name: "06 Add Tailscale Helm repository"
      kubernetes.core.helm_repository:
        name: tailscale
        repo_url: https://pkgs.tailscale.com/helmcharts
        kubeconfig: "{{ kubeconfig_file }}"

    - name: "06a Create temp file for rendered operator config"
      ansible.builtin.tempfile:
        state: file
        suffix: .yaml
      register: temp_operator_config_file

    - name: "06b Apply variable substitution to operator config template"
      ansible.builtin.template:
        src: "{{ manifests_folder }}/{{ operator_config_template }}"
        dest: "{{ temp_operator_config_file.path }}"
      vars:
        TAILSCALE_INTERNAL_HOSTNAME: "{{ tailscale_internal_hostname }}"

    - name: "07 Create values file with Tailscale credentials for Helm"
      ansible.builtin.tempfile:
        state: file
        suffix: .yaml
      register: temp_values_file

    - name: "08 Write OAuth credentials to temporary file"
      ansible.builtin.copy:
        content: |
          oauth:
            clientId: "{{ tailscale_clientid }}"
            clientSecret: "{{ tailscale_clientsecret }}"
        dest: "{{ temp_values_file.path }}"
      no_log: true

    - name: "09 Install Tailscale operator using Helm"
      kubernetes.core.helm:
        name: "{{ operator_release_name }}"
        chart_ref: tailscale/tailscale-operator
        release_namespace: "{{ operator_namespace }}"
        create_namespace: true
        values_files:
          - "{{ temp_operator_config_file.path }}"
          - "{{ temp_values_file.path }}"
        wait: true
        kubeconfig: "{{ kubeconfig_file }}"
      register: helm_install_result

    - name: "09a Verify Helm installation was successful"
      ansible.builtin.fail:
        msg: "Helm installation failed: {{ helm_install_result.msg | default('Unknown error') }}"
      when: helm_install_result.failed | default(false)

    - name: "10 Wait for Tailscale operator pod to appear"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ operator_namespace }}"
        label_selectors:
          - "app=operator"
        kubeconfig: "{{ kubeconfig_file }}"
      register: operator_pods
      until:
        - operator_pods.resources | length > 0
        - operator_pods.resources | map(attribute='status.phase') | list | select('in', ['Pending', 'Running']) | list | length > 0
      retries: 12
      delay: 5

    - name: "10a Verify pods are not in error state"
      ansible.builtin.fail:
        msg: "Tailscale operator pods are in error state: {{ operator_pods.resources | map(attribute='status.phase') | list | join(', ') }}"
      when:
        - operator_pods.resources | length > 0
        - operator_pods.resources | map(attribute='status.phase') | list | select('in', ['Failed', 'Error', 'CrashLoopBackOff']) | list | length > 0

    - name: "11 Wait for Tailscale operator to be ready"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ operator_namespace }}"
        label_selectors:
          - "app=operator"
        kubeconfig: "{{ kubeconfig_file }}"
      register: operator_pods_status
      until:
        - operator_pods_status.resources | length > 0
        - operator_pods_status.resources | map(attribute='status.phase') | list | unique == ['Running']
      retries: 12
      delay: 10

    - name: "11a Verify all pods are running and ready"
      ansible.builtin.fail:
        msg: "Tailscale operator pods are not ready. Status: {{ operator_pods_status.resources | map(attribute='status.phase') | list | join(', ') }}"
      when:
        - operator_pods_status.resources | length > 0
        - operator_pods_status.resources | map(attribute='status.phase') | list | unique != ['Running']

    - name: "12 Verify Tailscale operator is functional"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        namespace: "{{ operator_namespace }}"
        label_selectors:
          - "app=operator"
        kubeconfig: "{{ kubeconfig_file }}"
      register: operator_services
      failed_when: false
      ignore_errors: true

    - name: "12a Display operator verification success"
      ansible.builtin.debug:
        msg:
          - "Tailscale operator is running and functional!"
          - "Pods: {{ operator_pods_status.resources | length }}"
          - "Services: {{ operator_services.resources | length if operator_services.resources is defined else 0 }}"
          - "Status: {{ operator_pods_status.resources | map(attribute='status.phase') | list | join(', ') }}"

    - name: "13 Create temp file for Internal Ingress manifest"
      ansible.builtin.tempfile:
        state: file
        suffix: .yaml
      register: temp_ingress_file

    - name: "14 Apply variable substitution to Internal Ingress manifest template"
      ansible.builtin.template:
        src: "{{ manifests_folder }}/{{ internal_ingress_manifest }}"
        dest: "{{ temp_ingress_file.path }}"
      vars:
        TAILSCALE_INTERNAL_HOSTNAME: "{{ tailscale_internal_hostname }}"

    - name: "15 Apply Tailscale Internal Ingress configuration"
      kubernetes.core.k8s:
        src: "{{ temp_ingress_file.path }}"
        kubeconfig: "{{ kubeconfig_file }}"
        state: present

    - name: "16 Clean up temporary files"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ temp_ingress_file.path }}"
        - "{{ temp_values_file.path }}"
        - "{{ temp_operator_config_file.path }}"

    - name: "17 Wait for Tailscale internal ingress to register on Tailnet"
      ansible.builtin.pause:
        seconds: 20
        prompt: "Waiting for Tailscale device to register on Tailnet..."

    - name: "18 Check Tailscale ingress pod status"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ operator_namespace }}"
        kubeconfig: "{{ kubeconfig_file }}"
      register: all_tailscale_pods

    - name: "19 Display deployment status"
      ansible.builtin.debug:
        msg:
          - "==================================================="
          - "Tailscale INTERNAL LoadBalancer deployed successfully!"
          - "==================================================="
          - ""
          - "Tailscale devices for this cluster:"
          - "  Operator: {{ tailscale_internal_hostname }}-tailscale-operator"
          - "  LoadBalancer:  {{ tailscale_internal_hostname }}"
          - ""
          - "Tailnet domain: {{ tailscale_domain }}"
          - ""
          - "IMPORTANT: This is an INTERNAL-ONLY deployment!"
          - "- Uses LoadBalancer Service (supports HTTP, no HTTPS requirement)"
          - "- NOT accessible from public internet"
          - "- Accessible ONLY from devices on the same Tailnet"
          - ""
          - "Internal URL (HTTP): http://{{ tailscale_internal_hostname }}.{{ tailscale_domain }}"
          - ""
          - "For SovereignSky developers:"
          - "  Configure DNS: *.sovereignsky.no -> [Tailscale IP]"
          - "  Then access: http://grafana.sovereignsky.no"
          - ""
          - "All pods in tailscale namespace:"
          - "{{ all_tailscale_pods.resources | map(attribute='metadata.name') | list | join(', ') }}"

    - name: "20 Final success message"
      ansible.builtin.debug:
        msg:
          - "Deployment complete!"
          - ""
          - "Next steps:"
          - "1. Find the Tailscale IP: Check Tailscale admin console or run 'tailscale status'"
          - "2. Configure SovereignSky DNS with the IP"
          - "3. Test from a devcontainer: curl http://grafana.sovereignsky.no"
