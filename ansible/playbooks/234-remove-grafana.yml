---
# File: ansible/playbooks/244-remove-grafana.yml
# Description: Remove Grafana from Urbalurba Infrastructure
# Usage: ansible-playbook 244-remove-grafana.yml -e "target_host=rancher-desktop"

- name: Remove Grafana from Urbalurba Infrastructure
  hosts: localhost
  gather_facts: false

  vars:
    target_host: "{{ target_host | default('rancher-desktop') }}"
    namespace: "monitoring"
    component_name: "grafana"

  tasks:
    - name: 1. Display removal information
      ansible.builtin.debug:
        msg:
          - "====================================="
          - "Grafana Removal"
          - "====================================="
          - "Target Host: {{ target_host }}"
          - "Namespace: {{ namespace }}"
          - "Component: {{ component_name }}"

    - name: 2. Remove Grafana IngressRoute
      kubernetes.core.k8s:
        state: absent
        context: "{{ target_host }}"
        definition:
          apiVersion: traefik.containo.us/v1alpha1
          kind: IngressRoute
          metadata:
            name: grafana-localhost
            namespace: "{{ namespace }}"
      ignore_errors: true

    - name: 3. Uninstall Grafana Helm release
      kubernetes.core.helm:
        name: grafana
        release_namespace: "{{ namespace }}"
        state: absent
        context: "{{ target_host }}"
      ignore_errors: true
      register: grafana_uninstall

    - name: 4. Wait for Grafana to be removed
      ansible.builtin.command: >
        kubectl wait --for=delete deployment/grafana
        --namespace {{ namespace }} --timeout=120s --context {{ target_host }}
      register: grafana_wait
      ignore_errors: true
      retries: 2
      delay: 10

    - name: 5. Display removal status
      ansible.builtin.debug:
        msg:
          - "âœ… Grafana removal completed!"
          - ""
          - "Removed components:"
          - "  ğŸ“Š Grafana deployment and service"
          - "  ğŸ“‹ Dashboards and configurations"
          - "  ğŸ“ Persistent volumes and data"
          - "  ğŸŒ IngressRoutes"
          - ""
          - "Verification:"
          - "  kubectl get pods -n {{ namespace }} -l app.kubernetes.io/name=grafana --context={{ target_host }}"
          - "  (Should show 'No resources found')"