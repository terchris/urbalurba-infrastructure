---
# file: ansible/playbooks/350-remove-jupyterhub.yml
# Description: Remove JupyterHub from Kubernetes cluster
# This playbook:
# - Uninstalls the JupyterHub Helm release
# - Removes JupyterHub ingress configuration
# - Waits for JupyterHub pods to terminate
# - Preserves urbalurba-secrets for future deployments
# - Removes the jupyterhub namespace
# Usage:
# ansible-playbook playbooks/350-remove-jupyterhub.yml -e target_host="rancher-desktop"

- name: Remove JupyterHub from Kubernetes
  hosts: localhost
  gather_facts: false
  vars:
    merged_kubeconf_file: "/mnt/urbalurbadisk/kubeconfig/kubeconf-all"
    manifests_folder: "/mnt/urbalurbadisk/manifests"
    jupyterhub_namespace: "jupyterhub"
    jupyterhub_helm_release: "jupyterhub"
    deletion_timeout: 180
    jupyterhub_ingress_file: "{{ manifests_folder }}/311-jupyterhub-ingress.yaml"

  tasks:
    - name: 1. Print removal description
      ansible.builtin.debug:
        msg: |
          ğŸ§¹ Starting JupyterHub removal
          ğŸ¯ Target: {{ target_host | default('rancher-desktop') }}
          ğŸ“ Namespace: {{ jupyterhub_namespace }}
          ğŸ” PRESERVING: urbalurba-secrets for future deployments
          âš ï¸  This will remove JupyterHub and all user sessions

    - name: 2. Check for JupyterHub Helm release
      ansible.builtin.shell: helm list -n {{ jupyterhub_namespace }} | grep {{ jupyterhub_helm_release }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: jupyterhub_helm_check
      changed_when: false
      ignore_errors: true

    - name: 3. Remove JupyterHub ingress if it exists
      kubernetes.core.k8s:
        kubeconfig: "{{ merged_kubeconf_file }}"
        state: absent
        api_version: networking.k8s.io/v1
        kind: Ingress
        namespace: "{{ jupyterhub_namespace }}"
        name: jupyterhub
      when: jupyterhub_helm_check.rc == 0
      ignore_errors: true

    - name: 4. Uninstall JupyterHub Helm release
      ansible.builtin.shell: |
        helm uninstall {{ jupyterhub_helm_release }} -n {{ jupyterhub_namespace }} --timeout {{ deletion_timeout }}s
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      when: jupyterhub_helm_check.rc == 0
      register: helm_uninstall_result

    - name: 5. Wait for JupyterHub pods to terminate
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ jupyterhub_namespace }}"
        label_selectors:
          - "app=jupyterhub"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: jupyterhub_pods
      retries: 30
      delay: 5
      until: jupyterhub_pods.resources | length == 0
      when: jupyterhub_helm_check.rc == 0

    - name: 6. Remove jupyterhub namespace
      kubernetes.core.k8s:
        name: "{{ jupyterhub_namespace }}"
        api_version: v1
        kind: Namespace
        state: absent
        kubeconfig: "{{ merged_kubeconf_file }}"
      when: jupyterhub_helm_check.rc == 0

    - name: 7. Verify JupyterHub removal
      ansible.builtin.shell: kubectl get pods -n {{ jupyterhub_namespace }} --ignore-not-found
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: verification_check
      changed_when: false
      ignore_errors: true

    - name: 8. Display final removal status
      ansible.builtin.debug:
        msg:
          - "==============================================="
          - "ğŸ—‘ï¸  JupyterHub Removal Status"
          - "==============================================="
          - ""
          - "{{ 'âœ… SUCCESS - JupyterHub completely removed' if verification_check.rc != 0 else 'âš ï¸ WARNING - Some JupyterHub components may still be present' }}"
          - ""
          - "ğŸ”„ Removal Summary:"
          - "â€¢ Helm release: {{ 'âœ… Uninstalled' if jupyterhub_helm_check.rc == 0 else 'âšª Not found (already removed)' }}"
          - "â€¢ Pod termination: {{ 'âœ… All pods terminated' if jupyterhub_helm_check.rc == 0 else 'âšª No pods found' }}"
          - "â€¢ Ingress: âœ… Removed (if present)"
          - "â€¢ Namespace: {{ 'âœ… Removed' if jupyterhub_helm_check.rc == 0 else 'âšª Not found' }}"
          - ""
          - "ğŸ—ï¸  Infrastructure Status:"
          - "â€¢ Notebook Interface: âœ… Removed"
          - "â€¢ User Sessions: âœ… Terminated"
          - "â€¢ Traefik routing: âœ… Ingress configuration removed"
          - ""
          - "â™»ï¸  Re-deployment:"
          - "â€¢ Ready for fresh deployment using ./05-setup-jupyterhub.sh"
          - "â€¢ urbalurba-secrets will be recreated automatically"
          - "â€¢ No manual cleanup required"
          - "==============================================="