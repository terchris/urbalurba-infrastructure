---
# file: playbooks/060-setup-elasticsearch.yml
# Description: Set up Elasticsearch using Elastic's official Helm chart
#
# This playbook deploys Elasticsearch using the official Elastic Helm chart
# (not Bitnami). Single-node configuration optimized for local development.
#
# Prerequisites:
# - Kubernetes cluster is set up and accessible
# - Helm 3.x installed
#
# Usage:
# ansible-playbook playbooks/060-setup-elasticsearch.yml -e target_host="rancher-desktop"

- name: Set up Elasticsearch on Kubernetes
  hosts: localhost
  gather_facts: false
  vars:
    manifests_folder: "/mnt/urbalurbadisk/manifests"
    merged_kubeconf_file: "/mnt/urbalurbadisk/.uis.secrets/generated/kubeconfig/kubeconf-all"
    elasticsearch_config_file: "{{ manifests_folder }}/060-elasticsearch-config.yaml"
    elasticsearch_namespace: "default"
    elasticsearch_pod_label: "app=elasticsearch-master"
    elasticsearch_service_name: "elasticsearch-master"
    elasticsearch_helm_repo: "https://helm.elastic.co"
    elasticsearch_helm_chart: "elastic/elasticsearch"
    installation_timeout: 600
    # Use _target internally to provide default value
    _target: "{{ target_host | default('rancher-desktop') }}"

  tasks:
    - name: 1. Print playbook description
      ansible.builtin.debug:
        msg: |
          Setting up Elasticsearch on Kubernetes cluster: {{ _target }}
          Using Elastic's official Helm chart (not Bitnami)
          Namespace: {{ elasticsearch_namespace }}
          Config: {{ elasticsearch_config_file }}

    - name: 3. Create namespace if not exists
      kubernetes.core.k8s:
        kind: Namespace
        name: "{{ elasticsearch_namespace }}"
        state: present
        kubeconfig: "{{ merged_kubeconf_file }}"

    - name: 4. Check existing Helm repositories
      ansible.builtin.command: helm repo list
      register: helm_repo_list
      changed_when: false
      ignore_errors: true

    - name: 5. Add Elastic Helm repository if missing
      kubernetes.core.helm_repository:
        name: "elastic"
        repo_url: "{{ elasticsearch_helm_repo }}"
      when: "'elastic' not in helm_repo_list.stdout"

    - name: 6. Update Helm repositories
      ansible.builtin.command: helm repo update
      changed_when: false

    - name: 7. Check if Elasticsearch is already installed
      ansible.builtin.shell: helm list -n {{ elasticsearch_namespace }} | grep -w elasticsearch
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: elasticsearch_helm_check
      changed_when: false
      ignore_errors: true

    - name: 8. Deploy Elasticsearch using Elastic's official Helm chart
      ansible.builtin.command: >
        helm upgrade --install elasticsearch {{ elasticsearch_helm_chart }}
        -f {{ elasticsearch_config_file }}
        --namespace {{ elasticsearch_namespace }}
        --timeout {{ installation_timeout }}s
        --wait
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: elasticsearch_install
      changed_when: true

    - name: 9. Display Helm install output
      ansible.builtin.debug:
        msg: "{{ elasticsearch_install.stdout_lines }}"
      when: elasticsearch_install.stdout_lines is defined

    - name: 10. Wait for Elasticsearch pod to be running
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ elasticsearch_namespace }}"
        label_selectors:
          - "{{ elasticsearch_pod_label }}"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: elasticsearch_pods
      until: >
        elasticsearch_pods.resources | length > 0 and
        elasticsearch_pods.resources[0].status.phase == "Running"
      retries: 30
      delay: 15

    - name: 11. Wait for Elasticsearch pod to be ready (1/1)
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ elasticsearch_namespace }}"
        label_selectors:
          - "{{ elasticsearch_pod_label }}"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: elasticsearch_pods_ready
      until: >
        elasticsearch_pods_ready.resources | length > 0 and
        elasticsearch_pods_ready.resources[0].status.containerStatuses is defined and
        elasticsearch_pods_ready.resources[0].status.containerStatuses | length > 0 and
        elasticsearch_pods_ready.resources[0].status.containerStatuses[0].ready == true
      retries: 30
      delay: 10

    - name: 12. Get Elasticsearch pod name
      ansible.builtin.command:
        cmd: >
          kubectl get pods -n {{ elasticsearch_namespace }}
          -l {{ elasticsearch_pod_label }}
          -o jsonpath='{.items[0].metadata.name}'
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: elasticsearch_pod_name
      changed_when: false

    - name: 13. Check Elasticsearch cluster health
      ansible.builtin.command:
        cmd: >
          kubectl exec -n {{ elasticsearch_namespace }} {{ elasticsearch_pod_name.stdout }}
          --kubeconfig {{ merged_kubeconf_file }}
          -- curl -s http://localhost:9200/_cluster/health?pretty
      register: elasticsearch_health
      retries: 5
      delay: 10
      until: "'green' in elasticsearch_health.stdout or 'yellow' in elasticsearch_health.stdout"
      changed_when: false

    - name: 14. Display Elasticsearch health
      ansible.builtin.debug:
        var: elasticsearch_health.stdout_lines

    - name: 15. Create test index
      ansible.builtin.command:
        cmd: >
          kubectl exec -n {{ elasticsearch_namespace }} {{ elasticsearch_pod_name.stdout }}
          --kubeconfig {{ merged_kubeconf_file }}
          -- curl -s -X PUT http://localhost:9200/test
      register: create_index
      changed_when: true

    - name: 16. Index a test document
      ansible.builtin.command:
        cmd: >
          kubectl exec -n {{ elasticsearch_namespace }} {{ elasticsearch_pod_name.stdout }}
          --kubeconfig {{ merged_kubeconf_file }}
          -- curl -s -X POST http://localhost:9200/test/_doc -H 'Content-Type: application/json'
          -d '{"title": "Test Document", "content": "Elasticsearch is working correctly."}'
      register: index_document
      changed_when: true

    - name: 17. Wait for indexing
      ansible.builtin.pause:
        seconds: 3

    - name: 18. Search for test document
      ansible.builtin.command:
        cmd: >
          kubectl exec -n {{ elasticsearch_namespace }} {{ elasticsearch_pod_name.stdout }}
          --kubeconfig {{ merged_kubeconf_file }}
          -- curl -s http://localhost:9200/test/_search?q=content:working
      register: search_result
      changed_when: false

    - name: 19. Verify search works
      ansible.builtin.fail:
        msg: "Elasticsearch search test failed. Response: {{ search_result.stdout }}"
      when: "'Test Document' not in search_result.stdout"

    - name: 20. Clean up test index
      ansible.builtin.command:
        cmd: >
          kubectl exec -n {{ elasticsearch_namespace }} {{ elasticsearch_pod_name.stdout }}
          --kubeconfig {{ merged_kubeconf_file }}
          -- curl -s -X DELETE http://localhost:9200/test
      changed_when: true

    - name: 21. Display final status
      ansible.builtin.debug:
        msg: |
          ===============================================
          Elasticsearch Deployment Status
          ===============================================

          ‚úÖ SUCCESS - Elasticsearch deployed and ready

          üìä Deployment Details:
          ‚Ä¢ Chart: elastic/elasticsearch (official)
          ‚Ä¢ Namespace: {{ elasticsearch_namespace }}
          ‚Ä¢ Service: {{ elasticsearch_service_name }}:9200
          ‚Ä¢ Pod: {{ elasticsearch_pod_name.stdout }}

          üîê Security:
          ‚Ä¢ Disabled for local development
          ‚Ä¢ No authentication required

          üåê Access:
          ‚Ä¢ Cluster internal: http://{{ elasticsearch_service_name }}.{{ elasticsearch_namespace }}.svc.cluster.local:9200
          ‚Ä¢ Port forward: kubectl port-forward svc/{{ elasticsearch_service_name }} 9200:9200 -n {{ elasticsearch_namespace }}
          ‚Ä¢ Local access: http://localhost:9200 (after port forward)

          üîß Test commands:
          ‚Ä¢ Health: curl http://localhost:9200/_cluster/health?pretty
          ‚Ä¢ Indices: curl http://localhost:9200/_cat/indices?v

          ===============================================
