---
# file: playbooks/060-setup-elasticsearch.yml
# Set up Elasticsearch on Kubernetes cluster using the secrets defined
# Usage:
# ansible-playbook playbooks/060-setup-elasticsearch.yml -e target_host="rancher-desktop" -e elasticsearch_namespace="elasticsearch" -e elasticsearch_version="8.16.1"

- name: Set up Elasticsearch on Kubernetes
  hosts: localhost
  gather_facts: false
  vars:
    manifests_folder: "/mnt/urbalurbadisk/manifests"
    merged_kubeconf_file: "/mnt/urbalurbadisk/kubeconfig/kubeconf-all"
    elasticsearch_password_secret: "urbalurba-secrets"
    elasticsearch_username_key: "ELASTICSEARCH_USERNAME"
    elasticsearch_password_key: "ELASTICSEARCH_PASSWORD"
    elasticsearch_config_file: "{{ manifests_folder }}/060-elasticsearch-config.yaml"
    elasticsearch_pod_label: "app.kubernetes.io/name=elasticsearch"
    elasticsearch_pod_readiness_timeout: 300
    elasticsearch_service_name: "elasticsearch"
    # Default to Elasticsearch 8.16.1 if no version specified (closest available to 8.16.3)
    elasticsearch_version_default: "{{ elasticsearch_version | default('8.16.1') }}"

  tasks:
    - name: 1. Check if required variables are provided
      ansible.builtin.fail:
        msg: "The variable 'target_host' is mandatory. Use -e target_host=your_host_name to specify it."
      when: target_host is not defined
      ignore_errors: true

    - name: 2. Set Elasticsearch namespace
      ansible.builtin.set_fact:
        elasticsearch_namespace: "{{ elasticsearch_namespace | default('default') }}"

    - name: 3. Print playbook description
      ansible.builtin.debug:
        msg: >
          Setting up Elasticsearch {{ elasticsearch_version_default }} on Kubernetes cluster: {{ target_host }}
          with manifests from: {{ manifests_folder }}.
          Using namespace: {{ elasticsearch_namespace }}

    - name: 4. Validate Elasticsearch version format
      ansible.builtin.fail:
        msg: "Invalid Elasticsearch version format. Expected format: X.Y.Z (e.g., 8.16.3)"
      when: not elasticsearch_version_default is regex('^[0-9]+\.[0-9]+\.[0-9]+$')

    - name: 5. Check if Elasticsearch version is 8.16.x
      ansible.builtin.fail:
        msg: "This playbook is designed for Elasticsearch 8.16.x. Current version: {{ elasticsearch_version_default }}"
      when: not elasticsearch_version_default.startswith('8.16.')

    - name: 6. Get Elasticsearch credentials from Kubernetes secrets
      ansible.builtin.shell: |
        set -o pipefail
        kubectl get secret --namespace default {{ elasticsearch_password_secret }} \
        -o jsonpath="{.data.{{ elasticsearch_username_key }}}" \
        --kubeconfig {{ merged_kubeconf_file }} | base64 -d
      args:
        executable: /bin/bash
      register: elasticsearch_username
      changed_when: false

    - name: 7. Get Elasticsearch password from Kubernetes secrets
      ansible.builtin.shell: |
        set -o pipefail
        kubectl get secret --namespace default {{ elasticsearch_password_secret }} \
        -o jsonpath="{.data.{{ elasticsearch_password_key }}}" \
        --kubeconfig {{ merged_kubeconf_file }} | base64 -d
      args:
        executable: /bin/bash
      register: elasticsearch_password
      changed_when: false

    - name: 8. Set Elasticsearch credential facts
      ansible.builtin.set_fact:
        elasticsearch_username_fact: "{{ elasticsearch_username.stdout }}"
        elasticsearch_password_fact: "{{ elasticsearch_password.stdout }}"

    - name: 9. Debug Elasticsearch credentials (masked)
      ansible.builtin.debug:
        msg:
          - "Elasticsearch username: {{ elasticsearch_username_fact }}"
          - "Elasticsearch password: {{ elasticsearch_password_fact | regex_replace('.', '*') }}"

    - name: 10. Check existing Helm repositories
      ansible.builtin.command: helm repo list
      register: helm_repo_list
      changed_when: false

    - name: 11. Add required Helm repositories if missing
      kubernetes.core.helm_repository:
        name: "{{ item.name }}"
        repo_url: "{{ item.url }}"
      loop:
        - { name: 'bitnami', url: 'https://charts.bitnami.com/bitnami' }
      when: item.name not in helm_repo_list.stdout

    - name: 12. Update Helm repositories
      ansible.builtin.command: helm repo update
      changed_when: false

    - name: 13. Deploy Elasticsearch using Helm with centralized credentials
      ansible.builtin.command: >
        helm upgrade --install elasticsearch bitnami/elasticsearch
        -f {{ elasticsearch_config_file }}
        --set security.elasticPassword={{ elasticsearch_password_fact | quote }}
        --set image.tag={{ elasticsearch_version_default }}
        --set master.replicaCount=1
        --set data.replicaCount=0
        --set coordinating.replicaCount=0
        --set ingest.enabled=false
        --namespace {{ elasticsearch_namespace }}
        --create-namespace
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      changed_when: true

    - name: 13. Wait for Elasticsearch pods to be ready (with progress indicators)
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ elasticsearch_namespace }}"
        label_selectors:
          - "{{ elasticsearch_pod_label }}"
      register: elasticsearch_pods
      retries: 20
      delay: 15
      until: >
        elasticsearch_pods.resources | length > 0 and
        elasticsearch_pods.resources[0].status.phase == "Running"

    - name: 14. Wait for Elasticsearch pods to be fully ready (1/1)
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ elasticsearch_namespace }}"
        label_selectors:
          - "{{ elasticsearch_pod_label }}"
      register: elasticsearch_pods_ready
      retries: 30
      delay: 10
      until: >
        elasticsearch_pods_ready.resources | length > 0 and
        elasticsearch_pods_ready.resources[0].status.containerStatuses[0].ready == true

    - name: 15. Verify Elasticsearch service is running
      ansible.builtin.command:
        cmd: >
          kubectl get svc {{ elasticsearch_service_name }}
          --namespace {{ elasticsearch_namespace }}
          --kubeconfig {{ merged_kubeconf_file }}
      register: elasticsearch_svc
      changed_when: false

    - name: 16. Display Elasticsearch service details
      ansible.builtin.debug:
        var: elasticsearch_svc.stdout_lines

    - name: 17. Get Elasticsearch pod name
      ansible.builtin.command:
        cmd: >
          kubectl get pods -n {{ elasticsearch_namespace }}
          -l {{ elasticsearch_pod_label }}
          -o jsonpath='{.items[0].metadata.name}'
          --kubeconfig {{ merged_kubeconf_file }}
      register: elasticsearch_pod_name
      changed_when: false

    - name: 18. Check Elasticsearch cluster health
      ansible.builtin.command:
        cmd: >
          kubectl exec -n {{ elasticsearch_namespace }} {{ elasticsearch_pod_name.stdout }}
          --kubeconfig {{ merged_kubeconf_file }}
          -- curl -u "{{ elasticsearch_username_fact }}:{{ elasticsearch_password_fact }}" -s -X GET
          "http://localhost:9200/_cluster/health?pretty"
      register: elasticsearch_health
      changed_when: false

    - name: 19. Display Elasticsearch health
      ansible.builtin.debug:
        var: elasticsearch_health.stdout_lines

    - name: 20. Check if Elasticsearch is working
      ansible.builtin.fail:
        msg: "Elasticsearch cluster health check failed. Response: {{ elasticsearch_health.stdout }}"
      when: "'green' not in elasticsearch_health.stdout and 'yellow' not in elasticsearch_health.stdout"

    - name: 21. Confirm Elasticsearch is working
      ansible.builtin.debug:
        msg: "Elasticsearch is working correctly"
      when: "'green' in elasticsearch_health.stdout or 'yellow' in elasticsearch_health.stdout"

    - name: 22. Create test index
      ansible.builtin.command:
        cmd: >
          kubectl exec -n {{ elasticsearch_namespace }} {{ elasticsearch_pod_name.stdout }}
          --kubeconfig {{ merged_kubeconf_file }}
          -- curl -u "{{ elasticsearch_username_fact }}:{{ elasticsearch_password_fact }}" -s -X PUT
          "http://localhost:9200/test"
      register: create_index
      changed_when: true

    - name: 23. Index a document in Elasticsearch
      ansible.builtin.command:
        cmd: >
          kubectl exec -n {{ elasticsearch_namespace }} {{ elasticsearch_pod_name.stdout }}
          --kubeconfig {{ merged_kubeconf_file }}
          -- curl -u "{{ elasticsearch_username_fact }}:{{ elasticsearch_password_fact }}" -s -X POST
          "http://localhost:9200/test/_doc" -H 'Content-Type: application/json'
          -d '{"title": "Test Document", "content": "This is a test document for Elasticsearch."}'
      register: index_document
      changed_when: true

    - name: 24. Wait for indexing to complete
      ansible.builtin.pause:
        seconds: 5

    - name: 25. Search for the document in Elasticsearch
      ansible.builtin.command:
        cmd: >
          kubectl exec -n {{ elasticsearch_namespace }} {{ elasticsearch_pod_name.stdout }}
          --kubeconfig {{ merged_kubeconf_file }}
          -- curl -u "{{ elasticsearch_username_fact }}:{{ elasticsearch_password_fact }}" -s -X GET
          "http://localhost:9200/test/_search?q=content:test"
      register: search_document
      changed_when: false

    - name: 26. Display search result
      ansible.builtin.debug:
        var: search_document.stdout_lines

    - name: 27. Check if document indexing and search is working
      ansible.builtin.fail:
        msg: "Elasticsearch document indexing and search test failed. Search response: {{ search_document.stdout }}"
      when: "'Test Document' not in search_document.stdout"

    - name: 28. Confirm Elasticsearch indexing and search is working
      ansible.builtin.debug:
        msg: "Elasticsearch indexing and search is working correctly"
      when: "'Test Document' in search_document.stdout"

    - name: 29. Clean up test index
      ansible.builtin.command:
        cmd: >
          kubectl exec -n {{ elasticsearch_namespace }} {{ elasticsearch_pod_name.stdout }}
          --kubeconfig {{ merged_kubeconf_file }}
          -- curl -u "{{ elasticsearch_username_fact }}:{{ elasticsearch_password_fact }}" -s -X DELETE
          "http://localhost:9200/test"
      register: delete_index
      changed_when: true

    - name: 30. Display final status
      ansible.builtin.debug:
        msg:
          - "Elasticsearch {{ elasticsearch_version_default }} setup completed successfully."
          - "Elasticsearch is deployed in the '{{ elasticsearch_namespace }}' namespace."
          - "The Elasticsearch service is named '{{ elasticsearch_service_name }}'."
          - "Single-node configuration: Fast startup, simple management, resource efficient."
          - "Use 'kubectl get pods -n {{ elasticsearch_namespace }}' to view the Elasticsearch pods."
          - "Use 'kubectl get svc -n {{ elasticsearch_namespace }}' to view the Elasticsearch service details."
