---
# ansible/playbooks/utility/u10-litellm-create-postgres.yml
#
# Description:
#   This playbook fully automates the creation and deletion of PostgreSQL user and database for LiteLLM inside a Kubernetes cluster.
#   It fetches required credentials from Kubernetes secrets:
#     - The LiteLLM database password is fetched from the 'urbalurba-secrets' secret in the 'ai' namespace.
#     - The PostgreSQL admin password and host are fetched from the 'urbalurba-secrets' secret in the 'default' namespace.
#   It automatically sets up a temporary kubectl port-forward to the PostgreSQL service in the 'default' namespace,
#   waits for the port to be ready, performs all required database operations, and then cleans up the port-forward process.
#
#   No manual port-forwarding or database exposure is required. All operations are performed securely via localhost.
#
# Operations supported:
#   CREATE MODE (default): Sets up LiteLLM database with full permissions
#   DELETE MODE: Completely removes LiteLLM database and user
#
# Usage examples:
#   # Create LiteLLM database and user (default)
#   ansible-playbook /mnt/urbalurbadisk/ansible/playbooks/utility/u10-litellm-create-postgres.yml
#
#   # Create LiteLLM database and user (explicit)
#   ansible-playbook /mnt/urbalurbadisk/ansible/playbooks/utility/u10-litellm-create-postgres.yml -e operation=create
#
#   # Delete LiteLLM database and user
#   ansible-playbook /mnt/urbalurbadisk/ansible/playbooks/utility/u10-litellm-create-postgres.yml -e operation=delete
#
#   # Force delete without confirmation (for automation)
#   ansible-playbook /mnt/urbalurbadisk/ansible/playbooks/utility/u10-litellm-create-postgres.yml -e operation=delete -e force_delete=true
# -----------------------------------------------------------------------------

- hosts: localhost
  gather_facts: false
  vars:
    merged_kubeconf_file: "/mnt/urbalurbadisk/kubeconfig/kubeconf-all"
    # operation variable is passed as parameter, defaults to 'create' if not specified

  tasks:
    - name: 1.1. Set operation default if not provided
      set_fact:
        current_operation: "{{ operation | default('create') }}"

    - name: 1.2. Validate operation parameter
      fail:
        msg: "Invalid operation '{{ current_operation }}'. Must be 'create' or 'delete'"
      when: current_operation not in ['create', 'delete']

    - name: 1.3. Display operation mode
      debug:
        msg: |
          üîß LiteLLM PostgreSQL Management
          üìù Operation: {{ current_operation | upper }}
          {% if current_operation == 'create' %}
          üèóÔ∏è  Mode: Setting up LiteLLM database on shared PostgreSQL instance
          {% else %}
          üóëÔ∏è  Mode: Removing LiteLLM database and user (IRREVERSIBLE!)
          {% endif %}

    - name: 1.4. Get urbalurba-secrets from ai namespace (create mode only)
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: urbalurba-secrets
        namespace: ai
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: ai_secret
      when: current_operation == 'create'
      ignore_errors: yes

    - name: 1.5. Verify LITELLM_POSTGRESQL__PASSWORD exists in ai namespace secret
      fail:
        msg: "‚ùå LITELLM_POSTGRESQL__PASSWORD not found in urbalurba-secrets. Please add it to kubernetes-secrets.yml"
      when:
        - current_operation == 'create'
        - ai_secret.resources | length == 0 or 'LITELLM_POSTGRESQL__PASSWORD' not in (ai_secret.resources[0].data | default({}))

    - name: 1.6. Verify LITELLM_POSTGRESQL__USER exists in ai namespace secret
      fail:
        msg: "‚ùå LITELLM_POSTGRESQL__USER not found in urbalurba-secrets. Please add it to kubernetes-secrets.yml"
      when:
        - current_operation == 'create'
        - ai_secret.resources | length == 0 or 'LITELLM_POSTGRESQL__USER' not in (ai_secret.resources[0].data | default({}))

    - name: 1.7. Get urbalurba-secrets from default namespace
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: urbalurba-secrets
        namespace: default
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: default_secret

    - name: 1.8. Set DB connection variables from secrets
      set_fact:
        pg_user: "{{ ai_secret.resources[0].data.LITELLM_POSTGRESQL__USER | b64decode if current_operation == 'create' else 'litellm' }}"
        pg_password: "{{ ai_secret.resources[0].data.LITELLM_POSTGRESQL__PASSWORD | b64decode if current_operation == 'create' else 'generated' }}"
        pg_db: "litellm"
        pg_host: "{{ default_secret.resources[0].data.PGHOST | b64decode }}"
        pg_admin_user: "postgres"
        pg_admin_password: "{{ default_secret.resources[0].data.PGPASSWORD | b64decode }}"

    - name: 1.9. Display configuration (passwords masked)
      debug:
        msg: |
          üóÑÔ∏è LiteLLM PostgreSQL {{ current_operation | upper }} Operation
          üìä Database: {{ pg_db }}
          üë§ User: {{ pg_user }}
          üè† Host: {{ pg_host }}
          üîê Admin: {{ pg_admin_user }}
          üîë Passwords: [MASKED]

    - name: 1.10. Confirm deletion (delete mode only)
      pause:
        prompt: |
          ‚ö†Ô∏è  DESTRUCTIVE OPERATION WARNING ‚ö†Ô∏è

          You are about to PERMANENTLY DELETE:
          - Database: litellm
          - User: litellm
          - ALL LiteLLM proxy configuration and key data

          This operation is IRREVERSIBLE!

          Type 'yes' to continue, or 'no' to abort
      register: delete_confirmation
      when:
        - current_operation == 'delete'
        - force_delete is not defined or not force_delete

    - name: 1.10-FORCE. Skip confirmation for automated deletion
      set_fact:
        delete_confirmation:
          user_input: 'yes'
      when:
        - current_operation == 'delete'
        - force_delete is defined and force_delete

    - name: 1.11. Abort on deletion refusal
      fail:
        msg: "‚ùå Deletion aborted by user"
      when: current_operation == 'delete' and delete_confirmation.user_input | lower != 'yes'

    - name: 1.12. Start port-forward to PostgreSQL in background
      shell: |
        kubectl port-forward svc/postgresql 5432:5432 -n default > /tmp/pg-portforward.log 2>&1 &
        echo $! > /tmp/pg-portforward.pid
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      async: 10
      poll: 0

    - name: 1.13. Wait for PostgreSQL port-forward to be ready
      wait_for:
        host: localhost
        port: 5432
        delay: 2
        timeout: 30

    # DELETE OPERATION TASKS
    - block:
        - name: 1.14-DEL. Terminate active connections to litellm database
          community.postgresql.postgresql_query:
            login_host: "localhost"
            login_user: "{{ pg_admin_user }}"
            login_password: "{{ pg_admin_password }}"
            port: "{{ pg_port | default(5432) }}"
            db: postgres
            query: |
              SELECT pg_terminate_backend(pid)
              FROM pg_stat_activity
              WHERE datname = '{{ pg_db }}' AND pid <> pg_backend_pid();
          ignore_errors: yes

        - name: 1.15-DEL. Drop litellm database
          community.postgresql.postgresql_db:
            name: "{{ pg_db }}"
            login_host: "localhost"
            login_user: "{{ pg_admin_user }}"
            login_password: "{{ pg_admin_password }}"
            port: "{{ pg_port | default(5432) }}"
            state: absent

        - name: 1.16-DEL. Drop litellm user
          community.postgresql.postgresql_user:
            name: "{{ pg_user }}"
            login_host: "localhost"
            login_user: "{{ pg_admin_user }}"
            login_password: "{{ pg_admin_password }}"
            port: "{{ pg_port | default(5432) }}"
            state: absent

        - name: 1.17-DEL. Display cleanup results
          debug:
            msg: |
              ‚úÖ LiteLLM PostgreSQL cleanup completed!
              üóëÔ∏è Database and user removed successfully

      when: current_operation == 'delete'

    # CREATE OPERATION TASKS
    - block:
        - name: 1.14-CREATE. Ensure PostgreSQL user exists
          community.postgresql.postgresql_user:
            name: "{{ pg_user }}"
            password: "{{ pg_password }}"
            login_host: "localhost"
            login_user: "{{ pg_admin_user }}"
            login_password: "{{ pg_admin_password }}"
            port: "{{ pg_port | default(5432) }}"
            role_attr_flags: LOGIN
            state: present

        - name: 1.15-CREATE. Ensure PostgreSQL database exists
          community.postgresql.postgresql_db:
            name: "{{ pg_db }}"
            owner: "{{ pg_user }}"
            login_host: "localhost"
            login_user: "{{ pg_admin_user }}"
            login_password: "{{ pg_admin_password }}"
            port: "{{ pg_port | default(5432) }}"
            state: present

        - name: 1.16-CREATE. Grant all database privileges to user
          community.postgresql.postgresql_privs:
            db: "{{ pg_db }}"
            type: database
            privs: ALL
            objs: "{{ pg_db }}"
            roles: "{{ pg_user }}"
            login_host: "localhost"
            login_user: "{{ pg_admin_user }}"
            login_password: "{{ pg_admin_password }}"
            port: "{{ pg_port | default(5432) }}"

        - name: 1.17-CREATE. Grant all schema privileges to user
          community.postgresql.postgresql_privs:
            db: "{{ pg_db }}"
            type: schema
            objs: public
            privs: ALL
            roles: "{{ pg_user }}"
            login_host: "localhost"
            login_user: "{{ pg_admin_user }}"
            login_password: "{{ pg_admin_password }}"
            port: "{{ pg_port | default(5432) }}"

        - name: 1.18-CREATE. Test connection with LiteLLM user
          community.postgresql.postgresql_query:
            db: "{{ pg_db }}"
            login_host: "localhost"
            login_user: "{{ pg_user }}"
            login_password: "{{ pg_password }}"
            port: "{{ pg_port | default(5432) }}"
            query: "SELECT current_database(), current_user, version()"
          register: connection_test

        - name: 1.19-CREATE. Display connection test results
          debug:
            msg: |
              ‚úÖ LiteLLM PostgreSQL setup completed successfully!
              üìä Database: {{ connection_test.query_result[0].current_database }}
              üë§ User: {{ connection_test.query_result[0].current_user }}


      when: current_operation == 'create'

    - name: 1.98. Stop port-forward process
      shell: |
        kill $(cat /tmp/pg-portforward.pid) || true
        rm -f /tmp/pg-portforward.pid
      ignore_errors: yes

    - name: 1.99. Display final summary
      debug:
        msg: |
          {% if current_operation == 'create' %}
          üéâ LiteLLM database ready on shared PostgreSQL!
          üìù Connection: postgresql://{{ pg_user }}:PASSWORD@postgresql.default.svc.cluster.local:5432/{{ pg_db }}
          üîë Credentials: Using values from kubernetes-secrets.yml (urbalurba-secrets in ai namespace)
          {% else %}
          üóëÔ∏è LiteLLM database cleanup completed!
          {% endif %}