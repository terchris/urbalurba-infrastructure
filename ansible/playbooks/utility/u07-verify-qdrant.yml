---
# File: ansible/playbooks/utility/u07-verify-qdrant.yml
# Description: Test connection to Qdrant vector database and verify functionality.
# This playbook:
# - Verifies connection and authentication
# - Tests collection creation, vector insertion, and search
# - Tests data persistence and cleanup
# Usage:
# ansible-playbook playbooks/utility/u07-verify-qdrant.yml

- name: Verify Qdrant Vector Database
  hosts: localhost
  gather_facts: false
  vars:
    merged_kubeconf_file: "/mnt/urbalurbadisk/kubeconfig/kubeconf-all"
    qdrant_namespace: "default"
    test_collection_name: "verification_test_collection"

  tasks:
    - name: 1. Verify Qdrant secret values
      kubernetes.core.k8s_info:
        kind: Secret
        name: urbalurba-secrets
        namespace: "{{ qdrant_namespace }}"
        kubeconfig: "{{ merged_kubeconf_file }}"
      register: secret_info

    - name: 2. Fail if Qdrant secrets are not set correctly
      ansible.builtin.fail:
        msg: "Qdrant API key is not set correctly in urbalurba-secrets"
      when: >
        secret_info.resources | length == 0 or
        secret_info.resources[0].data.QDRANT_API_KEY is not defined

    - name: 3. Set Qdrant API key
      ansible.builtin.set_fact:
        qdrant_api_key: "{{ secret_info.resources[0].data.QDRANT_API_KEY | b64decode }}"

    - name: 4. Get Qdrant pod name
      kubernetes.core.k8s_info:
        kubeconfig: "{{ merged_kubeconf_file }}"
        kind: Pod
        namespace: "{{ qdrant_namespace }}"
        label_selectors:
          - app.kubernetes.io/name=qdrant
      register: qdrant_pods
      retries: 30
      delay: 10
      until: qdrant_pods.resources | length > 0

    - name: 5. Fail if no Qdrant pod found
      ansible.builtin.fail:
        msg: "No Qdrant pod found after multiple attempts"
      when: qdrant_pods.resources | length == 0

    - name: 6. Set Qdrant pod name
      ansible.builtin.set_fact:
        qdrant_pod_name: "{{ qdrant_pods.resources[0].metadata.name }}"

    - name: 7. Wait for Qdrant to be ready - check API health
      ansible.builtin.shell: |
        kubectl run curl-test-verify --image=curlimages/curl --rm -i --restart=Never -n {{ qdrant_namespace }} -- \
        curl -s -w "HTTP_CODE:%{http_code}" http://qdrant:6333/health
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: qdrant_health
      until: qdrant_health.rc == 0 and qdrant_health.stdout.find('HTTP_CODE:200') != -1
      retries: 30
      delay: 10

    - name: 8. Clean up any existing test collection
      ansible.builtin.shell: |
        kubectl run curl-test-cleanup --image=curlimages/curl --rm -i --restart=Never -n {{ qdrant_namespace }} -- \
        curl -s -X DELETE -H "api-key: {{ qdrant_api_key }}" \
        http://qdrant:6333/collections/{{ test_collection_name }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: cleanup_result
      failed_when: false  # Don't fail if collection doesn't exist

    - name: 9. Test Qdrant API - List collections (should be empty initially)
      ansible.builtin.shell: |
        kubectl run curl-test-list --image=curlimages/curl --rm -i --restart=Never -n {{ qdrant_namespace }} -- \
        curl -s -w "HTTP_CODE:%{http_code}" -H "api-key: {{ qdrant_api_key }}" \
        http://qdrant:6333/collections
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: list_collections_result
      retries: 3
      delay: 5
      until: list_collections_result.rc == 0 and list_collections_result.stdout.find('HTTP_CODE:200') != -1

    - name: 10. Display initial collections list
      ansible.builtin.debug:
        msg: "Initial collections response: {{ list_collections_result.stdout }}"

    - name: 11. Create test collection
      ansible.builtin.shell: |
        kubectl run curl-test-create --image=curlimages/curl --rm -i --restart=Never -n {{ qdrant_namespace }} -- \
        curl -s -X PUT -w "HTTP_CODE:%{http_code}" -H "api-key: {{ qdrant_api_key }}" \
        -H "Content-Type: application/json" \
        --data '{"vectors": {"size": 4, "distance": "Cosine"}}' \
        http://qdrant:6333/collections/{{ test_collection_name }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: create_collection_result

    - name: 12. Display collection creation result
      ansible.builtin.debug:
        var: create_collection_result.stdout

    - name: 13. Verify collection creation was successful
      ansible.builtin.fail:
        msg: "Failed to create test collection"
      when: create_collection_result.stdout.find('HTTP_CODE:200') == -1 and create_collection_result.stdout.find('"result":true') == -1

    - name: 14. Insert test vector data
      ansible.builtin.shell: |
        kubectl run curl-test-insert --image=curlimages/curl --rm -i --restart=Never -n {{ qdrant_namespace }} -- \
        curl -s -X PUT -w "HTTP_CODE:%{http_code}" -H "api-key: {{ qdrant_api_key }}" \
        -H "Content-Type: application/json" \
        --data '{"points": [{"id": 1, "vector": [0.1, 0.2, 0.3, 0.4], "payload": {"text": "test document", "category": "verification"}}]}' \
        http://qdrant:6333/collections/{{ test_collection_name }}/points
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: insert_result

    - name: 15. Display vector insertion result
      ansible.builtin.debug:
        var: insert_result.stdout

    - name: 16. Verify vector insertion was successful
      ansible.builtin.fail:
        msg: "Failed to insert test vector data"
      when: insert_result.stdout.find('HTTP_CODE:200') == -1 and insert_result.stdout.find('"status":"acknowledged"') == -1

    - name: 17. Retrieve inserted point by ID
      ansible.builtin.shell: |
        kubectl run curl-test-get --image=curlimages/curl --rm -i --restart=Never -n {{ qdrant_namespace }} -- \
        curl -s -w "HTTP_CODE:%{http_code}" -H "api-key: {{ qdrant_api_key }}" \
        http://qdrant:6333/collections/{{ test_collection_name }}/points/1
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: retrieve_result

    - name: 18. Display retrieved data
      ansible.builtin.debug:
        var: retrieve_result.stdout

    - name: 19. Verify retrieved data contains expected payload
      ansible.builtin.fail:
        msg: "Failed to retrieve expected test data"
      when: retrieve_result.stdout.find('test document') == -1 or retrieve_result.stdout.find('verification') == -1

    - name: 20. Test vector search functionality
      ansible.builtin.shell: |
        kubectl run curl-test-search --image=curlimages/curl --rm -i --restart=Never -n {{ qdrant_namespace }} -- \
        curl -s -X POST -w "HTTP_CODE:%{http_code}" -H "api-key: {{ qdrant_api_key }}" \
        -H "Content-Type: application/json" \
        --data '{"vector": [0.1, 0.2, 0.3, 0.4], "limit": 5, "with_payload": true}' \
        http://qdrant:6333/collections/{{ test_collection_name }}/points/search
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: search_result

    - name: 21. Display search result
      ansible.builtin.debug:
        var: search_result.stdout

    - name: 22. Verify search found the test vector
      ansible.builtin.fail:
        msg: "Vector search failed to find the test data"
      when: search_result.stdout.find('"id":1') == -1 or search_result.stdout.find('"score":1') == -1

    - name: 23. Test collection listing (should now contain our test collection)
      ansible.builtin.shell: |
        kubectl run curl-test-list-final --image=curlimages/curl --rm -i --restart=Never -n {{ qdrant_namespace }} -- \
        curl -s -w "HTTP_CODE:%{http_code}" -H "api-key: {{ qdrant_api_key }}" \
        http://qdrant:6333/collections
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: final_list_result

    - name: 24. Display final collections list
      ansible.builtin.debug:
        var: final_list_result.stdout

    - name: 25. Verify our test collection is listed
      ansible.builtin.fail:
        msg: "Test collection not found in collections list"
      when: final_list_result.stdout.find(test_collection_name) == -1

    - name: 26. Clean up test collection
      ansible.builtin.shell: |
        kubectl run curl-test-delete --image=curlimages/curl --rm -i --restart=Never -n {{ qdrant_namespace }} -- \
        curl -s -X DELETE -w "HTTP_CODE:%{http_code}" -H "api-key: {{ qdrant_api_key }}" \
        http://qdrant:6333/collections/{{ test_collection_name }}
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: delete_result

    - name: 27. Display deletion result
      ansible.builtin.debug:
        var: delete_result.stdout

    - name: 28. Verify cleanup was successful
      ansible.builtin.shell: |
        kubectl run curl-test-verify-cleanup --image=curlimages/curl --rm -i --restart=Never -n {{ qdrant_namespace }} -- \
        curl -s -w "HTTP_CODE:%{http_code}" -H "api-key: {{ qdrant_api_key }}" \
        http://qdrant:6333/collections
      environment:
        KUBECONFIG: "{{ merged_kubeconf_file }}"
      register: cleanup_verify_result

    - name: 29. Verify collections list is empty again
      ansible.builtin.fail:
        msg: "Test collection was not properly deleted"
      when: cleanup_verify_result.stdout.find(test_collection_name) != -1

    - name: 30. Confirm Qdrant is working correctly
      ansible.builtin.debug:
        msg: |
          âœ… Qdrant Vector Database verification successful!

          ðŸ”„ Tests completed:
          â€¢ API connectivity and authentication âœ…
          â€¢ Collection creation and management âœ…
          â€¢ Vector data insertion and persistence âœ…
          â€¢ Point retrieval by ID âœ…
          â€¢ Vector similarity search functionality âœ…
          â€¢ Data cleanup and collection deletion âœ…

          ðŸŽ¯ Qdrant is ready for AI/ML workloads and vector search applications!